{% extends "base.html" %}
{% block title %}{{ student.name }} - Student Profile{% endblock %}
{% block page_title %}Student Profile{% endblock %}
{% block content %}

<div class="bg-white shadow-sm border border-gray-100 rounded-xl p-6">

  <!-- Header -->
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
    <div>
      <h3 class="text-xl font-semibold text-gray-800">{{ student.name }}</h3>
      <p class="text-sm text-gray-500">Admission No: {{ student.admission_no or '—' }}</p>
      <p class="text-sm text-gray-500">Class: {{ student.class_name or '—' }}</p>
      {% if student.phone %}
      <p class="text-sm text-gray-500">Phone: {{ student.phone }}</p>
      {% endif %}
    </div>

    <div class="text-right space-y-2">
      <!-- Current Balance -->
      <div>
        <p class="text-sm text-gray-600">Current Balance:</p>
        <p class="text-2xl font-semibold text-red-600">
          KES {{ "{:,.2f}".format(student.balance or student.fee_balance or 0) }}
        </p>
      </div>

      <!-- Credit Balance -->
      <div>
        <p class="text-sm text-gray-600">Credit Balance:</p>
        {% if student.credit and student.credit > 0 %}
          <p class="text-2xl font-semibold text-green-600">
            +KES {{ "{:,.2f}".format(student.credit) }}
          </p>
        {% else %}
          <p class="text-2xl font-semibold text-gray-400">KES 0.00</p>
        {% endif %}
      </div>

      <!-- ✅ Updated Add Payment link -->
      <a href="{{ url_for('payments', student_id=student.id) }}" 
         class="mt-3 inline-block px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition">
        + Add Payment
      </a>
      <a href="{{ student_portal_link(student.id) }}" target="_blank"
         class="mt-2 inline-block px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-medium rounded-lg transition">
        Open Student Portal
      </a>
      <form method="post" action="{{ url_for('student_portal.rotate_student', student_id=student.id) }}">
        <button class="mt-2 inline-flex items-center gap-2 px-4 py-2 bg-rose-50 hover:bg-rose-100 text-rose-700 text-sm font-medium rounded-lg transition border border-rose-200" type="submit">
          Invalidate Portal Link
        </button>
      </form>
    </div>
  </div>

  <!-- Payment History -->
  <div class="overflow-x-auto mt-8">
    <h4 class="text-lg font-medium text-gray-800 mb-3 flex items-center gap-2">
      <i data-lucide="receipt"></i> Payment History
    </h4>

    <table class="min-w-full border border-gray-200 text-sm">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-4 py-2 text-left font-medium text-gray-700 border-b">#</th>
          <th class="px-4 py-2 text-left font-medium text-gray-700 border-b">Amount (KES)</th>
          <th class="px-4 py-2 text-left font-medium text-gray-700 border-b">Method</th>
          <th class="px-4 py-2 text-left font-medium text-gray-700 border-b">Reference</th>
          <th class="px-4 py-2 text-left font-medium text-gray-700 border-b">Date</th>
        </tr>
      </thead>
      <tbody>
        {% for payment in payments %}
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-2 border-b">{{ loop.index }}</td>
          <td class="px-4 py-2 border-b text-green-600 font-medium">{{ "{:,.2f}".format(payment.amount or 0) }}</td>
          <td class="px-4 py-2 border-b">{{ payment.method or '—' }}</td>
          <td class="px-4 py-2 border-b">{{ payment.reference or '—' }}</td>
          <td class="px-4 py-2 border-b">
            {% if payment.date %}
              {% if payment.date.__class__.__name__ == 'str' %}
                {{ payment.date }}
              {% else %}
                {{ payment.date.strftime('%Y-%m-%d %H:%M') }}
              {% endif %}
            {% else %}
              —
            {% endif %}
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="5" class="text-center text-gray-500 py-4">No payments found for this student.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Back Button -->
  <div class="mt-6">
    <a href="{{ url_for('students') }}" 
       class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm font-medium rounded-lg transition inline-flex items-center gap-2">
      <i data-lucide="arrow-left"></i> Back to Students
    </a>
  </div>

  <!-- Quick QR for profile access / printing -->
  <div class="mt-8 bg-white border border-gray-100 rounded-xl p-4">
    <div class="flex items-center justify-between">
      <div>
        <div class="text-sm text-gray-600">Scan to open this student profile</div>
        <div class="text-xs text-gray-500">Share with guardians for quick access</div>
      </div>
      <div class="p-2 rounded-lg border border-gray-200 bg-gray-50">
        <div id="studentQR" style="width:160px;height:160px"></div>
      </div>
    </div>
    <div class="mt-3 text-right">
      <button onclick="window.print()" class="inline-flex items-center gap-1 px-3 py-1.5 text-sm rounded-lg border bg-white hover:bg-gray-50">
        Print
      </button>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  lucide.createIcons();
  try {
    const url = window.location.origin + "{{ url_for('student_detail', student_id=student.id) }}";
    const s = document.createElement('script');
    s.src = 'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js';
    s.onload = () => { new QRCode(document.getElementById('studentQR'), { text: url, width: 160, height: 160 }); };
    document.body.appendChild(s);
  } catch (e) {}
});
</script>

{% endblock %}
