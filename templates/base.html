<!DOCTYPE html>
<html lang="en">
<head>
        
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% block title %}{{ APP_TITLE }}{% endblock %}</title>
  <meta name="theme-color" content="{{ BRAND_COLOR or '#2563eb' }}" />
  <link rel="manifest" href="/static/manifest.webmanifest" />

  

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  
  <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}" />

  <!-- App Icon / Favicon -->
  <link rel="icon" href="{{ url_for('static', filename=FAVICON) }}" type="image/svg+xml">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename=FAVICON) }}">
</head>

<body class="flex h-screen overflow-hidden no-anim" data-plan="PRO">
  <a href="#main" class="sr-only focus:not-sr-only focus:fixed focus:top-2 focus:left-2 focus:z-50 focus:px-3 focus:py-2 focus:rounded-lg focus:bg-white focus:border focus:border-gray-200 focus:shadow">Skip to content</a>

  <section class="top-banner" aria-label="Institutional banner"
    style="background: linear-gradient(180deg, {{ BRAND_COLOR or '#0f60d1' }} 0%, #0b3c94 60%, #060f36 100%); border-bottom-color: {{ BRAND_COLOR or '#0f60d1' }};">
    <div class="top-banner__inner">
      <div class="top-banner__stitial">
        <div class="top-banner__crest">
          <img src="{{ url_for('static', filename=LOGO_PRIMARY) }}" alt="Lovato_Tech" />
        </div>
        <div class="top-banner__school">
          <div class="top-banner__brand">{{ BRAND_NAME or 'Lovato_Tech' }}</div>
          <div class="top-banner__caption">
            <span>{{ SCHOOL_NAME or 'SmartEduPay Portal' }}</span>
            <span class="dot-separator">•</span>
            <span>School: {{ SCHOOL_NAME or BRAND_NAME or 'Lovato_Tech' }}</span>
          </div>
        </div>
      </div>
      <div class="top-banner__hero">
        <p class="top-banner__title">SmartEduPay</p>
        <p class="top-banner__tagline">Fostering Equity in Access to Education | Powered by SmartEduPay and Lovato_Tech</p>
      </div>
      <div class="top-banner__meta">
        <div class="top-banner__cta">
          <span class="top-banner__pill">Premium</span>
          <span>Term {{ CURRENT_TERM or 'N/A' }} · {{ CURRENT_YEAR or 'Year' }}</span>
        </div>
        <div class="top-banner__pill top-banner__pill--mini">Live</div>
      </div>
    </div>
  </section>

  <!-- Sidebar -->
  <aside class="sidebar w-64 flex flex-col border-r border-gray-200">
    <div class="p-4 border-b border-gray-100 flex items-center justify-between">
      <div class="leading-tight select-none text-xs text-gray-500">
        <span class="hidden md:inline">SmartEduPay Portal</span>
      </div>
      <button id="toggleSidebar" class="md:hidden p-1 text-gray-600 hover:text-blue-600">
        <i data-lucide="menu"></i>
      </button>
    </div>

    <nav class="flex-1 px-4 py-6 space-y-4 overflow-y-auto">
      <div class="nav-section">
        <p class="nav-section__label">Core</p>
        <a href="{{ url_for('dashboard') }}" class="nav-link {% if request.path == '/' %}active-link{% endif %}">
          <i data-lucide="home"></i>
          <span>Dashboard</span>
        </a>
        <a href="{{ url_for('students') }}" class="nav-link {% if '/students' in request.path %}active-link{% endif %}">
          <i data-lucide="users"></i>
          <span>Students</span>
        </a>
        <a href="{{ url_for('payments') }}" class="nav-link {% if '/payments' in request.path %}active-link{% endif %}">
          <i data-lucide="dollar-sign"></i>
          <span>Add Payment</span>
        </a>
        <a href="{{ url_for('ai.ai_home') }}" class="nav-link {% if '/ai' in request.path %}active-link{% endif %}">
          <i data-lucide="bot"></i>
          <span>AI Assistant</span>
        </a>
      </div>

      <div class="nav-section">
        <p class="nav-section__label">Operations</p>
        <a href="{{ url_for('credit.credit_home') }}" class="nav-link {% if '/credit' in request.path %}active-link{% endif %}">
          <i data-lucide="coins"></i>
          <span>Credit Ops</span>
        </a>
        <a href="{{ url_for('terms.manage_terms') }}" class="nav-link {% if '/terms' in request.path %}active-link{% endif %}">
          <i data-lucide="calendar"></i>
          <span>Terms</span>
        </a>
        <a href="{{ url_for('terms.invoices_list') }}" class="nav-link {% if '/terms/invoices' in request.path %}active-link{% endif %}">
          <i data-lucide="receipt"></i>
          <span>Invoices</span>
        </a>
        <a href="{{ url_for('reminders.reminders_home') }}" class="nav-link {% if '/reminders' in request.path %}active-link{% endif %}">
          <i data-lucide="bell"></i>
          <span>Reminders</span>
        </a>
        <a href="{{ url_for('analytics_dashboard') }}" class="nav-link {% if '/analytics' in request.path %}active-link{% endif %}">
          <i data-lucide="activity"></i>
          <span>Analytics</span>
        </a>
      </div>

      <div class="nav-section">
        <p class="nav-section__label">Engagement</p>
        <a href="{{ url_for('newsletters.index') }}" class="nav-link {% if '/newsletters' in request.path %}active-link{% endif %}">
          <i data-lucide="megaphone"></i>
          <span>Newsletters</span>
        </a>
        <a href="{{ url_for('recovery.dashboard') }}" class="nav-link {% if '/recovery' in request.path %}active-link{% endif %}">
          <i data-lucide="phone-call"></i>
          <span>Recovery</span>
        </a>
        <a href="{{ url_for('docs') }}" class="nav-link {% if '/docs' in request.path %}active-link{% endif %}">
          <i data-lucide="book-open"></i>
          <span>Documentation</span>
        </a>
      </div>

      <div class="nav-section">
        <p class="nav-section__label">Admin</p>
        <a href="{{ url_for('admin.school_profile') }}" class="nav-link {% if '/admin/school' in request.path %}active-link{% endif %}">
          <i data-lucide="building-2"></i>
          <span>School Profile</span>
        </a>
        <a href="{{ url_for('admin.access_settings') }}" class="nav-link {% if ('/admin/settings' in request.path) or ('/admin/security' in request.path) %}active-link{% endif %}">
          <i data-lucide="shield"></i>
          <span>Access &amp; Security</span>
        </a>
        <a href="{{ url_for('admin.audit_logs') }}" class="nav-link {% if '/admin/audit' in request.path %}active-link{% endif %}">
          <i data-lucide="list-check"></i>
          <span>Audit Logs</span>
        </a>
      </div>
    </nav>


    <div class="p-4 border-t border-gray-100 text-center text-gray-500 text-xs">
      <p>© 2025 <span class="font-semibold text-blue-600">Fee_Management_System</span></p>
      <p class="mt-1">Powered by Flask</p>
    </div>
  </aside>

  <!-- Main Content -->
  <main id="main" class="flex-1 flex flex-col overflow-y-auto">
    {% set flashed_messages = get_flashed_messages(with_categories=true) %}
    <div id="flash-container" class="space-y-2 mb-4" role="status" aria-live="polite" aria-atomic="true">
      {% if flashed_messages %}
        {% set flash_variants = {
          'success': 'flash-success text-green-900',
          'error': 'flash-error text-rose-900',
          'warning': 'flash-warning text-amber-900',
          'info': 'flash-info text-sky-900'
        } %}
        {% for category, message in flashed_messages %}
          {% set variant = flash_variants.get(category, flash_variants['info']) %}
          <div class="flash-item border rounded-lg px-4 py-3 shadow-sm flex items-start gap-2 {{ variant }}">
            <span class="mt-0.5">
              {% if category == 'success' %}<i data-lucide="check-circle" class="w-4 h-4"></i>{% endif %}
              {% if category == 'error' %}<i data-lucide="alert-octagon" class="w-4 h-4"></i>{% endif %}
              {% if category == 'warning' %}<i data-lucide="alert-triangle" class="w-4 h-4"></i>{% endif %}
              {% if category == 'info' %}<i data-lucide="info" class="w-4 h-4"></i>{% endif %}
            </span>
            <div class="flex-1 text-sm flash-text">{{ message }}</div>
            <button type="button" class="dismiss p-1 -m-1 text-gray-400 hover:text-gray-600" aria-label="Dismiss">
              <i data-lucide="x" class="w-4 h-4"></i>
            </button>
          </div>
        {% endfor %}
      {% endif %}
    </div>

    <!-- Header -->
    <header class="sticky top-0 z-20 border-b border-gray-200 px-8 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <a href="{{ url_for('students') }}" data-back class="hidden md:inline-flex items-center gap-1 text-gray-600 hover:text-indigo-700 px-2 py-1 rounded-lg border border-gray-200 hover:border-indigo-300" title="Back" role="button">
          <i data-lucide="arrow-left"></i>
          <span class="text-sm">Back</span>
        </a>
        <img src="{{ url_for('static', filename=LOGO_SECONDARY) }}" alt="{{ BRAND_NAME }}" class="h-7 w-7 rounded-sm ring-1 ring-blue-100/60 shadow-sm"/>
        <h2 class="text-lg font-semibold text-gray-800 tracking-tight">
          {% block page_title %}{% endblock %}
        </h2>
      </div>

      <div class="flex items-center gap-3">
        <button id="globalSearchBtn" class="hidden md:inline-flex items-center gap-2 text-xs px-3 py-1.5 rounded-full border border-gray-200 bg-white text-gray-700 hover:bg-gray-50" title="Search (Ctrl+K)">
          <i data-lucide="search"></i>
          <span>Search</span>
          <kbd class="ml-1 text-[10px] px-1 py-0.5 rounded border bg-gray-50">Ctrl+K</kbd>
        </button>
        <span id="currentTermChip" class="hidden md:inline-flex items-center gap-2 text-xs px-3 py-1.5 rounded-full border border-indigo-200 bg-indigo-50 text-indigo-700">
          <i data-lucide="calendar"></i>
          <span id="currentTermText">{{ CURRENT_YEAR or '—' }} • Term {{ CURRENT_TERM or '—' }}</span>
        </span>
        
        <a href="{{ url_for('reminders.reminders_home') }}" class="nav-button p-2 rounded-full hover:bg-gray-100 transition" title="Reminders">
          <i data-lucide="bell"></i>
        </a>
        
        <a href="{{ url_for('auth.logout') }}" class="nav-button p-2 rounded-full hover:bg-gray-100 transition" title="Sign out">
          <i data-lucide="log-out"></i>
        </a>
      </div>
    </header>

    <!-- Content Area -->
    <section class="p-8 flex-1">
      {% block content %}{% endblock %}
    </section>

    <!-- Global Footer -->
    <footer class="app-footer">
      <div class="max-w-7xl mx-auto px-8 py-6 flex flex-col md:flex-row items-center justify-between gap-4">
        <div class="flex items-center gap-3 text-sm text-gray-600">
          <span class="inline-flex items-center gap-2 signature-badge px-3 py-1.5 rounded-xl">
            <i data-lucide="sparkles" class="w-4 h-4 text-indigo-600"></i>
            <span class="tracking-wide">Crafted with passion by</span>
            <span class="font-extrabold tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 via-cyan-500 to-emerald-500">AKILLIUS VINCENT</span>
          </span>
        </div>
        <div class="text-xs text-gray-600">
          <span class="mr-2">© {{ (now.year if now is defined else 2025) }}</span>
          
        </div>
      </div>
      <div class="px-8 pb-6 text-center text-xs text-gray-600">© 2025 Fee_Management_System</div>
    </footer>
  </main>

  <!-- Global Search Modal -->
  <div id="searchModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/30" onclick="hideSearch()"></div>
    <div class="absolute left-1/2 -translate-x-1/2 top-20 w-full max-w-2xl bg-white border border-gray-200 rounded-2xl shadow-2xl overflow-hidden">
      <div class="flex items-center gap-2 px-4 py-3 border-b bg-gray-50">
        <i data-lucide="search" class="text-gray-500"></i>
        <input id="searchInput" type="text" placeholder="Search students, payments…" class="flex-1 outline-none bg-transparent text-sm" />
        <button onclick="hideSearch()" class="text-gray-400 hover:text-gray-700"><i data-lucide="x"></i></button>
      </div>
      <div id="searchResults" class="max-h-96 overflow-y-auto divide-y"></div>
    </div>
  </div>

  <script>
    // Initialize icons
    lucide.createIcons();

    // --- Auto-fit helper for KPI values ---
    // Shrinks font-size of elements with .fit-text so content never overflows.
    (function(){
      function fitOne(el){
        if (!el) return;
        const isWrap = el.classList.contains('fit-wrap');
        // Reset to computed size first so we can shrink predictably
        el.style.fontSize = '';
        const style = getComputedStyle(el);
        const max = parseFloat(style.fontSize) || 30; // starting size from CSS/tailwind
        // Keep a higher floor so amounts never look too small
        const min = 16; // px minimum to maintain medium readability
        let size = max;
        // Ensure the element has a width basis
        el.style.maxWidth = '100%';
        el.style.whiteSpace = isWrap ? 'normal' : 'nowrap';
        // For wrapped fit-text, we don't shrink; CSS handles clamping elegantly
        if (isWrap) {
          el.style.overflow = 'hidden';
          el.style.textOverflow = 'ellipsis';
          return;
        }
        let guard = 0;
        // Shrink until it fits its own box
        while (el.scrollWidth > el.clientWidth && size > min && guard < 60){
          size -= 1;
          el.style.fontSize = size + 'px';
          guard++;
        }
        // Ensure no ellipsis clipping after fitting
        el.style.overflow = 'visible';
        el.style.textOverflow = 'clip';
      }
      function fitAll(){
        document.querySelectorAll('.fit-text').forEach(fitOne);
      }
      window.fitKpis = fitAll;
      // Run on load and on resize
      window.addEventListener('load', fitAll);
      window.addEventListener('resize', () => { clearTimeout(window.__fitT); window.__fitT = setTimeout(fitAll, 80); });
      // Observe KPI containers for content changes
      try {
        const mo = new MutationObserver(() => { clearTimeout(window.__fitM); window.__fitM = setTimeout(fitAll, 40); });
        mo.observe(document.body, { subtree: true, characterData: true, childList: true });
      } catch(_) {}
    })();

    // Sidebar Toggle (Mobile)
    const sidebar = document.querySelector('.sidebar');
    const toggleBtn = document.getElementById('toggleSidebar');
    if (toggleBtn) {
      toggleBtn.addEventListener('click', () => {
        sidebar.classList.toggle('hidden');
      });
    }

    // Example modal trigger placeholder
    function openAddPaymentModal() {
      window.location.href = "{{ url_for('payments') }}";
    }

    // Robust Back button handler
    function neoBack() {
      try {
        if (window.history && window.history.length > 1) {
          window.history.back();
          return;
        }
        const ref = document.referrer || '';
        if (ref && new URL(ref, window.location.origin).origin === window.location.origin) {
          window.location.href = ref;
          return;
        }
      } catch (e) {}
      // Fallback to Students list, else Dashboard
      try { window.location.href = "{{ url_for('dashboard') }}"; } catch(e) { window.location.href = "{{ url_for('students') }}"; }
    }

    // Flash close + auto-dismiss (supports future flash injections)
    (function() {
      const container = document.getElementById('flash-container');
      const AUTO_DISMISS_MS = 15000;

      const cancelAutoDismiss = (item) => {
        if (!item) return;
        const current = item.dataset.flashTimerId;
        if (current) {
          clearTimeout(Number(current));
          delete item.dataset.flashTimerId;
        }
      };

      const animateRemoval = (item) => {
        if (!item) return;
        cancelAutoDismiss(item);
        item.style.transition = 'opacity .25s ease, transform .25s ease';
        void item.offsetHeight;
        item.style.opacity = '0';
        item.style.transform = 'translateY(-4px)';
        setTimeout(() => item.remove(), 260);
      };

      const scheduleAutoDismiss = (item) => {
        if (!item || item.dataset.flashTimerId) return;
        const timer = setTimeout(() => animateRemoval(item), AUTO_DISMISS_MS);
        item.dataset.flashTimerId = timer.toString();
      };

      const handleDismiss = (btn) => {
        if (!btn) return;
        const item = btn.closest('.flash-item');
        if (!item) return;
        animateRemoval(item);
      };

      if (container) {
        try {
          container.classList.add('fixed','top-3','left-1/2','-translate-x-1/2','w-full','max-w-2xl','z-50','px-4');
          container.classList.remove('mb-4');
        } catch (e) {}
        const initFlashItems = () => {
          container.querySelectorAll('.flash-item').forEach(scheduleAutoDismiss);
        };
        initFlashItems();
        const observer = new MutationObserver(initFlashItems);
        observer.observe(container, { childList: true, subtree: true });
        lucide.createIcons();
      }

      document.addEventListener('click', (event) => {
        const target = event.target;
        if (!(target instanceof Element)) return;
        const btn = target.closest('.dismiss');
        if (!btn) return;
        event.preventDefault();
        handleDismiss(btn);
      });

      document.addEventListener('keydown', (event) => {
        if (event.key !== 'Enter' && event.key !== ' ') return;
        const target = event.target;
        if (!(target instanceof Element)) return;
        const btn = target.closest('.dismiss');
        if (!btn) return;
        event.preventDefault();
        handleDismiss(btn);
      });
    })();

    // Replace stray bullet mojibake with a clean separator
    (function() {
      try {
        const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT);
        const replacePairs = [
          ['â€¢', ', '],
          ['???', ', '],
          ['•', ', ']
        ];
        let node;
        while ((node = walker.nextNode())) {
          let text = node.nodeValue;
          let newText = text;
          for (const [from, to] of replacePairs) {
            if (newText.includes(from)) newText = newText.split(from).join(to);
          }
          if (newText !== text) node.nodeValue = newText;
        }
      } catch (e) { /* noop */ }
    })();

    // Live refresh for current term badge
    (function() {
      const chip = document.getElementById('currentTermChip');
      const text = document.getElementById('currentTermText');
      if (!chip || !text) return;
      function tick() {
        fetch('/terms/current')
          .then(r => r.ok ? r.json() : null)
          .then(d => {
            if (!d) return;
            text.textContent = `${d.year} • Term ${d.term}`;
            // Normalize any stray control characters to a readable separator
            try { text.textContent = (text.textContent || '').replace(/[\u0000-\u001F]+/g, ' - '); } catch (_) {}
            chip.style.display = 'inline-flex';
            try { lucide.createIcons(); } catch (_) {}
          })
          .catch(() => {});
      }
      setInterval(tick, 10000);
    })();

    // Additional cleanup for mojibake in flash messages and current term chip
    (function(){
      try {
        const container = document.getElementById('flash-container');
        if (container) {
          container.querySelectorAll('.flash-item').forEach(item => {
            item.childNodes.forEach(n => {
              if (n.nodeType === Node.TEXT_NODE) {
                n.nodeValue = n.nodeValue.replace(/^?o\.\s*/, '');
              }
            });
          });
        }
      } catch(e){}
      try {
        const text = document.getElementById('currentTermText');
        if (text) {
          const fix = ()=>{ text.textContent = (text.textContent||'').replace(/\s*[^0-9]+\s*Term/, ' — Term'); };
          fix();
          setInterval(fix, 3000);
        }
      } catch(e){}
    })();

    // ----- Global Search -----
    const searchBtn = document.getElementById('globalSearchBtn');
    const modal = document.getElementById('searchModal');
    const input = document.getElementById('searchInput');
    const results = document.getElementById('searchResults');
    function showSearch() { if (!modal) return; modal.classList.remove('hidden'); setTimeout(() => input && input.focus(), 10); }
    function hideSearch() { if (!modal) return; modal.classList.add('hidden'); if (input) input.value=''; if (results) results.innerHTML=''; }
    window.hideSearch = hideSearch;
    if (searchBtn) searchBtn.addEventListener('click', showSearch);
    document.addEventListener('keydown', (e) => {
      const isMac = navigator.platform.toUpperCase().indexOf('MAC')>=0;
      if ((isMac ? e.metaKey : e.ctrlKey) && e.key.toLowerCase()==='k') { e.preventDefault(); showSearch(); }
      if (e.key === '/' && !(e.target instanceof HTMLInputElement || e.target instanceof HTMLTextAreaElement)) { e.preventDefault(); showSearch(); }
      if (e.key === 'Escape') hideSearch();
    });
    let searchTimer;
    const balanceClassName = (value) => {
      const num = Number(value);
      if (!Number.isFinite(num)) return "balance-value balance-neutral";
      if (num > 0) return "balance-value balance-negative";
      if (num < 0) return "balance-value balance-positive";
      return "balance-value balance-neutral";
    };

    function renderSearch(data) {
      if (!results) return;
      const students = (data.students||[]).map(s => `
        <a class="block px-4 py-3 hover:bg-indigo-50" href="/student/${s.id}">
          <div class="text-sm font-medium text-gray-900">${s.name} <span class="text-xs text-gray-500">(${s.class_name||''}${s.admission_no? ' • '+s.admission_no:''})</span></div>
        <div class="${balanceClassName(s.balance||0)} text-xs">Balance: KES ${(Number(s.balance||0)).toLocaleString()} • Credit: KES ${(Number(s.credit||0)).toLocaleString()}</div>
        </a>`).join('');
      const pays = (data.payments||[]).map(p => `
        <a class="block px-4 py-3 hover:bg-indigo-50" href="/payments?ref=${encodeURIComponent(p.reference||'')}">
          <div class="text-sm font-medium text-gray-900">Payment ${p.reference||''} <span class="text-xs text-gray-500">KES ${(Number(p.amount||0)).toLocaleString()}</span></div>
          <div class="text-xs text-gray-500">${p.student_name||''} • ${p.date||''}</div>
        </a>`).join('');
      results.innerHTML = `
        <div>
          <div class="px-4 py-2 text-[11px] uppercase tracking-wide text-gray-500 bg-gray-50">Students</div>
          ${students || '<div class="px-4 py-3 text-sm text-gray-500">No matches</div>'}
        </div>
        <div>
          <div class="px-4 py-2 text-[11px] uppercase tracking-wide text-gray-500 bg-gray-50">Payments</div>
          ${pays || '<div class="px-4 py-3 text-sm text-gray-500">No matches</div>'}
        </div>`;
      try { lucide.createIcons(); } catch(_) {}
    }
    if (input) {
      input.addEventListener('input', () => {
        const q = input.value.trim();
        clearTimeout(searchTimer);
        if (!q) { results.innerHTML=''; return; }
        searchTimer = setTimeout(() => {
          fetch(`/api/search?q=${encodeURIComponent(q)}`)
            .then(r => r.ok ? r.json() : {})
            .then(renderSearch)
            .catch(() => {});
        }, 250);
      });
    }
  
  

  // Register service worker
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", function(){
      navigator.serviceWorker.register("/static/sw.js").catch(()=>{});
    });
  }

  // Sanitize stray mojibake characters across the UI
  (function(){
    const MAP = new Map([
      ['â€“','–'],['â€”','—'],['â€˜','‘'],['â€™','’'],['â€œ','“'],['â€�','”'],['â€¦','…'],
      ['â€“Â','–'],['Â ',''],['Ã—','×'],['Ã·','÷'],['Ã©','é'],['Ã',''],
      ['â–²','▲'],['â–¼','▼'],['â†’','→'],['â†�','←'],['â—�','•']
    ]);
    function fixText(s){
      if (!s) return s;
      let out = s;
      MAP.forEach((to,from)=>{ out = out.split(from).join(to); });
      // Generic cleanup for replacement char
      out = out.replace(/�+/g,'-');
      return out;
    }

    // Delegate [data-back] clicks to neoBack for consistent behavior
    document.addEventListener('click', function(e){
      const t = e.target.closest('[data-back]');
      if (!t) return;
      e.preventDefault();
      try { neoBack(); } catch(_) {}
    });
    function walk(node){
      if (node.nodeType === Node.TEXT_NODE) {
        const fixed = fixText(node.nodeValue);
        if (fixed !== node.nodeValue) node.nodeValue = fixed;
        return;
      }
      for (let c=node.firstChild; c; c=c.nextSibling) walk(c);
    }
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', ()=>walk(document.body));
    } else {
      walk(document.body);
    }
  })();

</script>

</body>
</html>






      

