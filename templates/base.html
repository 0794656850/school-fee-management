<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% block title %}{{ APP_TITLE }}{% endblock %}</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  

  <style>
    /* Premium, universal theme */
    :root {
      /* Brand */
      --brand-600: #4f46e5; /* indigo-600 */
      --brand-700: #4338ca;
      --brand-50:  #eef2ff;
      --brand-100: #e0e7ff;
      --brand-200: #c7d2fe;
      --brand-grad-from: #4338ca;
      --brand-grad-to: #06b6d4;
      /* Accents + states */
      --accent-500: #06b6d4; /* cyan-500 */
      --success-500: #10b981; /* emerald-500 */
      --warn-500: #f59e0b; /* amber-500 */
      --danger-500: #ef4444; /* red-500 */
      /* Surfaces + text */
      --bg-app: linear-gradient(135deg, #f8fafc 0%, #eef2ff 40%, #e0f7fa 100%);
      --surface: rgba(255,255,255,0.88);
      --surface-strong: rgba(255,255,255,0.95);
      --text: #0f172a; /* slate-900 */
      --text-muted: #475569; /* slate-600 */
      --border: #e2e8f0; /* slate-200 */
      --ring: rgba(79,70,229,.35);
    }

    

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-app);
      color: var(--text);
      overflow: hidden;
      --tw-ring-color: var(--ring);
    }

    /* Global surface helpers */
    main > section { background: linear-gradient(180deg, #ffffff 0%, #f9fafb 100%); }

    .sidebar {
      backdrop-filter: blur(16px);
      background: linear-gradient(180deg, rgba(238,242,255,.85), rgba(255,255,255,.85));
      box-shadow: 4px 0 20px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
      border-right: 1px solid var(--border);
      position: relative;
      overflow: hidden;
    }
    .sidebar::before {
      content: "";
      position: absolute;
      inset: -20% -40% auto auto;
      height: 180px;
      width: 180px;
      background: radial-gradient(closest-side, rgba(79,70,229,.12), transparent 70%);
      filter: blur(8px);
      pointer-events: none;
    }

    .sidebar a { color: var(--text-muted); transition: all 0.25s ease; }
    .sidebar a:hover { transform: translateX(4px); background: rgba(79,70,229,.08); }

    /* Hide any legacy brand text in anchor group */
    .sidebar a.group h1:first-of-type { display: none; }

    .active-link {
      background: linear-gradient(90deg, rgba(79,70,229,.16), rgba(6,182,212,.10));
      color: var(--brand-700);
      font-weight: 600;
      border: 1px solid rgba(79,70,229,.18);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.3);
    }

    main { background: #f9fafb; }
    

    header {
      backdrop-filter: blur(12px);
      background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.85));
      border-bottom: 1px solid var(--border);
    }
    

    .nav-button:hover { background-color: rgba(15,23,42,.06); }

    /* Icon color inherits current color; nudge default */
    i[data-lucide] { color: var(--text-muted); }

    /* KPI cards */
    .kpi {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 1rem;
      box-shadow: 0 4px 16px rgba(15,23,42,.06);
      transition: transform .25s ease, box-shadow .25s ease;
    }
    .kpi:hover { transform: translateY(-3px); box-shadow: 0 10px 24px rgba(15,23,42,.08); }
    .kpi__icon {
      background: linear-gradient(135deg, var(--brand-grad-from), var(--brand-grad-to));
      color: #fff; border-radius: .875rem; padding: .75rem; box-shadow: 0 6px 16px rgba(79,70,229,.25);
    }
    .kpi--success .kpi__icon { background: linear-gradient(135deg, #10b981, #34d399); box-shadow: 0 6px 16px rgba(16,185,129,.25); }
    .kpi--danger  .kpi__icon { background: linear-gradient(135deg, #ef4444, #fb7185); box-shadow: 0 6px 16px rgba(239,68,68,.25); }
    .kpi--warn    .kpi__icon { background: linear-gradient(135deg, #f59e0b, #fbbf24); box-shadow: 0 6px 16px rgba(245,158,11,.25); }

    /* Footer signature */
    .app-footer {
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(255,255,255,.85), rgba(238,242,255,.9));
      border-top: 1px solid var(--border);
    }
    .signature-badge {
      background: radial-gradient(120% 120% at 10% 10%, rgba(79,70,229,.16), rgba(6,182,212,.12) 40%, transparent 70%);
      border: 1px solid rgba(79,70,229,.2);
      box-shadow: 0 8px 20px rgba(6,182,212,.15);
    }
  
    /* Brand button */
    .btn-brand {
      background: linear-gradient(135deg, var(--brand-grad-from), var(--brand-grad-to));
      color: #fff;
      box-shadow: 0 6px 18px rgba(6,182,212,.25);
      transition: transform .2s ease, filter .2s ease;
    }
    .btn-brand:hover { filter: saturate(1.05) brightness(1.03); transform: translateY(-2px); }

    /* Selection */
    ::selection { background: rgba(79,70,229,.18); color: #111827; }
  </style>

  <!-- App Icon / Favicon -->
  <link rel="icon" href="{{ url_for('static', filename=FAVICON) }}" type="image/jpeg">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename=FAVICON) }}">
</head>

<body class="flex h-screen overflow-hidden">

  <!-- Sidebar -->
  <aside class="sidebar w-64 flex flex-col border-r border-gray-200">
    <div class="p-6 border-b border-gray-100 flex items-center justify-between">
      <a href="{{ url_for('dashboard') }}" class="flex items-center gap-3 group">
        <img src="{{ url_for('static', filename=LOGO_PRIMARY) }}" alt="{{ BRAND_NAME }} Logo" class="h-9 w-9 rounded-md shadow-sm ring-1 ring-blue-100 group-hover:scale-105 transition"/>
        <div class="leading-tight">
          <div class="flex items-center gap-2">
            <span class="text-xl font-extrabold tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-blue-600 via-indigo-600 to-violet-600">{{ BRAND_NAME }}</span>
          </div>
          <div class="mt-0.5 text-[11px] text-gray-600 tracking-wide flex items-center gap-1">
            <i data-lucide="graduation-cap" class="w-3.5 h-3.5 text-blue-600"></i>
            <span class="font-medium">{{ PORTAL_TITLE }}</span>
          </div>
        </div>
      </a>
      <button id="toggleSidebar" class="md:hidden p-1 text-gray-600 hover:text-blue-600">
        <i data-lucide="menu"></i>
      </button>
    </div>

    <nav class="flex-1 px-4 py-6 space-y-2 overflow-y-auto">
      <a href="{{ url_for('dashboard') }}" 
         class="flex items-center gap-3 px-4 py-2.5 rounded-lg {% if request.path == '/' %}active-link{% else %}hover:bg-blue-50{% endif %}">
        <i data-lucide="home"></i> <span>Dashboard</span>
      </a>

      <a href="{{ url_for('students') }}" 
         class="flex items-center gap-3 px-4 py-2.5 rounded-lg {% if '/students' in request.path %}active-link{% else %}hover:bg-blue-50{% endif %}">
        <i data-lucide="users"></i> <span>Students</span>
      </a>

      <a href="#" 
         onclick="openAddPaymentModal()" 
         class="flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-blue-50 text-gray-700">
        <i data-lucide="dollar-sign"></i> <span>Add Payment</span>
      </a>

      <a href="{{ url_for('analytics') }}" 
         class="flex items-center gap-3 px-4 py-2.5 rounded-lg {% if '/analytics' in request.path %}active-link{% else %}hover:bg-blue-50{% endif %}">
        <i data-lucide="bar-chart-2"></i> <span>Analytics</span>
      </a>

      <a href="{{ url_for('ai.ai_home') }}" 
         class="flex items-center gap-3 px-4 py-2.5 rounded-lg {% if '/ai' in request.path %}active-link{% else %}hover:bg-blue-50{% endif %}">
        <i data-lucide="bot"></i> <span>AI Assistant</span>
      </a>

      <!-- ✅ NEW: Reminders Page -->
      

      

      <a href="{{ url_for('credit.credit_home') }}" 
         class="flex items-center gap-3 px-4 py-2.5 rounded-lg {% if '/credit' in request.path %}active-link{% else %}hover:bg-blue-50{% endif %}">
        <i data-lucide="coins"></i> <span>Credit Ops</span>
      </a>

      <a href="{{ url_for('terms.manage_terms') }}" 
         class="flex items-center gap-3 px-4 py-2.5 rounded-lg {% if '/terms' in request.path %}active-link{% else %}hover:bg-blue-50{% endif %}">
        <i data-lucide="calendar"></i> <span>Terms</span>
      </a>

      <a href="{{ url_for('terms.invoices_list') }}"
         class="flex items-center gap-3 px-4 py-2.5 rounded-lg {% if '/terms/invoices' in request.path %}active-link{% else %}hover:bg-blue-50{% endif %}">
        <i data-lucide="receipt"></i> <span>Invoices</span>
      </a>

      <a href="{{ url_for('reminders.reminders_home') }}"
         class="flex items-center gap-3 px-4 py-2.5 rounded-lg {% if '/reminders' in request.path %}active-link{% else %}hover:bg-blue-50{% endif %}">
        <i data-lucide="bell"></i> <span>Reminders</span>
      </a>

      <a href="{{ url_for('docs') }}"
         class="flex items-center gap-3 px-4 py-2.5 rounded-lg {% if '/docs' in request.path %}active-link{% else %}hover:bg-blue-50{% endif %}">
        <i data-lucide="book-open"></i> <span>Documentation</span>
      </a>

      <a href="{{ url_for('admin.school_profile') }}"
         class="flex items-center gap-3 px-4 py-2.5 rounded-lg {% if '/admin/school' in request.path %}active-link{% else %}hover:bg-blue-50{% endif %}">
        <i data-lucide="building-2"></i> <span>School Profile</span>
      </a>

      <a href="{{ url_for('admin.access_settings') }}"
         class="flex items-center gap-3 px-4 py-2.5 rounded-lg {% if ('/admin/settings' in request.path) or ('/admin/security' in request.path) %}active-link{% else %}hover:bg-blue-50{% endif %}">
        <i data-lucide="shield"></i> <span>Access &amp; Security</span>
      </a>

      

      
    </nav>

    <div class="p-4 border-t border-gray-100 text-center text-gray-500 text-xs">
      <p>© 2025 <span class="font-semibold text-blue-600">Fee_Management_System</span></p>
      <p class="mt-1">Powered by Flask</p>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 flex flex-col overflow-y-auto">

    <!-- Header -->
    <header class="sticky top-0 z-20 border-b border-gray-200 px-8 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <button onclick="history.back()" class="hidden md:inline-flex items-center gap-1 text-gray-600 hover:text-indigo-700 px-2 py-1 rounded-lg border border-gray-200 hover:border-indigo-300" title="Back">
          <i data-lucide="arrow-left"></i>
          <span class="text-sm">Back</span>
        </button>
        <img src="{{ url_for('static', filename=LOGO_SECONDARY) }}" alt="{{ BRAND_NAME }}" class="h-7 w-7 rounded-sm ring-1 ring-blue-100/60 shadow-sm"/>
        <h2 class="text-lg font-semibold text-gray-800 tracking-tight">
          {% block page_title %}{% endblock %}
        </h2>
      </div>

      <div class="flex items-center gap-3">
        <button id="globalSearchBtn" class="hidden md:inline-flex items-center gap-2 text-xs px-3 py-1.5 rounded-full border border-gray-200 bg-white text-gray-700 hover:bg-gray-50" title="Search (Ctrl+K)">
          <i data-lucide="search"></i>
          <span>Search</span>
          <kbd class="ml-1 text-[10px] px-1 py-0.5 rounded border bg-gray-50">Ctrl+K</kbd>
        </button>
        <span id="currentTermChip" class="hidden md:inline-flex items-center gap-2 text-xs px-3 py-1.5 rounded-full border border-indigo-200 bg-indigo-50 text-indigo-700">
          <i data-lucide="calendar"></i>
          <span id="currentTermText">{{ CURRENT_YEAR or '—' }} • Term {{ CURRENT_TERM or '—' }}</span>
        </span>
        
        <a href="{{ url_for('reminders.reminders_home') }}" class="nav-button p-2 rounded-full hover:bg-gray-100 transition" title="Reminders">
          <i data-lucide="bell"></i>
        </a>
        <a href="{{ url_for('auth.logout') }}" class="nav-button p-2 rounded-full hover:bg-gray-100 transition" title="Sign out">
          <i data-lucide="log-out"></i>
        </a>
      </div>
    </header>

    <!-- Content Area -->
    <section class="p-8 flex-1">
      <!-- Flash Messages -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div id="flash-container" class="space-y-2 mb-4">
            {% for category, message in messages %}
              {% set styles = {
                'success': 'bg-green-50 text-green-800 border-green-200',
                'error': 'bg-red-50 text-red-800 border-red-200',
                'warning': 'bg-yellow-50 text-yellow-800 border-yellow-200',
                'info': 'bg-blue-50 text-blue-800 border-blue-200'
              } %}
              <div class="flash-item border {{ styles.get(category, 'bg-gray-50 text-gray-800 border-gray-200') }} rounded-lg px-4 py-3 shadow-sm flex items-start gap-2">
                <span class="mt-0.5">
                  {% if category == 'success' %}<i data-lucide="check-circle" class="w-4 h-4"></i>{% endif %}
                  {% if category == 'error' %}<i data-lucide="alert-octagon" class="w-4 h-4"></i>{% endif %}
                  {% if category == 'warning' %}<i data-lucide="alert-triangle" class="w-4 h-4"></i>{% endif %}
                  {% if category == 'info' %}<i data-lucide="info" class="w-4 h-4"></i>{% endif %}
                </span>
                <div class="flex-1 text-sm">{{ message }}</div>
                <button class="dismiss text-gray-400 hover:text-gray-600">
                  <i data-lucide="x"></i>
                </button>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      {% block content %}{% endblock %}
    </section>

    <!-- Global Footer -->
    <footer class="app-footer">
      <div class="max-w-7xl mx-auto px-8 py-6 flex flex-col md:flex-row items-center justify-between gap-4">
        <div class="flex items-center gap-3 text-sm text-gray-600">
          <span class="inline-flex items-center gap-2 signature-badge px-3 py-1.5 rounded-xl">
            <i data-lucide="sparkles" class="w-4 h-4 text-indigo-600"></i>
            <span class="tracking-wide">Crafted with passion by</span>
            <span class="font-extrabold tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 via-cyan-500 to-emerald-500">AKILLIUS VINCENT</span>
          </span>
        </div>
        <div class="text-xs text-gray-600">
          <span class="mr-2">© {{ (now.year if now is defined else 2025) }}</span>
          
        </div>
      </div>
      <div class="px-8 pb-6 text-center text-xs text-gray-600">© 2025 Fee_Management_System</div>
    </footer>
  </main>

  <!-- Global Search Modal -->
  <div id="searchModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/30" onclick="hideSearch()"></div>
    <div class="absolute left-1/2 -translate-x-1/2 top-20 w-full max-w-2xl bg-white border border-gray-200 rounded-2xl shadow-2xl overflow-hidden">
      <div class="flex items-center gap-2 px-4 py-3 border-b bg-gray-50">
        <i data-lucide="search" class="text-gray-500"></i>
        <input id="searchInput" type="text" placeholder="Search students, payments…" class="flex-1 outline-none bg-transparent text-sm" />
        <button onclick="hideSearch()" class="text-gray-400 hover:text-gray-700"><i data-lucide="x"></i></button>
      </div>
      <div id="searchResults" class="max-h-96 overflow-y-auto divide-y"></div>
    </div>
  </div>

  <script>
    // Initialize icons
    lucide.createIcons();

    // Sidebar Toggle (Mobile)
    const sidebar = document.querySelector('.sidebar');
    const toggleBtn = document.getElementById('toggleSidebar');
    if (toggleBtn) {
      toggleBtn.addEventListener('click', () => {
        sidebar.classList.toggle('hidden');
      });
    }

    // Example modal trigger placeholder
    function openAddPaymentModal() {
      window.location.href = "{{ url_for('payments') }}";
    }

    // Flash close + auto-dismiss
    (function() {
      const container = document.getElementById('flash-container');
      if (!container) return;
      // Pin flash container to the very top center
      try {
        container.classList.add('fixed','top-3','left-1/2','-translate-x-1/2','w-full','max-w-2xl','z-50','px-4');
        container.classList.remove('mb-4');
      } catch (e) {}
      container.querySelectorAll('.dismiss').forEach(btn => {
        btn.addEventListener('click', () => btn.closest('.flash-item')?.remove());
      });
      setTimeout(() => {
        container.querySelectorAll('.flash-item').forEach(el => el.remove());
      }, 4500);
      // Refresh icons
      lucide.createIcons();
    })();

    // Replace stray bullet mojibake with a clean separator
    (function() {
      try {
        const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT);
        const replacePairs = [
          ['â€¢', ', '],
          ['�?�', ', '],
          ['•', ', ']
        ];
        let node;
        while ((node = walker.nextNode())) {
          let text = node.nodeValue;
          let newText = text;
          for (const [from, to] of replacePairs) {
            if (newText.includes(from)) newText = newText.split(from).join(to);
          }
          if (newText !== text) node.nodeValue = newText;
        }
      } catch (e) { /* noop */ }
    })();

    // Live refresh for current term badge
    (function() {
      const chip = document.getElementById('currentTermChip');
      const text = document.getElementById('currentTermText');
      if (!chip || !text) return;
      function tick() {
        fetch('/terms/current')
          .then(r => r.ok ? r.json() : null)
          .then(d => {
            if (!d) return;
            text.textContent = `${d.year} • Term ${d.term}`;
            chip.style.display = 'inline-flex';
            try { lucide.createIcons(); } catch (_) {}
          })
          .catch(() => {});
      }
      setInterval(tick, 10000);
    })();

    // ----- Global Search -----
    const searchBtn = document.getElementById('globalSearchBtn');
    const modal = document.getElementById('searchModal');
    const input = document.getElementById('searchInput');
    const results = document.getElementById('searchResults');
    function showSearch() { if (!modal) return; modal.classList.remove('hidden'); setTimeout(() => input && input.focus(), 10); }
    function hideSearch() { if (!modal) return; modal.classList.add('hidden'); if (input) input.value=''; if (results) results.innerHTML=''; }
    window.hideSearch = hideSearch;
    if (searchBtn) searchBtn.addEventListener('click', showSearch);
    document.addEventListener('keydown', (e) => {
      const isMac = navigator.platform.toUpperCase().indexOf('MAC')>=0;
      if ((isMac ? e.metaKey : e.ctrlKey) && e.key.toLowerCase()==='k') { e.preventDefault(); showSearch(); }
      if (e.key === '/' && !(e.target instanceof HTMLInputElement || e.target instanceof HTMLTextAreaElement)) { e.preventDefault(); showSearch(); }
      if (e.key === 'Escape') hideSearch();
    });
    let searchTimer;
    function renderSearch(data) {
      if (!results) return;
      const students = (data.students||[]).map(s => `
        <a class="block px-4 py-3 hover:bg-indigo-50" href="/student/${s.id}">
          <div class="text-sm font-medium text-gray-900">${s.name} <span class="text-xs text-gray-500">(${s.class_name||''}${s.admission_no? ' • '+s.admission_no:''})</span></div>
          <div class="text-xs text-gray-500">Balance: KES ${(Number(s.balance||0)).toLocaleString()} • Credit: KES ${(Number(s.credit||0)).toLocaleString()}</div>
        </a>`).join('');
      const pays = (data.payments||[]).map(p => `
        <a class="block px-4 py-3 hover:bg-indigo-50" href="/payments?ref=${encodeURIComponent(p.reference||'')}">
          <div class="text-sm font-medium text-gray-900">Payment ${p.reference||''} <span class="text-xs text-gray-500">KES ${(Number(p.amount||0)).toLocaleString()}</span></div>
          <div class="text-xs text-gray-500">${p.student_name||''} • ${p.date||''}</div>
        </a>`).join('');
      results.innerHTML = `
        <div>
          <div class="px-4 py-2 text-[11px] uppercase tracking-wide text-gray-500 bg-gray-50">Students</div>
          ${students || '<div class="px-4 py-3 text-sm text-gray-500">No matches</div>'}
        </div>
        <div>
          <div class="px-4 py-2 text-[11px] uppercase tracking-wide text-gray-500 bg-gray-50">Payments</div>
          ${pays || '<div class="px-4 py-3 text-sm text-gray-500">No matches</div>'}
        </div>`;
      try { lucide.createIcons(); } catch(_) {}
    }
    if (input) {
      input.addEventListener('input', () => {
        const q = input.value.trim();
        clearTimeout(searchTimer);
        if (!q) { results.innerHTML=''; return; }
        searchTimer = setTimeout(() => {
          fetch(`/api/search?q=${encodeURIComponent(q)}`)
            .then(r => r.ok ? r.json() : {})
            .then(renderSearch)
            .catch(() => {});
        }, 250);
      });
    }
  
  </script>
</body>
</html>

