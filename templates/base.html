<!DOCTYPE html>
<html lang="en">
<head>
        
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% block title %}{{ APP_TITLE }}{% endblock %}</title>
  <meta name="theme-color" content="{{ BRAND_COLOR or '#2563eb' }}" />
  <link rel="manifest" href="/static/manifest.webmanifest" />

  

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">

  
  <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}" />

  <!-- App Icon / Favicon -->
  <link rel="icon" href="{{ url_for('static', filename=FAVICON) }}" type="image/svg+xml">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename=FAVICON) }}">
</head>

<body class="flex h-screen flex-col overflow-hidden no-anim {% block body_class %}{% endblock %}" data-plan="PRO">
  <a href="#main" class="sr-only focus:not-sr-only focus:fixed focus:top-2 focus:left-2 focus:z-50 focus:px-3 focus:py-2 focus:rounded-lg focus:bg-white focus:border focus:border-gray-200 focus:shadow">Skip to content</a>

  <section class="top-banner" aria-label="Institutional banner"
    style="--banner-color: {{ BRAND_COLOR or '#0f60d1' }};">
    <div class="top-banner__inner">
      <div class="top-banner__crest">
        <img src="{{ url_for('static', filename=LOGO_PRIMARY) }}" alt="Lovato_Tech" />
      </div>
      <div class="top-banner__text">
        <p class="top-banner__title">SmartEduPay</p>
        <p class="top-banner__name">{{ SCHOOL_NAME or BRAND_NAME or 'SmartEduPay Portal' }}</p>
        <p class="top-banner__tagline">Accountability, clarity, and trust in every ledger</p>
      </div>
      <div class="top-banner__right">
        <span class="top-banner__meta">
          <i data-lucide="calendar" class="w-4 h-4"></i>
          <span class="top-banner__term">
            Term {{ CURRENT_TERM or '-' }} | {{ CURRENT_YEAR or '-' }}
          </span>
        </span>
        <a href="{{ url_for('admin.payment_records') }}" class="nav-button top-banner__record-btn" title="View fee payment records">
          <i data-lucide="file-text"></i>
          <span>Fee payment record</span>
        </a>
        <a href="{{ url_for('auth.logout') }}" class="nav-button top-banner__logout-btn" title="Sign out securely">
          <i data-lucide="log-out"></i>
          <span>Logout</span>
        </a>
      </div>
    </div>
  </section>

  <div class="flex flex-1 overflow-hidden">
  <!-- Sidebar -->
  <aside class="sidebar w-64 flex flex-col border-r border-gray-200">
    <div class="p-4 border-b border-gray-100 flex items-center justify-between">
      <div class="leading-tight select-none text-xs text-gray-500">
        <span class="hidden md:inline">SmartEduPay Portal</span>
      </div>
      <button id="toggleSidebar" class="md:hidden p-1 text-gray-600 hover:text-blue-600">
        <i data-lucide="menu"></i>
      </button>
    </div>

    <nav class="flex-1 px-4 py-6 space-y-4 overflow-y-auto">
      <div class="nav-section">
        <p class="nav-section__label">Core</p>
        <a href="{{ url_for('dashboard') }}" class="nav-link {% if request.path == '/' %}active-link{% endif %}">
          <i data-lucide="home"></i>
          <span>Dashboard</span>
        </a>
        <a href="{{ url_for('students') }}" class="nav-link {% if '/students' in request.path %}active-link{% endif %}">
          <i data-lucide="users"></i>
          <span>Students</span>
        </a>
        <a href="{{ url_for('payments') }}" class="nav-link {% if '/payments' in request.path %}active-link{% endif %}">
          <i data-lucide="dollar-sign"></i>
          <span>Add Payment</span>
        </a>
        <a href="{{ url_for('ai.ai_home') }}" class="nav-link {% if '/ai' in request.path %}active-link{% endif %}">
          <i data-lucide="bot"></i>
          <span>AI Assistant</span>
        </a>
      </div>

      <div class="nav-section">
        <p class="nav-section__label">Operations</p>
        <a href="{{ url_for('credit.credit_home') }}" class="nav-link {% if '/credit' in request.path %}active-link{% endif %}">
          <i data-lucide="coins"></i>
          <span>Credit Ops</span>
        </a>
        <a href="{{ url_for('terms.manage_terms') }}" class="nav-link {% if '/terms' in request.path %}active-link{% endif %}">
          <i data-lucide="calendar"></i>
          <span>Terms</span>
        </a>
        <a href="{{ url_for('terms.invoices_list') }}" class="nav-link {% if '/terms/invoices' in request.path %}active-link{% endif %}">
          <i data-lucide="receipt"></i>
          <span>Invoices</span>
        </a>
        <a href="{{ url_for('reminders.reminders_home') }}" class="nav-link {% if '/reminders' in request.path %}active-link{% endif %}">
          <i data-lucide="bell"></i>
          <span>Reminders</span>
        </a>
        <a href="{{ url_for('analytics_dashboard') }}" class="nav-link {% if '/analytics' in request.path %}active-link{% endif %}">
          <i data-lucide="activity"></i>
          <span>Analytics</span>
        </a>
      </div>

      <div class="nav-section">
        <p class="nav-section__label">Engagement</p>
        <a href="{{ url_for('newsletters.index') }}" class="nav-link {% if '/newsletters' in request.path %}active-link{% endif %}">
          <i data-lucide="megaphone"></i>
          <span>Newsletters</span>
        </a>
        <a href="{{ url_for('recovery.dashboard') }}" class="nav-link {% if '/recovery' in request.path %}active-link{% endif %}">
          <i data-lucide="phone-call"></i>
          <span>Recovery</span>
        </a>
        <a href="{{ url_for('docs') }}" class="nav-link {% if '/docs' in request.path %}active-link{% endif %}">
          <i data-lucide="book-open"></i>
          <span>Documentation</span>
        </a>
      </div>

      <div class="nav-section">
        <p class="nav-section__label">Admin</p>
        <a href="{{ url_for('admin.school_profile') }}" class="nav-link {% if '/admin/school' in request.path %}active-link{% endif %}">
          <i data-lucide="building-2"></i>
          <span>School Profile</span>
        </a>
        <a href="{{ url_for('admin.access_settings') }}" class="nav-link {% if ('/admin/settings' in request.path) or ('/admin/security' in request.path) %}active-link{% endif %}">
          <i data-lucide="shield"></i>
          <span>Access &amp; Security</span>
        </a>
        <a href="{{ url_for('admin.audit_logs') }}" class="nav-link {% if '/admin/audit' in request.path %}active-link{% endif %}">
          <i data-lucide="list-check"></i>
          <span>Audit Logs</span>
        </a>
        <a href="{{ url_for('admin.payment_records') }}" class="nav-link {% if '/admin/payment-records' in request.path %}active-link{% endif %}">
          <i data-lucide="file-text"></i>
          <span>Fee Records</span>
        </a>
        <a href="{{ url_for('admin.admin_backups') }}" class="nav-link {% if '/admin/backups' in request.path %}active-link{% endif %}">
          <i data-lucide="database"></i>
          <span>Backups &amp; Restore</span>
        </a>
      </div>
    </nav>


    <div class="p-4 border-t border-gray-100 text-center text-gray-500 text-xs">
      <p>&copy; 2025 <span class="font-semibold text-blue-600">Fee_Management_System</span></p>
      <p class="mt-1">Powered by Flask</p>
    </div>
  </aside>

  <!-- Main Content -->
  <main id="main" class="flex-1 flex flex-col overflow-y-auto">
    {% set flashed_messages = get_flashed_messages(with_categories=true) %}
    <div id="flash-container" class="space-y-2 mb-4" role="status" aria-live="polite" aria-atomic="true">
      {% if flashed_messages %}
        {% set flash_variants = {
          'success': 'flash-success text-green-900',
          'error': 'flash-error text-rose-900',
          'warning': 'flash-warning text-amber-900',
          'info': 'flash-info text-sky-900'
        } %}
        {% for category, message in flashed_messages %}
          {% set variant = flash_variants.get(category, flash_variants['info']) %}
          <div class="flash-item border rounded-lg px-4 py-3 shadow-sm flex items-start gap-2 {{ variant }}">
            <span class="mt-0.5">
              {% if category == 'success' %}<i data-lucide="check-circle" class="w-4 h-4"></i>{% endif %}
              {% if category == 'error' %}<i data-lucide="alert-octagon" class="w-4 h-4"></i>{% endif %}
              {% if category == 'warning' %}<i data-lucide="alert-triangle" class="w-4 h-4"></i>{% endif %}
              {% if category == 'info' %}<i data-lucide="info" class="w-4 h-4"></i>{% endif %}
            </span>
            <div class="flex-1 text-sm flash-text">{{ message }}</div>
            <button type="button" class="dismiss p-1 -m-1 text-gray-400 hover:text-gray-600" aria-label="Dismiss">
              <i data-lucide="x" class="w-4 h-4"></i>
            </button>
          </div>
        {% endfor %}
      {% endif %}
    </div>

    <!-- Header -->
    <header class="sticky top-0 z-20 border-b border-gray-200 px-8 py-4 flex items-center gap-3 bg-white/80 backdrop-blur-md">
      <div class="flex items-center gap-3">
        <a href="{{ url_for('students') }}" data-back class="hidden md:inline-flex items-center gap-1 text-gray-600 hover:text-indigo-700 px-2 py-1 rounded-lg border border-gray-200 hover:border-indigo-300" title="Back" role="button">
          <i data-lucide="arrow-left"></i>
          <span class="text-sm">Back</span>
        </a>
        <img src="{{ url_for('static', filename=LOGO_SECONDARY) }}" alt="{{ BRAND_NAME }}" class="h-7 w-7 rounded-sm ring-1 ring-blue-100/60 shadow-sm"/>
        <h2 class="text-lg font-semibold text-gray-800 tracking-tight">
          {% block page_title %}{% endblock %}
        </h2>
      </div>
    </header>

    <!-- Content Area -->
    <section class="p-8 flex-1">
      {% block content %}{% endblock %}
    </section>

    <!-- Global Footer -->
    <footer class="app-footer">
      <div class="max-w-7xl mx-auto px-8 py-6 flex flex-col md:flex-row items-center justify-between gap-4">
        <div class="flex items-center gap-3 text-sm text-gray-600">
          <span class="inline-flex items-center gap-2 signature-badge px-3 py-1.5 rounded-xl">
            <i data-lucide="sparkles" class="w-4 h-4 text-indigo-600"></i>
            <span class="tracking-wide">Crafted with passion by</span>
            <span class="font-extrabold tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 via-cyan-500 to-emerald-500">AKILLIUS VINCENT</span>
          </span>
        </div>
        <div class="text-xs text-gray-600">
          <span class="mr-2">&copy; {{ (now.year if now is defined else 2025) }}</span>
          
        </div>
      </div>
      <div class="px-8 pb-6 text-center text-xs text-gray-600">&copy; 2025 Fee_Management_System</div>
    </footer>
  </main>
  </div>

  <!-- Global Search Modal -->
  <div id="searchModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/30" onclick="hideSearch()"></div>
    <div class="absolute left-1/2 -translate-x-1/2 top-20 w-full max-w-2xl bg-white border border-gray-200 rounded-2xl shadow-2xl overflow-hidden">
      <div class="flex items-center gap-2 px-4 py-3 border-b bg-gray-50">
        <i data-lucide="search" class="text-gray-500"></i>
        <input id="searchInput" type="text" placeholder="Search students, payments�" class="flex-1 outline-none bg-transparent text-sm" />
        <button onclick="hideSearch()" class="text-gray-400 hover:text-gray-700"><i data-lucide="x"></i></button>
      </div>
      <div id="searchResults" class="max-h-96 overflow-y-auto divide-y"></div>
    </div>
  </div>

  <script>
    // Initialize icons
    lucide.createIcons();

    // --- Auto-fit helper for KPI values ---
    // Shrinks font-size of elements with .fit-text so content never overflows.
    (function(){
      function fitOne(el){
        if (!el) return;
        const isWrap = el.classList.contains('fit-wrap');
        // Reset to computed size first so we can shrink predictably
        el.style.fontSize = '';
        const style = getComputedStyle(el);
        const max = parseFloat(style.fontSize) || 30; // starting size from CSS/tailwind
        // Keep a higher floor so amounts never look too small
        const min = 12; // px minimum to keep long totals from overflowing
        let size = max;
        // Ensure the element has a width basis
        el.style.maxWidth = '100%';
        el.style.whiteSpace = isWrap ? 'normal' : 'nowrap';
        // For wrapped fit-text, we don't shrink; CSS handles clamping elegantly
        if (isWrap) {
          el.style.overflow = 'hidden';
          el.style.textOverflow = 'ellipsis';
          return;
        }
        let guard = 0;
        // Shrink until it fits its own box
        while (el.scrollWidth > el.clientWidth && size > min && guard < 60){
          size -= 1;
          el.style.fontSize = size + 'px';
          guard++;
        }
        // Keep overflow hidden to prevent overlap on long totals
        el.style.overflow = 'hidden';
        el.style.textOverflow = 'ellipsis';
      }
      function fitAll(){
        document.querySelectorAll('.fit-text').forEach(fitOne);
      }
      window.fitKpis = fitAll;
      // Run on load and on resize
      window.addEventListener('load', fitAll);
      window.addEventListener('resize', () => { clearTimeout(window.__fitT); window.__fitT = setTimeout(fitAll, 80); });
      // Observe KPI containers for content changes
      try {
        const mo = new MutationObserver(() => { clearTimeout(window.__fitM); window.__fitM = setTimeout(fitAll, 40); });
        mo.observe(document.body, { subtree: true, characterData: true, childList: true });
      } catch(_) {}
    })();

    // Sidebar Toggle (Mobile)
    const sidebar = document.querySelector('.sidebar');
    const toggleBtn = document.getElementById('toggleSidebar');
    if (toggleBtn) {
      toggleBtn.addEventListener('click', () => {
        sidebar.classList.toggle('hidden');
      });
    }

    // Example modal trigger placeholder
    function openAddPaymentModal() {
      window.location.href = "{{ url_for('payments') }}";
    }

    // Session-aware back stack (keeps "real world" navigation order)
    const NAV_STACK_KEY = "navStack";
    function getNavStack() {
      try {
        const raw = sessionStorage.getItem(NAV_STACK_KEY) || "[]";
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch (_) {
        return [];
      }
    }
    function setNavStack(stack) {
      try { sessionStorage.setItem(NAV_STACK_KEY, JSON.stringify(stack)); } catch (_) {}
    }
    function recordNav() {
      const key = window.location.pathname + window.location.search;
      const stack = getNavStack();
      const last = stack[stack.length - 1];
      if (last !== key) {
        stack.push(key);
        if (stack.length > 30) stack.shift();
        setNavStack(stack);
      }
    }
    // Record once per page load (keeps the original path order)
    try { recordNav(); } catch (_) {}

    // Robust Back button handler
    function neoBack() {
      try {
        const key = window.location.pathname + window.location.search;
        const stack = getNavStack();
        let target = null;
        while (stack.length) {
          const prev = stack.pop();
          if (prev && prev !== key) {
            target = prev;
            break;
          }
        }
        setNavStack(stack);
        if (target) {
          window.location.href = target;
          return;
        }
      } catch (e) {}
      try {
        if (window.history && window.history.length > 1) {
          window.history.back();
          return;
        }
        const ref = document.referrer || '';
        if (ref && new URL(ref, window.location.origin).origin === window.location.origin) {
          window.location.href = ref;
          return;
        }
      } catch (e) {}
      // Fallback to Students list, else Dashboard
      try { window.location.href = "{{ url_for('dashboard') }}"; } catch(e) { window.location.href = "{{ url_for('students') }}"; }
    }

    // Flash close + auto-dismiss (supports future flash injections)
    (function() {
      const container = document.getElementById('flash-container');
      const AUTO_DISMISS_MS = 10000;

      const cancelAutoDismiss = (item) => {
        if (!item) return;
        const current = item.dataset.flashTimerId;
        if (current) {
          clearTimeout(Number(current));
          delete item.dataset.flashTimerId;
        }
      };

      const animateRemoval = (item) => {
        if (!item) return;
        cancelAutoDismiss(item);
        item.style.transition = 'opacity .25s ease, transform .25s ease';
        void item.offsetHeight;
        item.style.opacity = '0';
        item.style.transform = 'translateY(-4px)';
        setTimeout(() => item.remove(), 260);
      };

      const scheduleAutoDismiss = (item) => {
        if (!item || item.dataset.flashTimerId) return;
        const timer = setTimeout(() => animateRemoval(item), AUTO_DISMISS_MS);
        item.dataset.flashTimerId = timer.toString();
      };

      const handleDismiss = (btn) => {
        if (!btn) return;
        const item = btn.closest('.flash-item');
        if (!item) return;
        animateRemoval(item);
      };

      if (container) {
        try {
          container.classList.add('fixed','top-3','left-1/2','-translate-x-1/2','w-full','max-w-2xl','z-50','px-4');
          container.classList.remove('mb-4');
        } catch (e) {}
        const initFlashItems = () => {
          container.querySelectorAll('.flash-item').forEach(scheduleAutoDismiss);
        };
        initFlashItems();
        const observer = new MutationObserver(initFlashItems);
        observer.observe(container, { childList: true, subtree: true });
        lucide.createIcons();
      }

      document.addEventListener('click', (event) => {
        const target = event.target;
        if (!(target instanceof Element)) return;
        const btn = target.closest('.dismiss');
        if (!btn) return;
        event.preventDefault();
        handleDismiss(btn);
      });

      document.addEventListener('keydown', (event) => {
        if (event.key !== 'Enter' && event.key !== ' ') return;
        const target = event.target;
        if (!(target instanceof Element)) return;
        const btn = target.closest('.dismiss');
        if (!btn) return;
        event.preventDefault();
        handleDismiss(btn);
      });
    })();

    // Replace stray bullet mojibake with a clean separator
    (function() {
      try {
        const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT);
        const replacePairs = [
          ['•', ', '],
          ['???', ', '],
          ['�', ', ']
        ];
        let node;
        while ((node = walker.nextNode())) {
          let text = node.nodeValue;
          let newText = text;
          for (const [from, to] of replacePairs) {
            if (newText.includes(from)) newText = newText.split(from).join(to);
          }
          if (newText !== text) node.nodeValue = newText;
        }
      } catch (e) { /* noop */ }
    })();

    // Live refresh for current term badge
    (function() {
      const chip = document.getElementById('currentTermChip');
      const text = document.getElementById('currentTermText');
      if (!chip || !text) return;
      function tick() {
        fetch('/terms/current')
          .then(r => r.ok ? r.json() : null)
          .then(d => {
            if (!d) return;
            text.textContent = `${d.year} � Term ${d.term}`;
            // Normalize any stray control characters to a readable separator
            try { text.textContent = (text.textContent || '').replace(/[\u0000-\u001F]+/g, ' - '); } catch (_) {}
            chip.style.display = 'inline-flex';
            try { lucide.createIcons(); } catch (_) {}
          })
          .catch(() => {});
      }
      setInterval(tick, 10000);
    })();

    // Additional cleanup for mojibake in flash messages and current term chip
    (function(){
      try {
        const container = document.getElementById('flash-container');
        if (container) {
          container.querySelectorAll('.flash-item').forEach(item => {
            item.childNodes.forEach(n => {
              if (n.nodeType === Node.TEXT_NODE) {
                n.nodeValue = n.nodeValue.replace(/^?o\.\s*/, '');
              }
            });
          });
        }
      } catch(e){}
      try {
        const text = document.getElementById('currentTermText');
        if (text) {
          const fix = ()=>{ text.textContent = (text.textContent||'').replace(/\s*[^0-9]+\s*Term/, ' � Term'); };
          fix();
          setInterval(fix, 3000);
        }
      } catch(e){}
    })();

    // ----- Global Search -----
    const searchBtn = document.getElementById('globalSearchBtn');
    const modal = document.getElementById('searchModal');
    const input = document.getElementById('searchInput');
    const results = document.getElementById('searchResults');
    function showSearch() { if (!modal) return; modal.classList.remove('hidden'); setTimeout(() => input && input.focus(), 10); }
    function hideSearch() { if (!modal) return; modal.classList.add('hidden'); if (input) input.value=''; if (results) results.innerHTML=''; }
    window.hideSearch = hideSearch;
    if (searchBtn) searchBtn.addEventListener('click', showSearch);
    document.addEventListener('keydown', (e) => {
      const isMac = navigator.platform.toUpperCase().indexOf('MAC')>=0;
      if ((isMac ? e.metaKey : e.ctrlKey) && e.key.toLowerCase()==='k') { e.preventDefault(); showSearch(); }
      if (e.key === '/' && !(e.target instanceof HTMLInputElement || e.target instanceof HTMLTextAreaElement)) { e.preventDefault(); showSearch(); }
      if (e.key === 'Escape') hideSearch();
    });
    let searchTimer;
    const balanceClassName = (value) => {
      const num = Number(value);
      if (!Number.isFinite(num)) return "balance-value balance-neutral";
      if (num > 0) return "balance-value balance-negative";
      if (num < 0) return "balance-value balance-positive";
      return "balance-value balance-neutral";
    };

    function renderSearch(data) {
      if (!results) return;
      const students = (data.students||[]).map(s => `
        <a class="block px-4 py-3 hover:bg-indigo-50" href="/student/${s.id}">
          <div class="text-sm font-medium text-gray-900">${s.name} <span class="text-xs text-gray-500">(${s.class_name||''}${s.admission_no? ' � '+s.admission_no:''})</span></div>
        <div class="${balanceClassName(s.balance||0)} text-xs">Balance: KES ${(Number(s.balance||0)).toLocaleString()} � Credit: KES ${(Number(s.credit||0)).toLocaleString()}</div>
        </a>`).join('');
      const pays = (data.payments||[]).map(p => `
        <a class="block px-4 py-3 hover:bg-indigo-50" href="/payments?ref=${encodeURIComponent(p.reference||'')}">
          <div class="text-sm font-medium text-gray-900">Payment ${p.reference||''} <span class="text-xs text-gray-500">KES ${(Number(p.amount||0)).toLocaleString()}</span></div>
          <div class="text-xs text-gray-500">${p.student_name||''} � ${p.date||''}</div>
        </a>`).join('');
      results.innerHTML = `
        <div>
          <div class="px-4 py-2 text-[11px] uppercase tracking-wide text-gray-500 bg-gray-50">Students</div>
          ${students || '<div class="px-4 py-3 text-sm text-gray-500">No matches</div>'}
        </div>
        <div>
          <div class="px-4 py-2 text-[11px] uppercase tracking-wide text-gray-500 bg-gray-50">Payments</div>
          ${pays || '<div class="px-4 py-3 text-sm text-gray-500">No matches</div>'}
        </div>`;
      try { lucide.createIcons(); } catch(_) {}
    }
    if (input) {
      input.addEventListener('input', () => {
        const q = input.value.trim();
        clearTimeout(searchTimer);
        if (!q) { results.innerHTML=''; return; }
        searchTimer = setTimeout(() => {
          fetch(`/api/search?q=${encodeURIComponent(q)}`)
            .then(r => r.ok ? r.json() : {})
            .then(renderSearch)
            .catch(() => {});
        }, 250);
      });
    }
  
  

  // Register service worker
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", function(){
      navigator.serviceWorker.register("/static/sw.js").catch(()=>{});
    });
  }

  // Sanitize stray mojibake characters across the UI
  (function(){
    const MAP = new Map([
      ['–','�'],['—','�'],['‘','�'],['’','�'],['“','�'],['�?','�'],['…','�'],
      ['–�','�'],['� ',''],['×','�'],['÷','�'],['é','�'],['�',''],
      ['▲','?'],['▼','?'],['→','?'],['�?','?'],['�?','�']
    ]);
    function fixText(s){
      if (!s) return s;
      let out = s;
      MAP.forEach((to,from)=>{ out = out.split(from).join(to); });
      // Generic cleanup for replacement char
      out = out.replace(/?+/g,'-');
      return out;
    }

    // Delegate [data-back] clicks to neoBack for consistent behavior
    document.addEventListener('click', function(e){
      const t = e.target.closest('[data-back]');
      if (!t) return;
      e.preventDefault();
      try { neoBack(); } catch(_) {}
    });
    function walk(node){
      if (node.nodeType === Node.TEXT_NODE) {
        const fixed = fixText(node.nodeValue);
        if (fixed !== node.nodeValue) node.nodeValue = fixed;
        return;
      }
      for (let c=node.firstChild; c; c=c.nextSibling) walk(c);
    }
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', ()=>walk(document.body));
    } else {
      walk(document.body);
    }
  })();

</script>

<!-- Idle security overlay -->
<div id="idleOverlay" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 px-4 py-6">
  <div class="max-w-md w-full bg-white rounded-3xl shadow-2xl border border-gray-200 p-6 text-center space-y-4">
    <div class="flex items-center justify-center text-4xl text-indigo-600">
      <i data-lucide="shield-alert"></i>
    </div>
    <h3 class="text-lg font-semibold text-gray-900">Security timeout pending</h3>
    <p class="text-sm text-gray-600">
      For sensitive finance workflows we automatically lock down after <span class="font-semibold">20 minutes</span> of idle time.
      The portal will log you out in <span id="idleCount" class="font-mono">60</span>s unless you stay active.
    </p>
    <div aria-live="polite" class="text-sm text-gray-500">Interactions anywhere in the UI reset the countdown.</div>
    <div class="flex flex-wrap items-center justify-center gap-3">
      <button id="idleStaySignedIn" class="inline-flex items-center gap-2 px-4 py-2 rounded-2xl bg-gradient-to-r from-indigo-600 to-sky-500 text-white text-xs uppercase tracking-[0.2em] shadow-lg shadow-indigo-500/30">
        <i data-lucide="refresh-ccw" class="w-4 h-4"></i>
        Stay signed in
      </button>
      <button id="idleLogoutNow" class="inline-flex items-center gap-2 px-4 py-2 rounded-2xl border border-gray-200 text-xs uppercase tracking-[0.2em] text-gray-600 hover:border-gray-400 hover:text-gray-800">
        Log out immediately
      </button>
    </div>
  </div>
</div>

<script>
  (function() {
    const IDLE_LIMIT_MS = 20 * 60 * 1000;
    const WARNING_MS = 60 * 1000;
    const logoutUrl = "{{ url_for('auth.logout') }}";
    const overlay = document.getElementById('idleOverlay');
    const countEl = document.getElementById('idleCount');
    const stayBtn = document.getElementById('idleStaySignedIn');
    const logoutBtn = document.getElementById('idleLogoutNow');
    let warningTimeout;
    let idleTimeout;
    let countdownInterval;
    let remainingSeconds = Math.ceil(WARNING_MS / 1000);

    const activityEvents = ['mousemove', 'mousedown', 'keydown', 'scroll', 'touchstart'];

    function clearAllTimers() {
      clearTimeout(warningTimeout);
      clearTimeout(idleTimeout);
      clearInterval(countdownInterval);
      countdownInterval = null;
    }

    function scheduleIdleCheck() {
      clearAllTimers();
      warningTimeout = setTimeout(showWarning, IDLE_LIMIT_MS - WARNING_MS);
      idleTimeout = setTimeout(() => window.location.href = logoutUrl, IDLE_LIMIT_MS);
    }

    function showWarning() {
      if (!overlay) return;
      remainingSeconds = Math.ceil(WARNING_MS / 1000);
      overlay.classList.remove('hidden');
      updateCountdown();
      countdownInterval = setInterval(() => {
        remainingSeconds = Math.max(0, remainingSeconds - 1);
        updateCountdown();
      }, 1000);
    }

    function updateCountdown() {
      if (countEl) {
        countEl.textContent = remainingSeconds.toString().padStart(2, '0');
      }
    }

    function resetIdle(triggerOverlay = true) {
      if (overlay && triggerOverlay) {
        overlay.classList.add('hidden');
      }
      clearAllTimers();
      scheduleIdleCheck();
    }

    activityEvents.forEach(name => {
      document.addEventListener(name, () => resetIdle());
    });

    if (stayBtn) {
      stayBtn.addEventListener('click', (e) => {
        e.preventDefault();
        resetIdle(false);
      });
    }

    if (logoutBtn) {
      logoutBtn.addEventListener('click', (e) => {
        e.preventDefault();
        window.location.href = logoutUrl;
      });
    }

    scheduleIdleCheck();
  })();
</script>

<script>
  (function() {
    const STORAGE_KEY = "SmartEduPayPortalSettings";
    const defaults = {
      guardianQuickAlerts: false,
      guardianAutoRefresh: false,
      adminCompactStats: false,
      adminHighlightLinks: true,
    };
    const buttonsSelector = "[data-setting]";
    const loadState = () => {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        return stored ? JSON.parse(stored) : {};
      } catch {
        return {};
      }
    };
    const state = Object.assign({}, defaults, loadState());

    const persist = () => {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch {
        /* ignore */
      }
    };

    const refreshButton = (button) => {
      const key = button.dataset.setting;
      const active = !!state[key];
      button.classList.toggle("is-active", active);
      button.setAttribute("aria-pressed", active ? "true" : "false");
      const status = document.querySelector(`[data-setting-status="${key}"]`);
      if (status) {
        status.textContent = active ? "On" : "Off";
      }
    };

    const handleClick = (button) => {
      const key = button.dataset.setting;
      if (!key) {
        return;
      }
      state[key] = !state[key];
      persist();
      refreshButton(button);
    };

    const initialize = () => {
      document.querySelectorAll(buttonsSelector).forEach((button) => {
        refreshButton(button);
        button.addEventListener("click", () => handleClick(button));
      });
    };

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initialize);
    } else {
      initialize();
    }
  })();
</script>

</body>
</html>






      


