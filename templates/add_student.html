{% extends "base.html" %}
{% block title %}Add New Student - {{ APP_TITLE }}{% endblock %}
{% block page_title %}Add New Student{% endblock %}
{% block content %}

<div class="max-w-2xl mx-auto bg-white border border-gray-200 rounded-2xl shadow-sm p-8">
  <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
    <i data-lucide="user-plus" class="w-6 h-6 text-blue-600"></i>
    Add New Student
  </h2>

  <form id="addStudentForm" method="POST" class="space-y-6">
    <!-- Student Name -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
      <input type="text" name="name" required placeholder="Enter student's full name"
             class="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500 text-gray-800">
    </div>

    <!-- Admission Number -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Admission Number</label>
      <input type="text" name="admission_no" required placeholder="Enter admission number"
             class="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500 text-gray-800">
      <p id="admWarning" 
         class="text-red-600 text-sm mt-1 font-medium opacity-0 transition-opacity duration-300 ease-in-out">
        ⚠️ A student with this Admission Number already exists.
      </p>
    </div>

    <!-- Class Name -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Class</label>
      <input type="text" name="class_name" required placeholder="Current Class"
              class="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500 text-gray-800">
    </div>

    <!-- Phone Number -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number (for SMS)</label>
      <input type="tel" name="phone" placeholder="e.g. +2547XXXXXXXX or 0794XXXXXX"
             class="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500 text-gray-800">
      <p class="text-xs text-gray-500 mt-1">Enter guardian/student phone for reminders. Country code optional.</p>
    </div>

    <!-- Opening Balance for Current Year -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Opening Balance (KES)</label>
      <input type="number" name="total_fees" required step="0.01" min="0" value="0.00"
             class="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500 text-gray-800">
    </div>

    <!-- Buttons -->
    <div class="flex justify-between items-center pt-6 border-t border-gray-100">
      <a href="{{ url_for('students') }}"
         class="inline-flex items-center px-4 py-2 rounded-lg text-gray-700 hover:bg-gray-100 transition">
        ← Back to Students
      </a>

      <button id="submitBtn" type="submit"
              class="inline-flex items-center gap-2 px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg shadow-sm transition">
        <i data-lucide="plus-circle" class="w-5 h-5"></i> Add Student
      </button>
    </div>
  </form>
</div>

<!-- Success Toast -->
<div id="toast" class="fixed bottom-5 right-5 bg-green-600 text-white text-sm px-4 py-2 rounded-lg shadow-md hidden">
  ✅ Student added successfully!
</div>

<script>
if (typeof lucide !== 'undefined' && lucide.createIcons) lucide.createIcons();

document.getElementById('addStudentForm').addEventListener('submit', async function (e) {
  e.preventDefault();

  const formData = new FormData(this);
  const res = await fetch("{{ url_for('add_student') }}", {
    method: "POST",
    body: formData
  });

  if (res.redirected) {
    // Show toast
    const toast = document.getElementById('toast');
    toast.classList.remove('hidden');
    toast.classList.add('animate-bounce');
    setTimeout(() => toast.classList.add('hidden'), 2000);

    // Redirect to students list after success
    window.location.href = "{{ url_for('students') }}";
  }
});


// ---------- Real-time Duplicate Check (Admission No only) ----------
document.addEventListener("DOMContentLoaded", () => {
  const admInput = document.querySelector("input[name='admission_no']");
  const warning = document.getElementById("admWarning");
  const submitBtn = document.getElementById("submitBtn");

  async function checkDuplicate() {
    const adm = admInput.value.trim();
    if (!adm) {
      warning.style.opacity = "0";
      submitBtn.disabled = false;
      submitBtn.classList.remove("opacity-50", "cursor-not-allowed");
      return;
    }

    const res = await fetch(`/check_student_exists?admission_no=${encodeURIComponent(adm)}`);
    const data = await res.json();

    if (data.exists) {
      warning.style.opacity = "1";
      submitBtn.disabled = true;
      submitBtn.classList.add("opacity-50", "cursor-not-allowed");
    } else {
      warning.style.opacity = "0";
      submitBtn.disabled = false;
      submitBtn.classList.remove("opacity-50", "cursor-not-allowed");
    }
  }

  admInput.addEventListener("input", checkDuplicate);
});
</script>

{% endblock %}
