{% extends "base.html" %}
{% block title %}Payments - {{ APP_TITLE }}{% endblock %}
{% block page_title %}Record & Manage Payments{% endblock %}
{% block content %}

<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
  <!-- ADD PAYMENT FORM -->
  <div class="rounded-2xl border border-gray-100 shadow-xl bg-white/90 backdrop-blur-sm">
    <div class="px-6 pt-6">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
          <span class="inline-flex items-center justify-center w-9 h-9 rounded-xl text-white shadow-md"
                style="background: linear-gradient(135deg, #4338ca, #06b6d4)">
            <i data-lucide="wallet" class="w-4 h-4"></i>
          </span>
          <span>Add New Payment</span>
        </h3>
        <span class="text-xs text-gray-500">Secure • Instant update</span>
      </div>
    </div>

    <form id="add_payment_form" action="{{ url_for('payments') }}" method="POST" class="p-6 pt-4 space-y-5">
      <!-- Search Student -->
      <div class="relative">
        <label for="student_search" class="block text-sm font-medium text-gray-700 mb-1">Search Student</label>
        <div class="relative">
          <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4"></i>
          <input type="text" id="student_search" placeholder="Search by name or admission number..."
                 value="{% for s in students %}{% if selected_student_id == s.id %}{{ s.name }}{% endif %}{% endfor %}"
                 class="w-full border border-gray-300 rounded-xl pl-9 pr-3 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
          <button type="button" id="clear_student_search" class="absolute right-2 top-1/2 -translate-y-1/2 text-xs px-2 py-1 rounded-md border bg-white hover:bg-gray-50">Reset</button>
        </div>
        <input type="hidden" id="student_id" name="student_id" value="{{ selected_student_id or '' }}">
        <div id="search_results" class="hidden absolute w-full mt-2 bg-white border border-gray-200 rounded-xl shadow-xl max-h-60 overflow-y-auto z-20 text-sm"></div>
      </div>

      <!-- Amount -->
      <div>
        <label for="amount" class="block text-sm font-medium text-gray-700 mb-1">Amount (KES)</label>
        <div class="relative">
          <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm">KES</span>
          <input type="number" id="amount" name="amount" step="0.01" min="1" required
                 class="w-full border border-gray-300 rounded-xl pl-12 pr-3 py-2.5 text-sm focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" placeholder="0.00">
        </div>
      </div>

      <!-- Academic Context: Year & Term -->
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label for="year" class="block text-sm font-medium text-gray-700 mb-1">Academic Year</label>
          <input type="number" id="year" name="year" min="2000" max="2100" value="{{ CURRENT_YEAR or '' }}" required
                 class="w-full border border-gray-300 rounded-xl p-2.5 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
        </div>
        <div>
          <label for="term" class="block text-sm font-medium text-gray-700 mb-1">Term</label>
          <select id="term" name="term" required class="w-full border border-gray-300 rounded-xl p-2.5 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            <option value="">Select Term</option>
            <option value="1" {% if (CURRENT_TERM or 0) == 1 %}selected{% endif %}>Term 1</option>
            <option value="2" {% if (CURRENT_TERM or 0) == 2 %}selected{% endif %}>Term 2</option>
            <option value="3" {% if (CURRENT_TERM or 0) == 3 %}selected{% endif %}>Term 3</option>
          </select>
        </div>
      </div>

      <!-- Overpay handling -->
      <div class="flex items-start gap-3 p-3 rounded-xl bg-indigo-50/60 border border-indigo-100">
        <input type="checkbox" id="carry_overpay" name="carry_overpay" value="1" class="mt-1">
        <label for="carry_overpay" class="text-sm text-gray-700">
          Carry any overpay into the <strong>next term</strong> automatically
          <span class="block text-xs text-gray-500">When checked and amount exceeds the outstanding balance, the extra will be recorded as a payment in the next term (instead of credit).</span>
        </label>
      </div>

      <!-- Method (Segmented) -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Method</label>
        <div class="grid grid-cols-2 gap-2 sm:grid-cols-4" id="method_segment">
          {% set methods = [
            {'label': 'Cash', 'icon': 'coins', 'grad': 'from-amber-500 to-yellow-500'},
            {'label': 'M-Pesa', 'icon': 'smartphone', 'grad': 'from-emerald-500 to-teal-500', 'asset': 'images/mpesa_logo.svg'},
            {'label': 'Bank Transfer', 'icon': 'bank', 'grad': 'from-indigo-500 to-blue-500'},
            {'label': 'Cheque', 'icon': 'receipt', 'grad': 'from-cyan-500 to-sky-500'},
          ] %}
          {% for method in methods %}
          <button type="button" data-value="{{ method.label }}"
                  class="seg-btn group w-full rounded-xl border border-gray-200 bg-white hover:border-indigo-300 hover:bg-indigo-50/50 transition p-2.5 flex items-center justify-center gap-2">
            <span class="inline-flex items-center justify-center w-8 h-8 rounded-lg text-white shadow"
                  style="background-image: linear-gradient(135deg, var(--brand-grad-from), var(--brand-grad-to))">
              {% if method.asset %}
                <img src="{{ url_for('static', filename=method.asset) }}" alt="{{ method.label }} logo" class="h-4 w-auto" />
              {% else %}
                <i data-lucide="{{ method.icon }}" class="w-4 h-4"></i>
              {% endif %}
            </span>
            <span class="text-sm text-gray-700 font-medium">{{ method.label }}</span>
          </button>
          {% endfor %}
        </div>
        <select id="method" name="method" required class="hidden">
          <option value="">Select Method</option>
          <option value="Cash">Cash</option>
          <option value="M-Pesa">M-Pesa</option>
          <option value="Bank Transfer">Bank Transfer</option>
          <option value="Cheque">Cheque</option>
        </select>
      </div>

      <!-- Reference -->
      <div>
        <div class="flex items-center justify-between mb-1">
          <label for="reference" class="block text-sm font-medium text-gray-700">Reference</label>
          <span class="text-[11px] text-gray-500">Optional</span>
        </div>
        <input type="text" id="reference" name="reference" placeholder="Receipt/Transaction ID"
               class="w-full border border-gray-300 rounded-xl p-2.5 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
      </div>

      <!-- Buttons -->
      <div class="flex items-center justify-end gap-3 pt-2">
        <button type="reset" class="px-4 py-2 text-sm rounded-xl border border-gray-300 text-gray-700 hover:bg-gray-100 transition">Clear</button>
        <button type="submit" class="px-5 py-2.5 rounded-xl text-white text-sm font-semibold btn-primary shadow-md">
          <span class="inline-flex items-center gap-2"><i data-lucide="check-circle" class="w-4 h-4"></i> Save Payment</span>
        </button>
      </div>
    </form>
  </div>

  <!-- PAYMENT HISTORY -->
  <div class="rounded-2xl border border-gray-100 shadow-xl bg-white/90 backdrop-blur-sm p-6">
    <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between mb-3">
      <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
        <span class="inline-flex items-center justify-center w-9 h-9 rounded-xl text-white shadow-md"
              style="background: linear-gradient(135deg, #10b981, #22c55e)">
          <i data-lucide="list" class="w-4 h-4"></i>
        </span>
        <span>Recent Payments</span>
      </h3>

      <div class="flex items-center gap-2">
        <div class="relative hidden sm:block">
          <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
          <input id="table_search" type="text" placeholder="Filter payments..." class="pl-9 pr-3 py-2 text-sm rounded-xl border border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
          <button type="button" id="clear_table_search" class="absolute right-2 top-1/2 -translate-y-1/2 text-xs px-2 py-1 rounded-md border bg-white hover:bg-gray-50">Reset</button>
        </div>
        <a href="{{ url_for('export_payments') }}" 
           class="inline-flex items-center gap-2 px-4 py-2 rounded-xl text-white text-sm font-medium bg-gradient-to-r from-green-600 to-green-500 hover:from-green-700 hover:to-green-600 shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition">
          <i data-lucide="download" class="w-4 h-4"></i> Export CSV
        </a>
      </div>
    </div>

      <div class="overflow-x-auto">
        {% set method_icons = {'Cash': 'coins', 'Bank Transfer': 'bank', 'Cheque': 'receipt'} %}
        <table class="min-w-full border border-gray-200 text-sm rounded-xl overflow-hidden">
        <thead class="bg-gray-50 sticky top-0">
          <tr>
            <th class="px-4 py-2 text-left font-medium text-gray-700 border-b">#</th>
            <th class="px-4 py-2 text-left font-medium text-gray-700 border-b">Student</th>
            <th class="px-4 py-2 text-left font-medium text-gray-700 border-b">Year</th>
            <th class="px-4 py-2 text-left font-medium text-gray-700 border-b">Term</th>
            <th class="px-4 py-2 text-left font-medium text-gray-700 border-b">Amount</th>
            <th class="px-4 py-2 text-left font-medium text-gray-700 border-b">Method</th>
            <th class="px-4 py-2 text-left font-medium text-gray-700 border-b">Date</th>
            <th class="px-4 py-2 text-left font-medium text-gray-700 border-b">Actions</th>
          </tr>
        </thead>
        <tbody id="payments_body">
          {% for p in payments %}
          {% set method = (p.method or 'N/A') %}
          {% set badge = 'bg-gray-100 text-gray-700' %}
          {% if method == 'Cash' %}{% set badge = 'bg-amber-100 text-amber-700 border-amber-200' %}{% endif %}
          {% if method == 'M-Pesa' %}{% set badge = 'bg-emerald-100 text-emerald-700 border-emerald-200' %}{% endif %}
          {% if method == 'Bank Transfer' %}{% set badge = 'bg-indigo-100 text-indigo-700 border-indigo-200' %}{% endif %}
          {% if method == 'Cheque' %}{% set badge = 'bg-sky-100 text-sky-700 border-sky-200' %}{% endif %}
          <tr class="hover:bg-gray-50 transition" data-student="{{ (p.student_name or '')|lower }}" data-method="{{ method|lower }}">
            <td class="px-4 py-2 border-b">{{ loop.index }}</td>
            <td class="px-4 py-2 border-b font-medium text-gray-800">{{ p.student_name }}</td>
            <td class="px-4 py-2 border-b text-gray-600">{{ p.year or '—' }}</td>
            <td class="px-4 py-2 border-b text-gray-600">{{ p.term or '—' }}</td>
            <td class="px-4 py-2 border-b text-green-700 font-semibold">
              KES {{ "{:,.2f}".format(p.amount or 0) }}
            </td>
            <td class="px-4 py-2 border-b">
              <span class="inline-flex items-center gap-1.5 text-xs px-2 py-1 rounded-full border {{ badge }}">
                {% if method == 'M-Pesa' %}
                  <img src="{{ url_for('static', filename='images/mpesa_logo.svg') }}" alt="M-Pesa" class="h-4 w-auto" />
                {% else %}
                  <i data-lucide="{{ method_icons.get(method, 'credit-card') }}" class="w-3.5 h-3.5"></i>
                {% endif %}
                {{ method }}
              </span>
            </td>
            <td class="px-4 py-2 border-b text-gray-600">
              {% if p.date %}
                {% if p.date.__class__.__name__ == "str" %}
                  {{ p.date }}
                {% else %}
                  {{ p.date.strftime("%Y-%m-%d %H:%M") }}
                {% endif %}
              {% else %}
                —
              {% endif %}
            </td>
            <td class="px-4 py-2 border-b">
              <a href="{{ url_for('payment_receipt', payment_id=p.id) }}" target="_blank" class="inline-flex items-center gap-1 text-indigo-600 hover:underline mr-3">
                <i data-lucide="printer" class="w-4 h-4"></i>
                Print
              </a>
              <a href="{{ url_for('payment_receipt_pdf', payment_id=p.id) }}" class="inline-flex items-center gap-1 text-emerald-600 hover:underline">
                <i data-lucide="download" class="w-4 h-4"></i>
                Download PDF
              </a>
              <form method="post" action="{{ url_for('delete_payment', payment_id=p.id) }}" class="inline ml-3">
                <button type="submit" class="inline-flex items-center gap-1 text-red-600 hover:underline text-xs" onclick="return confirm('Delete this payment?');">
                  <i data-lucide="trash-2" class="w-4 h-4"></i>
                  Delete
                </button>
              </form>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="6" class="text-center text-gray-500 py-10">
              <div class="flex flex-col items-center gap-2">
                <span class="inline-flex items-center justify-center w-12 h-12 rounded-2xl bg-gray-100 text-gray-500"><i data-lucide="inbox"></i></span>
                <div class="text-sm">No payments recorded yet.</div>
                <a href="#" onclick="document.getElementById('student_search').focus(); return false;" class="text-indigo-600 text-sm hover:underline">Add your first payment</a>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
// Ensure icons render
lucide.createIcons();

// Student search with live results + method segmented control + table filter
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("add_payment_form");
  const searchInput = document.getElementById("student_search");
  const searchResults = document.getElementById("search_results");
  const studentIdInput = document.getElementById("student_id");
  const clearStudentBtn = document.getElementById("clear_student_search");
  const seg = document.getElementById("method_segment");
  const methodSelect = document.getElementById("method");
  const tableSearch = document.getElementById("table_search");
  const tableBody = document.getElementById("payments_body");
  const clearTableBtn = document.getElementById("clear_table_search");

  let searchTimeout = null;

  function hideResults() { searchResults.classList.add("hidden"); }

  // Prefill segmented control if a method is already chosen
  if (methodSelect && methodSelect.value) {
    [...seg.querySelectorAll('.seg-btn')].forEach(btn => {
      if (btn.dataset.value === methodSelect.value) btn.classList.add('ring-2','ring-indigo-500','bg-indigo-50');
    });
  }

  // Segmented control behavior
  seg?.addEventListener('click', (e) => {
    const btn = e.target.closest('.seg-btn');
    if (!btn) return;
    seg.querySelectorAll('.seg-btn').forEach(b => b.classList.remove('ring-2','ring-indigo-500','bg-indigo-50'));
    btn.classList.add('ring-2','ring-indigo-500','bg-indigo-50');
    methodSelect.value = btn.dataset.value;
  });

  // Live student search
  searchInput.addEventListener("input", () => {
    clearTimeout(searchTimeout);
    const query = searchInput.value.trim();
    if (!query) { hideResults(); return; }

    searchTimeout = setTimeout(() => {
      fetch(`/search_student?query=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
          if (!Array.isArray(data) || data.length === 0) {
            searchResults.innerHTML = "<p class='p-3 text-gray-500'>No students found.</p>";
          } else {
            searchResults.innerHTML = data.map(s => `
              <div class="p-3 hover:bg-indigo-50 cursor-pointer border-b border-gray-100" data-id="${s.id}" data-name="${s.name}">
                <div class="flex justify-between items-center">
                  <p class="font-medium text-gray-800">${s.name}</p>
                  <span class="text-xs px-2 py-0.5 rounded-full ${parseFloat(s.balance || s.fee_balance || 0) > 0 ? 'bg-red-100 text-red-600' : 'bg-emerald-100 text-emerald-600'}">
                    Bal: KES ${parseFloat(s.balance || s.fee_balance || 0).toFixed(2)}
                  </span>
                </div>
                <p class="text-gray-500 text-xs">Adm: ${s.admission_no || 'N/A'} • ${s.class_name || 'N/A'}</p>
              </div>
            `).join("");
          }
          searchResults.classList.remove("hidden");
          lucide.createIcons();
        })
        .catch(() => { searchResults.innerHTML = "<p class='p-3 text-gray-500'>No students found.</p>"; searchResults.classList.remove("hidden"); });
    }, 250);
  });

  searchResults.addEventListener("click", (e) => {
    const item = e.target.closest("[data-id]");
    if (item) {
      searchInput.value = item.dataset.name;
      studentIdInput.value = item.dataset.id;
      hideResults();
    }
  });

  document.addEventListener("click", (e) => {
    if (!searchResults.contains(e.target) && e.target !== searchInput) hideResults();
  });

  clearStudentBtn?.addEventListener('click', () => {
    searchInput.value = '';
    studentIdInput.value = '';
    hideResults();
  });

  form.addEventListener("submit", (e) => {
    if (!studentIdInput.value) {
      e.preventDefault();
      searchInput.focus();
      alert("Please select a student from search results.");
      return;
    }
    if (!methodSelect.value) {
      e.preventDefault();
      alert("Please choose a payment method.");
    }
  });

  // Client-side table filter
  tableSearch?.addEventListener('input', () => {
    const q = (tableSearch.value || '').toLowerCase();
    const rows = tableBody?.querySelectorAll('tr') || [];
    rows.forEach(row => {
      const hay = `${row.dataset.student} ${row.dataset.method}`;
      row.style.display = hay.includes(q) ? '' : 'none';
    });
  });
  clearTableBtn?.addEventListener('click', () => {
    tableSearch.value = '';
    const rows = tableBody?.querySelectorAll('tr') || [];
    rows.forEach(row => row.style.display = '');
  });

  // Subtle toast for portal payments
  const toast = document.createElement('div');
  toast.style.position = 'fixed';
  toast.style.right = '16px';
  toast.style.bottom = '16px';
  toast.style.zIndex = '50';
  toast.style.display = 'none';
  toast.innerHTML = '<div id="portalToast" class="px-4 py-2 rounded-lg shadow-md border border-emerald-200 bg-white text-sm text-emerald-700">New portal payment recorded.</div>';
  document.body.appendChild(toast);

  function showPortalToast(text){
    const el = document.getElementById('portalToast');
    if(!el) return;
    el.textContent = text || 'New portal payment recorded.';
    toast.style.display = 'block';
    setTimeout(()=>{ toast.style.display = 'none'; }, 4000);
  }

  async function pollPortal(){
    try{
      const r = await fetch('/portal/latest');
      const j = await r.json();
      if(j && j.ok && j.found && j.updated_at){
        const key = 'portal_latest_seen';
        const prev = localStorage.getItem(key) || '';
        if(j.updated_at > prev){
          localStorage.setItem(key, j.updated_at);
          showPortalToast('Portal payment posted. Refresh to see it.');
        }
      }
    }catch(_){ }
    setTimeout(pollPortal, 15000);
  }
  setTimeout(pollPortal, 8000);
});
</script>

{% endblock %}
