<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Parent Dashboard - {{ APP_TITLE }}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" integrity="sha384-G5yRvCNrI6VOGGAaHo9dZYkTfGZNVVRhk1FdYyqS/fWznuaCG2lLBVmOAXoJ1V8L" crossorigin="anonymous"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
  <link rel="icon" href="{{ url_for('static', filename=FAVICON) }}" type="image/jpeg">
</head>
<body class="min-h-screen bg-[var(--bg-app)] text-[var(--text)]">
  <header class="sticky top-0 z-10 bg-white/90 backdrop-blur border-b border-gray-100">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="brand-hero__row">
        <div class="app-badge">
          <img src="{{ url_for('static', filename=LOGO_PRIMARY) }}" alt="{{ BRAND_NAME }}"/>
        </div>
        <div class="leading-tight">
          <div class="brand-title text-2xl md:text-3xl">{{ BRAND_NAME }}</div>
          <div class="brand-subtitle text-xs">Parent / Guardian Portal</div>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <button id="openMenu" class="md:hidden p-2 rounded-lg border border-gray-200 bg-white text-gray-700 flex items-center gap-1"><i data-lucide="menu"></i> Menu</button>
        <a href="{{ url_for('guardian.guardian_logout') }}" class="text-sm text-gray-600 hover:text-gray-900 flex items-center gap-1"><i data-lucide="log-out"></i> Logout</a>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 grid md:grid-cols-[240px,1fr] gap-6">
    <!-- Sidebar: Guardian profile + children selector -->
    <aside id="side" class="hidden md:block glass rounded-2xl p-5 border border-gray-100 h-fit md:relative md:translate-x-0 md:shadow-none fixed top-0 left-0 w-64 h-full bg-white z-40 shadow-xl translate-x-[-120%] transition-transform">
      <div class="flex items-center gap-3 mb-4">
        <div class="kpi__icon" style="width:40px;height:40px"><i data-lucide="users"></i></div>
        <div>
          <div class="text-sm text-gray-500">Signed in as</div>
          <div class="font-semibold">Parent / Guardian</div>
        </div>
      </div>
      <div class="text-xs text-gray-500 mb-2">Children</div>
      <ul class="space-y-1">
        <li class="text-sm">
          <a href="{{ url_for('guardian.guardian_dashboard', token=token) }}" class="text-indigo-700 hover:underline">{{ student.name }}</a>
        </li>
        {% for s in siblings %}
        <li class="text-sm">
          <a href="#" data-id="{{ s.id }}" class="sib-link text-indigo-700 hover:underline">{{ s.name }}</a>
        </li>
        {% endfor %}
      </ul>
      <div class="mt-6 rounded-2xl border border-gray-100 bg-white/90 p-4 shadow-sm space-y-3">
        <div class="flex items-center gap-2 text-xs uppercase tracking-[0.4em] text-gray-400">
          <i data-lucide="sparkles" class="w-4 h-4 text-emerald-500"></i>
          Family inspiration
        </div>
        <p id="quoteText" class="text-sm text-gray-600 leading-relaxed" aria-live="polite"></p>
        <div class="h-1 w-full rounded-full bg-gray-200 overflow-hidden">
          <div id="quoteProgress" class="h-1 bg-gradient-to-r from-emerald-500 to-cyan-500"></div>
        </div>
      </div>
    </aside>
    <div id="overlay" class="fixed inset-0 bg-black/30 z-30 hidden md:hidden"></div>
    <section class="space-y-6">
      <div class="glass rounded-2xl p-5 border border-gray-100">
        <div class="flex items-start justify-between">
          <div>
            <div class="text-xs text-gray-500">Student</div>
            <div class="text-xl font-bold">{{ student.name }}</div>
            <div class="text-sm text-gray-500">SmartEduPay Enterprise EDU_PAY: {{ student.regNo }} · Class: {{ student.class or student.class_name or '-' }}</div>
            <div class="text-xs text-gray-500">Year/Term: {{ year }}/{{ term }}</div>
          </div>
          <div class="kpi__icon" aria-hidden="true"><i data-lucide="id-card"></i></div>
        </div>
        <div class="mt-4">
          {% if percent is not none %}
          <div class="mb-1 text-xs text-gray-600">Term progress: {{ percent }}%</div>
          <div class="w-full h-2 rounded-full bg-gray-200 overflow-hidden">
            <div class="h-2 bg-gradient-to-r from-blue-600 to-indigo-600" style="width: {{ percent }}%"></div>
          </div>
          {% endif %}
        </div>
      </div>
    <section class="glass rounded-2xl p-6 border border-gray-100 space-y-5">
      <div class="grid gap-6 lg:grid-cols-[320px,1fr]">
        <div class="rounded-2xl p-5 bg-gradient-to-br from-emerald-500 via-emerald-500 to-cyan-500 text-white overflow-hidden relative">
          <div class="flex items-center gap-4">
            <div class="h-16 w-16 rounded-2xl bg-white/15 backdrop-blur flex items-center justify-center text-2xl font-bold tracking-wider">{{ ((student.name or 'Child')[:2])|upper }}</div>
            <div>
              <div class="text-xs uppercase tracking-[0.4em] text-white/70">Child record</div>
              <div class="text-2xl font-semibold">{{ student.name }}</div>
              <div class="text-sm text-white/70">{{ student.class or student.class_name or 'Class TBD' }} · Adm No: {{ student.admission_no or student.regNo or '—' }}</div>
            </div>
          </div>
          <div class="mt-4 grid grid-cols-2 gap-3 text-sm">
            <div class="rounded-2xl bg-white/20 p-3">
              <div class="text-[0.65rem] uppercase tracking-[0.4em] text-white/70">Year/term</div>
              <div class="text-lg font-semibold">{{ year }}/{{ term }}</div>
            </div>
            <div class="rounded-2xl bg-white/20 p-3">
              <div class="text-[0.65rem] uppercase tracking-[0.4em] text-white/70">Balance</div>
              <div class="text-lg font-semibold">Ksh {{ '%.0f'|format(balance or 0) }}</div>
            </div>
          </div>
          <div class="mt-4">
            <div class="text-[0.65rem] uppercase tracking-[0.4em] text-white/70">Family roster</div>
            <div class="flex items-end gap-2 text-sm">
              <span class="text-lg font-semibold">{{ (siblings|length) + 1 }} child{% if (siblings|length) + 1 != 1 %}ren{% endif %}</span>
              <span class="text-white/70">connected</span>
            </div>
            {% if percent is not none %}
            <div class="mt-3 h-2 rounded-full bg-white/20">
              <div class="h-2 rounded-full bg-white" style="width: {{ percent|default(0) }}%"></div>
            </div>
            {% endif %}
          </div>
        </div>
        <div class="grid gap-4">
          <div class="rounded-2xl border border-gray-100 bg-white/80 p-4 shadow-sm">
            <div class="flex items-center justify-between">
              <div class="text-xs uppercase tracking-[0.3em] text-gray-500">Financial health</div>
              <div class="text-xs font-semibold text-emerald-600">{{ balance and 'Due now' or 'On track' }}</div>
            </div>
            <div class="mt-4 grid grid-cols-3 gap-3 text-sm text-gray-600">
              <div class="space-y-1">
                <div class="text-[0.65rem] uppercase tracking-[0.3em]">Paid</div>
                <div class="text-lg font-semibold text-emerald-600">Ksh {{ '%.0f'|format(paid or 0) }}</div>
              </div>
              <div class="space-y-1">
                <div class="text-[0.65rem] uppercase tracking-[0.3em]">Balance</div>
                <div class="text-lg font-semibold text-rose-600">Ksh {{ '%.0f'|format(balance or 0) }}</div>
              </div>
              <div class="space-y-1">
                <div class="text-[0.65rem] uppercase tracking-[0.3em]">Progress</div>
                <div class="text-lg font-semibold text-gray-800">{{ percent is not none and percent ~ '%' or '—' }}</div>
              </div>
            </div>
            <p class="mt-4 text-xs text-gray-500">
              {% if balance and balance > 0 %}
                Settle the outstanding balance to keep the ledger updated instantly.
              {% else %}
                All clear for this term. New invoices appear here as soon as they are posted.
              {% endif %}
            </p>
          </div>
          <div class="rounded-2xl border border-gray-100 bg-white/80 p-4 shadow-sm">
            <div class="text-xs uppercase tracking-[0.3em] text-gray-500">School support hub</div>
            <div class="mt-3 text-sm text-gray-600 space-y-2">
              <div class="flex items-center justify-between">
                <span>Accounts email</span>
                <span class="font-semibold text-gray-900">{{ bursar_email or 'Not provided' }}</span>
              </div>
              <div class="flex items-center justify-between">
                <span>Accounts phone</span>
                <span class="font-semibold text-gray-900">{{ bursar_phone or 'Not provided' }}</span>
              </div>
            </div>
            <div class="mt-3 flex flex-wrap gap-2">
              {% if bursar_email %}
              <a href="mailto:{{ bursar_email }}" class="btn-secondary px-3 py-2 text-xs rounded-xl">Email bursar</a>
              {% endif %}
              {% if bursar_phone %}
              <a href="tel:{{ bursar_phone }}" class="btn-secondary px-3 py-2 text-xs rounded-xl">Call bursar</a>
              {% endif %}
              <a href="#aiForm" class="btn-secondary px-3 py-2 text-xs rounded-xl">Ask SmartBot</a>
            </div>
          </div>
          <div class="rounded-2xl border border-gray-100 bg-white/80 p-4 shadow-sm">
            <div class="text-xs uppercase tracking-[0.3em] text-gray-500">Sibling focus</div>
            <div class="mt-3 space-y-2 text-sm">
              {% if siblings %}
                {% for s in siblings %}
                <div class="grid grid-cols-[1fr,auto] items-center gap-2">
                  <div class="text-gray-700 font-medium">{{ s.name }}</div>
                  <div class="text-xs text-gray-500">Class {{ s.class_name or 'n/a' }}</div>
                </div>
                {% endfor %}
              {% else %}
                <p class="text-gray-500">No other family members registered yet.</p>
              {% endif %}
            </div>
          </div>
          <div class="rounded-2xl border border-gray-100 bg-white/80 p-4 shadow-sm">
            <div class="text-xs uppercase tracking-[0.3em] text-gray-500">Quick actions</div>
            <div class="mt-3 space-y-2 text-sm">
              <a href="{{ url_for('student_portal.statement_pdf', token=token) }}" class="flex items-center justify-between rounded-lg border border-gray-200 px-3 py-2 hover:bg-gray-50">
                <span>Download latest statement</span>
                <i data-lucide="download" class="text-sm text-gray-500"></i>
              </a>
              <a href="#recent-payments" class="flex items-center justify-between rounded-lg border border-gray-200 px-3 py-2 hover:bg-gray-50">
                <span>Review recent receipts</span>
                <i data-lucide="list-check" class="text-sm text-gray-500"></i>
              </a>
              <a href="#guardian-analytics" class="flex items-center justify-between rounded-lg border border-gray-200 px-3 py-2 hover:bg-gray-50">
                <span>See spending analytics</span>
                <i data-lucide="bar-chart-2" class="text-sm text-gray-500"></i>
              </a>
            </div>
          </div>
        </div>
      </div>
    </section>
    <section class="glass rounded-2xl p-5 border border-gray-100">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Child Journey Board</h3>
        <span class="text-xs text-gray-500">Everything you need at a glance</span>
      </div>
      <div class="grid gap-4 lg:grid-cols-2">
        <div id="recent-payments" class="rounded-2xl border border-gray-100 bg-white/80 p-4 space-y-3 text-sm text-gray-600">
          <div class="text-xs uppercase tracking-[0.3em] text-gray-500">Latest ledger hits</div>
          {% for p in payments[:3] %}
          <div class="flex flex-col gap-1 border-b border-gray-100 pb-2 last:border-0 last:pb-0">
            <div class="flex items-center justify-between text-gray-900 font-semibold">
              <span>{{ p.date }}</span>
              <span class="text-xs text-gray-500">{{ p.method or 'M-Pesa' }}</span>
            </div>
            <div class="flex items-center justify-between text-sm">
              <span>Ref {{ p.reference or '—' }}</span>
              <span class="font-semibold">KES {{ '%.0f'|format(p.amount or 0) }}</span>
            </div>
          </div>
          {% else %}
          <p class="text-xs text-gray-500">No payments recorded yet. Use the Pay Now card above to initiate a new checkout.</p>
          {% endfor %}
        </div>
        <div class="rounded-2xl border border-gray-100 bg-white/80 p-4 space-y-3 text-sm text-gray-600">
          <div class="text-xs uppercase tracking-[0.3em] text-gray-500">Upcoming tasks & updates</div>
          {% for note in announcements[:3] %}
          <div class="flex items-start gap-3">
            <div class="w-2 h-2 mt-1 rounded-full bg-emerald-500"></div>
            <div>
              <div class="font-semibold text-gray-900">{{ note.title or note.subject or 'Update' }}</div>
              <p class="text-xs text-gray-500">{{ note.category|default('notice') }} · {{ note.created_at }}</p>
            </div>
          </div>
          {% else %}
          <p class="text-xs text-gray-500">No announcements yet. The school will post timely notices and deadlines here.</p>
          {% endfor %}
        </div>
      </div>
    </section>
    <section class="glass rounded-2xl p-5 border border-gray-100">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Parent Playbook</h3>
        <span class="text-xs text-gray-500">Tips to make every term smoother</span>
      </div>
      <div class="grid gap-4 md:grid-cols-3 text-sm text-gray-600">
        <div class="rounded-2xl border border-gray-100 bg-white/80 p-3 space-y-2">
          <div class="text-xs uppercase tracking-[0.3em] text-gray-500">Stay informed</div>
          <p class="text-gray-800 font-semibold">Turn on SMS/email alerts</p>
          <p class="text-xs text-gray-500">Enable WhatsApp or email reminders so we ping you when invoices are posted or receipts are available.</p>
        </div>
        <div class="rounded-2xl border border-gray-100 bg-white/80 p-3 space-y-2">
          <div class="text-xs uppercase tracking-[0.3em] text-gray-500">Track progress</div>
          <p class="text-gray-800 font-semibold">Use Smart summary</p>
          <p class="text-xs text-gray-500">The Smart summary above tallies fee completion; refresh after each payment to keep the percentage current.</p>
        </div>
        <div class="rounded-2xl border border-gray-100 bg-white/80 p-3 space-y-2">
          <div class="text-xs uppercase tracking-[0.3em] text-gray-500">Ask SmartBot</div>
          <p class="text-gray-800 font-semibold">Questions? Ask away</p>
          <p class="text-xs text-gray-500">Use the SmartEduPay SmartBot (top of the page) to ask anything about balances, invoices, or receipts—no queue, instant replies.</p>
        </div>
      </div>
      <div class="mt-4 text-xs text-gray-500 space-y-2">
        <p class="flex items-center gap-2"><i data-lucide="check-circle" class="text-emerald-500"></i> Keep admission and class details up to date with the school office so the portal reflects the right child.</p>
        <p class="flex items-center gap-2"><i data-lucide="shield" class="text-sky-500"></i> Log out after use and never share your token so your child’s fee information stays safe.</p>
        <p class="flex items-center gap-2"><i data-lucide="clock-3" class="text-indigo-500"></i> Pay at your convenience—the balance card shows exactly what is overdue and automatically posts once Daraja confirms.</p>
      </div>
    </section>
    <div class="glass rounded-2xl p-5 border border-gray-100">
      <div class="flex items-center gap-3 mb-4">
        <img src="{{ url_for('static', filename='images/mpesa_logo.svg') }}" alt="M-Pesa" class="h-9 w-auto object-contain">
        <div>
          <div class="text-[0.65rem] uppercase tracking-[0.4em] text-gray-500">Pay via</div>
          <div class="text-xl font-semibold text-gray-800">M-Pesa</div>
        </div>
      </div>
      <div class="grid grid-cols-3 gap-4 text-center">
        <div>
          <div class="text-xs text-gray-500">Total Fee</div>
          <div class="text-lg font-semibold">Ksh {{ '%.0f'|format(expected or 0) }}</div>
        </div>
          <div>
            <div class="text-xs text-gray-500">Paid</div>
            <div class="text-lg font-semibold text-emerald-600">Ksh {{ '%.0f'|format(paid or 0) }}</div>
          </div>
          <div>
            <div class="text-xs text-gray-500">Balance</div>
            <div class="text-lg font-semibold text-rose-600">Ksh {{ '%.0f'|format(balance or 0) }}</div>
          </div>
        </div>
        <div class="mt-3 text-xs text-gray-500">
          {% if balance and balance > 0 %}
          <span class="font-semibold text-rose-600">Overdue: Ksh {{ '{:,.2f}'.format(balance) }}</span> · Pay this amount to record it against the student fee ledger.
          {% else %}
          <span class="font-semibold text-emerald-600">No outstanding balance.</span> Payments appear on the fee record immediately after Daraja confirms.
          {% endif %}
        </div>
        <form id="payForm" class="mt-4 grid md:grid-cols-3 gap-3 items-end">
          <input type="hidden" name="token" value="{{ token }}" />
          <div>
            <label class="text-xs text-gray-600">Phone Number (M‑Pesa)</label>
            <input name="phone" placeholder="07xx..." class="w-full mt-1 px-3 py-2.5 border rounded-lg"/>
          </div>
          <div>
            <label class="text-xs text-gray-600 flex items-center justify-between">
              <span>Amount (KES)</span>
              <button type="button" id="fillFull" class="text-[11px] text-indigo-700 hover:underline">Use full balance</button>
            </label>
            <input name="amount" type="number" min="1" step="1" placeholder="e.g. 500" class="w-full mt-1 px-3 py-2.5 border rounded-lg"/>
          </div>
          <button type="submit" class="btn-primary rounded-xl px-4 py-2.5 text-sm font-semibold flex items-center justify-center gap-2"><i data-lucide="smartphone"></i> Pay Now with M-Pesa</button>
        </form>
        <div id="payMsg" class="text-sm mt-2"></div>
        <div id="payTrackWrapper" class="hidden mt-2 flex items-center gap-2 text-xs text-gray-600">
          <span id="payTrack"></span>
          <button type="button" id="payTrackCancel" class="hidden text-[11px] text-rose-600 hover:text-rose-900 focus:outline-none focus:underline">Cancel</button>
        </div>
        {% if paypal_client_id %}
        <div class="mt-4">
          <div class="text-xs text-gray-500 mb-1">Or pay securely with PayPal</div>
          <div id="paypal-button-container"></div>
        </div>
        {% endif %}
        <div class="mt-4 flex items-center justify-between gap-3 flex-wrap">
          <div class="text-xs text-gray-500">Need help? {% if bursar_phone %}Call {{ bursar_phone }}{% endif %}{% if bursar_email %} or email {{ bursar_email }}{% endif %}.</div>
          <div class="flex items-center gap-2">
            <a href="{{ url_for('student_portal.statement_pdf', token=token) }}" class="btn-secondary rounded-xl px-3 py-2 text-sm flex items-center gap-2"><i data-lucide="download"></i> Download Statement</a>
          </div>
        </div>
      </div>
    </section>

    <section class="glass rounded-2xl p-5 border border-gray-100">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Recent Payments</h3>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left text-gray-500">
              <th class="py-2">Date</th>
              <th class="py-2">Reference</th>
              <th class="py-2">Method</th>
              <th class="py-2">Status</th>
              <th class="py-2 text-right">Amount (KES)</th>
              <th class="py-2 text-right">Receipt</th>
            </tr>
          </thead>
          <tbody>
            {% for p in payments %}
            <tr class="border-t border-gray-100">
              <td class="py-2">{{ p.date }}</td>
              <td class="py-2">{{ p.reference or '-' }}</td>
              <td class="py-2">{{ p.method or 'M-Pesa' }}</td>
              <td class="py-2">
                <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-50 text-emerald-700 border border-emerald-200"><i data-lucide="check-circle" class="w-3.5 h-3.5"></i> Success</span>
              </td>
              <td class="py-2 text-right">{{ '%.0f'|format(p.amount or 0) }}</td>
              <td class="py-2 text-right text-indigo-700"><a href="{{ url_for('guardian.guardian_receipt', payment_id=p.id, token=token) }}" class="hover:underline">Print</a></td>
            </tr>
            {% else %}
            <tr class="border-t border-gray-100 text-gray-500"><td colspan="4" class="py-4 text-center">No payments yet.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <!-- Premium: Spending Analytics -->
    <section id="guardian-analytics" class="glass rounded-2xl p-5 border border-gray-100 guardian-analytics-panel">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Spending Analytics</h3>
        <div class="text-xs text-gray-500" id="termSummary"></div>
      </div>
      <div class="grid gap-4 lg:grid-cols-[1.4fr,0.6fr]">
        <div>
          <canvas id="payChart" height="140"></canvas>
          <div id="payMsg" class="text-xs text-gray-300 mt-2"></div>
        </div>
        <div class="guardian-analytics-metrics grid gap-3">
          <div class="guardian-analytics-metric">
            <p class="text-[0.65rem] uppercase tracking-[0.4em]">Paid term</p>
            <p class="text-xl font-semibold text-slate-900">KES {{ '{:,.0f}'.format(paid or 0) }}</p>
          </div>
          <div class="guardian-analytics-metric">
            <p class="text-[0.65rem] uppercase tracking-[0.4em]">Balance</p>
            <p class="text-xl font-semibold text-slate-900">KES {{ '{:,.0f}'.format(balance or 0) }}</p>
          </div>
          <div class="guardian-analytics-metric">
            <p class="text-[0.65rem] uppercase tracking-[0.4em]">Progress</p>
            <p class="text-xl font-semibold text-slate-900">{{ percent or 0 }}%</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Premium: Notices & Announcements -->
    <section class="glass rounded-2xl p-5 border border-gray-100">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Notices & Announcements</h3>
        <div class="text-xs text-gray-500">Latest updates</div>
      </div>
      <div class="space-y-3">
        {% for n in announcements %}
          <div class="p-3 rounded-xl border border-gray-100 bg-white/70">
            <div class="text-sm font-medium">{{ n.title or n.subject }}</div>
            <div class="text-xs text-gray-500">{{ n.category|default('notice') }} • {{ n.created_at }}</div>
          </div>
        {% else %}
          <div class="text-sm text-gray-500">No announcements yet.</div>
        {% endfor %}
      </div>
    </section>

    <!-- Premium: Message the School -->
    <section class="glass rounded-2xl p-5 border border-gray-100">
      <h3 class="text-lg font-semibold mb-3">Message the School</h3>
      <form id="msgForm" class="grid md:grid-cols-2 gap-3">
        <input type="hidden" name="token" value="{{ token }}" />
        <input class="border border-gray-200 rounded-xl p-2.5 text-sm" name="name" placeholder="Your name (optional)">
        <input class="border border-gray-200 rounded-xl p-2.5 text-sm" name="email" placeholder="Your email (optional)">
        <input class="border border-gray-200 rounded-xl p-2.5 text-sm" name="phone" placeholder="Phone (optional)">
        <input class="border border-gray-200 rounded-xl p-2.5 text-sm" name="subject" placeholder="Subject (optional)">
        <select class="border border-gray-200 rounded-xl p-2.5 text-sm" name="category">
          <option>General</option>
          <option>Fees</option>
          <option>Academics</option>
          <option>Support</option>
        </select>
        <textarea class="border border-gray-200 rounded-xl p-2.5 text-sm md:col-span-2" name="message" rows="4" placeholder="Write your message..."></textarea>
        <div class="md:col-span-2 flex items-center justify-between">
          <div id="msgBox" class="text-xs text-gray-500"></div>
          <button type="submit" class="btn-primary rounded-xl px-4 py-2 text-sm font-semibold flex items-center gap-2"><i data-lucide="send"></i> Send Message</button>
        </div>
      </form>
    </section>

    <!-- Premium: Calendar / Important Dates -->
    <section class="glass rounded-2xl p-5 border border-gray-100">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Calendar</h3>
        <div class="flex items-center gap-2 text-sm">
          <button id="calPrev" class="btn-secondary rounded-lg px-2 py-1"><i data-lucide="chevron-left"></i></button>
          <div id="calTitle" class="min-w-[140px] text-center"></div>
          <button id="calNext" class="btn-secondary rounded-lg px-2 py-1"><i data-lucide="chevron-right"></i></button>
        </div>
      </div>
      <div class="grid grid-cols-7 gap-2 text-xs text-gray-500 mb-2">
        <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
      </div>
      <div id="calGrid" class="grid grid-cols-7 gap-2 text-sm"></div>
      <div id="calEvents" class="mt-3 text-sm"></div>
    </section>

    <!-- Premium: AI Assistant -->
    <section class="glass rounded-2xl p-5 border border-gray-100">
      <h3 class="text-lg font-semibold mb-3">SmartEduPay SmartBot</h3>
      <div class="grid md:grid-cols-[1fr,220px] gap-3">
        <div>
          <div id="aiLog" class="text-sm p-3 rounded-xl border border-gray-100 bg-white/70 min-h-[80px]"></div>
        </div>
        <form id="aiForm" class="flex md:flex-col gap-2">
          <input type="hidden" name="token" value="{{ token }}" />
          <input id="aiQ" class="border border-gray-200 rounded-xl p-2.5 text-sm flex-1" placeholder="Ask e.g. What is my child's fee balance?">
          <button class="btn-primary rounded-xl px-3 py-2 text-sm font-semibold flex items-center gap-2" type="submit"><i data-lucide="message-square"></i> Ask</button>
        </form>
      </div>
    </section>
    {% if stk_activity %}
    <section class="glass rounded-2xl p-5 border border-gray-100">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Recent STK Activity</h3>
        <div class="text-xs text-gray-500">Refresh pending items to check latest status</div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left text-gray-500">
              <th class="py-2">Updated</th>
              <th class="py-2">Phone</th>
              <th class="py-2">Amount</th>
              <th class="py-2">Status</th>
              <th class="py-2">Details</th>
              <th class="py-2 text-right">Action</th>
            </tr>
          </thead>
          <tbody>
            {% for r in stk_activity %}
            <tr class="border-t border-gray-100">
              <td class="py-2">{{ r.updated_at }}</td>
              <td class="py-2">{{ r.phone }}</td>
              <td class="py-2">KES {{ '%.0f'|format(r.amount or 0) }}</td>
              <td class="py-2">
                {% if r.status == 'pending' %}
                  <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-amber-50 text-amber-700 border border-amber-200"><i data-lucide="clock" class="w-3.5 h-3.5"></i> Pending</span>
                {% elif r.status == 'success' %}
                  <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-50 text-emerald-700 border border-emerald-200"><i data-lucide="check-circle" class="w-3.5 h-3.5"></i> Success</span>
                {% else %}
                  <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-rose-50 text-rose-700 border border-rose-200"><i data-lucide="x-circle" class="w-3.5 h-3.5"></i> Failed</span>
                {% endif %}
              </td>
              <td class="py-2 text-gray-600">{{ r.result_desc or '-' }}</td>
              <td class="py-2 text-right">
                {% if r.status == 'pending' %}
                  <button class="refresh btn-secondary rounded-lg px-3 py-1.5 text-xs" data-crid="{{ r.checkout_request_id }}">Refresh</button>
                {% elif r.status == 'success' and r.payment_id %}
                  <a class="text-indigo-700 hover:underline" href="{{ url_for('guardian.guardian_receipt', payment_id=r.payment_id, token=token) }}">Print receipt</a>
                {% else %}
                  <span class="text-xs text-gray-400">—</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
    {% endif %}
    <!-- AI fee summary blurb -->
    <section class="glass rounded-2xl p-5 border border-gray-100">
      <div class="flex items-start gap-3">
        <div class="kpi__icon" style="width:40px;height:40px"><i data-lucide="sparkles"></i></div>
        <div class="text-sm text-gray-700">
          {% if percent is not none %}
          <strong>Smart summary:</strong> Your child has cleared <strong>{{ percent }}%</strong> of this term’s fees. Outstanding balance: <strong>Ksh {{ '%.0f'|format(balance or 0) }}</strong>.
          {% else %}
          <strong>Smart summary:</strong> No fee summary available for the current term yet.
          {% endif %}
        </div>
      </div>
    </section>
  </main>

  <script>
    try { lucide.createIcons(); } catch(e){}
    (function(){
      const form = document.getElementById('payForm');
      const box = document.getElementById('payMsg');
      const track = document.getElementById('payTrack');
      const trackWrapper = document.getElementById('payTrackWrapper');
      const cancelBtn = document.getElementById('payTrackCancel');
      const fill = document.getElementById('fillFull');
      const amt = form ? form.querySelector('input[name="amount"]') : null;
      let trackInterval = null;

      const stopTracking = (message) => {
        if (trackInterval) { clearInterval(trackInterval); trackInterval = null; }
        if (typeof message === 'string' && track) { track.textContent = message; }
        if (cancelBtn) { cancelBtn.classList.add('hidden'); }
      };

      const startTracking = (checkoutId) => {
        if (!track || !trackWrapper || !checkoutId) { return; }
        stopTracking();
        trackWrapper.classList.remove('hidden');
        if (cancelBtn) { cancelBtn.classList.remove('hidden'); }
        track.textContent = 'Awaiting confirmation...';
        let tries = 0;
        trackInterval = setInterval(async () => {
          tries += 1;
          const u = new URL('{{ url_for('guardian.guardian_payment_status') }}', window.location.origin);
          u.searchParams.set('crid', checkoutId);
          u.searchParams.set('token', {{ token|tojson }});
          try {
            const r = await fetch(u.toString());
            const s = await r.json();
            if (s && s.status === 'success') {
              stopTracking('Payment confirmed. Reloading...');
              setTimeout(()=>window.location.reload(), 1000);
              return;
            } else if (s && s.status === 'failed') {
              stopTracking('Payment failed. ' + (s.message||'Try again.'));
              return;
            }
            track.textContent = 'Awaiting confirmation...';
          } catch(e) { /* ignore */ }
          if (tries > 30) {
            stopTracking('No confirmation yet. You can refresh later.');
            return;
          }
        }, 3000);
      };

      if (cancelBtn) {
        cancelBtn.addEventListener('click', () => {
          stopTracking('Tracking canceled. You can refresh later.');
        });
      }

      if (fill && amt) {
        fill.addEventListener('click', ()=>{ try{ const bal = Number({{ (balance or 0)|tojson }}); amt.value = String(Math.max(1, Math.ceil(bal))); }catch(_){ } });
      }
      if (!form) return;
      form.addEventListener('submit', async (e) => {
        e.preventDefault(); box.textContent = 'Sending STK push...'; box.className='text-sm text-gray-600';
        const data = Object.fromEntries(new FormData(form).entries());
        const res = await fetch('{{ url_for('guardian.guardian_make_payment') }}', {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data)
        });
        const j = await res.json().catch(()=>({ok:false,error:'Invalid response'}));
        if (j.ok) {
          box.textContent = j.message || 'Request sent. Check your phone.'; box.className='text-sm text-emerald-600';
          if (j.checkout_request_id) {
            startTracking(j.checkout_request_id);
          }
        } else {
          box.textContent = j.error || 'Payment failed.'; box.className='text-sm text-rose-600';
        }
      });
    })();

    (function(){
      const quotes = [
        "Great tuition stories are paid on time and tracked in SmartEduPay.",
        "Consistent payments today fund tomorrow's educational triumphs.",
        "Every fee cleared is a promise kept between school, parent, and child.",
        "SmartEduPay keeps you informed so you can focus on your child’s classroom wins.",
        "Balance clarity builds confidence—focus on progress, not paperwork.",
        "Timely confirmations mean no more guessing whether the school got the funds.",
        "Family teamwork includes keeping ledgers, receipts, and stories in sync.",
        "Parents who know their status start the term in command.",
        "A smooth payment is a high-five to the bursar and the child alike.",
        "Seeing the ledger at a glance sparks smarter conversations with teachers."
      ];
      const quoteEl = document.getElementById("quoteText");
      const progress = document.getElementById("quoteProgress");
      if(!quoteEl || !progress) { return; }
      const duration = 7000;
      let idx = 0;
      const showQuote = () => {
        quoteEl.textContent = quotes[idx];
        progress.style.transition = "none";
        progress.style.width = "0%";
        // Force reflow before animating
        void progress.offsetWidth;
        progress.style.transition = `width ${duration}ms linear`;
        progress.style.width = "100%";
        idx = (idx + 1) % quotes.length;
      };
      showQuote();
      setInterval(showQuote, duration);
    })();

    // PayPal Buttons
    {% if paypal_client_id %}
    (function(){
      const amtInput = document.querySelector('#payForm input[name=\'amount\']');
      const tokenVal = {{ token|tojson }};
      function amountVal(){ try{ return String(Math.max(1, parseFloat(amtInput?.value||'0'))); }catch(_){ return '0'; } }
      function loadScript(url){ return new Promise((resolve,reject)=>{ const s=document.createElement('script'); s.src=url; s.onload=resolve; s.onerror=reject; document.head.appendChild(s); }); }
      const cid = {{ paypal_client_id|tojson }}; const curr = {{ paypal_currency|tojson }};
      const sdkUrl = `https://www.paypal.com/sdk/js?client-id=${encodeURIComponent(cid)}&currency=${encodeURIComponent(curr)}`;
      loadScript(sdkUrl).then(()=>{
        if (!window.paypal) return;
        paypal.Buttons({
          style: { shape:'rect', color:'gold', layout:'horizontal' },
          createOrder: async () => {
            const r = await fetch('{{ url_for('guardian.guardian_paypal_create_order') }}', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ amount: amountVal(), token: tokenVal }) });
            const j = await r.json(); if(!j.ok) throw new Error(j.error||'Create failed'); return j.id;
          },
          onApprove: async (data) => {
            const r = await fetch('{{ url_for('guardian.guardian_paypal_capture') }}', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ order_id: data.orderID, token: tokenVal }) });
            const j = await r.json(); if(j && j.ok){ window.location.reload(); } else { alert('Payment not completed: '+(j.error||'')); }
          },
          onError: (err) => { console.warn('PayPal error', err); }
        }).render('#paypal-button-container');
      }).catch(()=>{});
    })();
    {% endif %}
    // Mobile sidebar drawer
    (function(){
      const btn = document.getElementById('openMenu');
      const side = document.getElementById('side');
      const ov = document.getElementById('overlay');
      if (!btn || !side || !ov) return;
      const open = () => { side.classList.remove('hidden'); ov.classList.remove('hidden'); requestAnimationFrame(()=> side.style.transform='translateX(0)'); };
      const close = () => { side.style.transform='translateX(-120%)'; ov.classList.add('hidden'); setTimeout(()=> side.classList.add('hidden'), 250); };
      btn.addEventListener('click', open);
      ov.addEventListener('click', close);
    })();
    // Manual refresh for pending STK attempts
    (function(){
      try{
        document.querySelectorAll('button.refresh').forEach(btn => {
          btn.addEventListener('click', async () => {
            btn.disabled = true; const crid = btn.getAttribute('data-crid');
            const u = new URL('{{ url_for('guardian.guardian_payment_status') }}', window.location.origin);
            u.searchParams.set('crid', crid);
            u.searchParams.set('token', {{ token|tojson }});
            try {
              const r = await fetch(u.toString());
              const s = await r.json();
              if (s.status === 'success') { window.location.reload(); }
              else if (s.status === 'failed') { btn.textContent = 'Failed'; }
              else { btn.textContent = 'Still pending'; btn.disabled = false; }
            } catch(e) { btn.textContent = 'Error'; btn.disabled = false; }
          });
        });
      }catch(_){ }
    })();
    // Sibling links: generate secure token on the server via redirect endpoint
    (function(){
      try{
        document.querySelectorAll('.sib-link').forEach(a => {
          a.addEventListener('click', (e) => {
            e.preventDefault();
            const sid = a.getAttribute('data-id');
            if (!sid) return;
            const u = new URL('{{ url_for('guardian.guardian_switch') }}', window.location.origin);
            u.searchParams.set('sid', sid);
            window.location.assign(u.toString());
          });
        });
      }catch(_){ }
    })();

    // Message the school
    (function(){
      const f = document.getElementById('msgForm'); if (!f) return;
      f.addEventListener('submit', async (e) => {
        e.preventDefault();
        const box = document.getElementById('msgBox');
        if (box) { box.textContent = 'Sending...'; box.classList.remove('text-rose-600','text-emerald-600'); box.classList.add('text-gray-400'); }
        const data = new FormData(f);
        try{
          const r = await fetch('{{ url_for('student_portal.contact_school') }}', { method: 'POST', body: data });
          const j = await r.json();
          if (j && j.ok) {
            if (box) { box.textContent = j.message || 'Sent.'; box.classList.remove('text-gray-400'); box.classList.add('text-emerald-600'); }
            f.reset();
          } else {
            if (box) { box.textContent = j?.error || 'Failed to send message.'; box.classList.remove('text-gray-400'); box.classList.add('text-rose-600'); }
          }
        }catch(err){
          if (box) { box.textContent = 'Network error.'; box.classList.remove('text-gray-400'); box.classList.add('text-rose-600'); }
        }
      });
    })();

    // Simple AI assistant
    (function(){
      const f = document.getElementById('aiForm'); const log = document.getElementById('aiLog'); const q = document.getElementById('aiQ');
      if (!f || !q || !log) return;
      const append = (text, who, tone='text-gray-600') => {
        const p = document.createElement('p');
        p.className = `mb-2 text-sm ${tone}`;
        p.innerHTML = `<span class="font-semibold">${who}:</span> ${text}`;
        log.appendChild(p);
        log.scrollTop = log.scrollHeight;
      };
      append('Hi, I am SmartEduPay SmartBot. Ask me about fees or exams.','Bot','text-gray-400');
      f.addEventListener('submit', async (e) => {
        e.preventDefault();
        const val = (q.value||'').trim();
        if (!val) return;
        append(val,'You','text-indigo-700');
        q.value='';
        try{
          const r = await fetch('{{ url_for('guardian.guardian_ai_assistant') }}', {
            method: 'POST',
            headers: { 'Content-Type':'application/json' },
            body: JSON.stringify({ token: {{ token|tojson }}, question: val }),
          });
          const j = await r.json();
          append(j.answer || j.text || j.response || j.error || 'Sorry, I could not help right now.','Bot','text-gray-400');
        }catch(err){
          append('Network error.','Bot','text-rose-500');
        }
      });
    })();

    // Calendar UI
    (function(){
      const title = document.getElementById('calTitle'); const grid = document.getElementById('calGrid'); const list = document.getElementById('calEvents');
      if (!title || !grid || !list) return;
      let d = new Date();
      const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      async function load(){
        const y = d.getFullYear(); const m = d.getMonth()+1;
        title.textContent = `${monthNames[m-1]} ${y}`;
        let items = [];
        try{
          const u = new URL('{{ url_for('guardian.guardian_events') }}', window.location.origin);
          u.searchParams.set('token', {{ token|tojson }}); u.searchParams.set('y', y); u.searchParams.set('m', m);
          const r = await fetch(u.toString());
          const j = await r.json();
          if (j && j.ok) items = j.items || [];
        }catch(_){ items = []; }
        grid.innerHTML = ''; list.innerHTML = '';
        const first = new Date(y, m-1, 1); const startDay = first.getDay(); const last = new Date(y, m, 0).getDate();
        for (let i=0;i<startDay;i++){
          const ph = document.createElement('div');
          ph.className='p-3 rounded-xl border border-dashed border-gray-100 text-gray-300';
          grid.appendChild(ph);
        }
        const byDay = {};
        items.forEach(ev => {
          try{
            const sd = new Date(ev.start_date);
            const key = sd.getDate();
            (byDay[key] ||= []).push(ev);
          }catch(_){}
        });
        for (let day=1; day<=last; day++){
          const cell = document.createElement('div');
          cell.className='p-3 rounded-xl border border-gray-100 bg-white/70';
          const h = document.createElement('div');
          h.className='text-xs text-gray-500';
          h.textContent = day;
          cell.appendChild(h);
          const listEl = document.createElement('div');
          listEl.className='mt-2 space-y-1';
          const evs = byDay[day] || [];
          evs.slice(0,2).forEach(e => {
            const b = document.createElement('div');
            b.className='px-2 py-1 rounded bg-indigo-50 text-indigo-700 text-xs';
            b.textContent = e.title;
            listEl.appendChild(b);
          });
          if (evs.length > 2){
            const more = document.createElement('div');
            more.className='text-[10px] text-gray-400';
            more.textContent = `+${evs.length-2} more`;
            listEl.appendChild(more);
          }
          cell.appendChild(listEl);
          grid.appendChild(cell);
        }
        if (items.length){
          const ul = document.createElement('ul');
          ul.className='space-y-2';
          items.slice(0,4).forEach(e => {
            const li = document.createElement('li');
            li.innerHTML = `<strong>${e.title}</strong> <span class="text-xs text-gray-500">(${e.start_date}${e.end_date?(' - '+e.end_date):''})</span>`;
            ul.appendChild(li);
          });
          list.appendChild(ul);
        } else {
          list.textContent = 'No events this month.';
        }
      }
      document.getElementById('calPrev')?.addEventListener('click', ()=>{ d.setMonth(d.getMonth()-1); load(); });
      document.getElementById('calNext')?.addEventListener('click', ()=>{ d.setMonth(d.getMonth()+1); load(); });
      load();
    })();

    // Chart rendering for spending analytics
    (function(){
      const chartEl = document.getElementById('payChart');
      const msg = document.getElementById('payMsg');
      const raw = {{ payments|tojson }};
      if (!chartEl) return;
      const parsed = (raw || [])
        .map(p => ({ date: p.date ? new Date(p.date) : null, amount: Number(p.amount || 0) }))
        .filter(p => p.date instanceof Date && !Number.isNaN(p.amount))
        .sort((a,b) => a.date - b.date)
        .slice(-6);
      if (!parsed.length){
        if (msg) msg.textContent = 'No payment history to chart yet.';
        return;
      }
      const formatter = new Intl.DateTimeFormat('en-US', { month: 'short', day: 'numeric' });
      const labels = parsed.map(p => formatter.format(p.date));
      const amounts = parsed.map(p => p.amount);
      const total = amounts.reduce((sum, value) => sum + value, 0);
      new Chart(chartEl, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'KES Paid',
            data: amounts,
            borderColor: '#a855f7',
            backgroundColor: 'rgba(168,85,247,0.25)',
            borderWidth: 3,
            pointRadius: 4,
            pointBackgroundColor: '#fff',
            pointBorderWidth: 2,
            tension: 0.35,
            fill: true,
          }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { grid: { display: false }, ticks: { color: 'rgba(248,250,252,0.8)' } },
            y: { grid: { color: 'rgba(148,163,184,0.4)' }, ticks: { color: 'rgba(248,250,252,0.8)', callback: val => Number(val).toLocaleString() }, beginAtZero: true },
          },
        },
      });
      if (msg) msg.textContent = `Last ${amounts.length} payments total KES ${total.toLocaleString()}.`;
    })();
  </script>
</body>
</html>








