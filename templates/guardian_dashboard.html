<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Parent Dashboard - {{ APP_TITLE }}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" integrity="sha384-G5yRvCNrI6VOGGAaHo9dZYkTfGZNVVRhk1FdYyqS/fWznuaCG2lLBVmOAXoJ1V8L" crossorigin="anonymous"></script>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
  <link rel="icon" href="{{ url_for('static', filename=FAVICON) }}" type="image/jpeg">
  <style>
    :root {
      --portal-ink: #0b1324;
      --portal-muted: #526175;
      --portal-card: rgba(255, 255, 255, 0.88);
      --portal-border: rgba(11, 19, 36, 0.12);
      --portal-shadow: 0 24px 60px rgba(11, 19, 36, 0.16);
      --portal-accent: #0f766e;
      --portal-accent-strong: #0b4a4a;
      --portal-warm: #f59e0b;
      --portal-warm-soft: rgba(245, 158, 11, 0.18);
      --portal-ice: rgba(230, 248, 244, 0.9);
    }

    html, body {
      margin: 0;
      padding: 0;
    }

    .guardian-portal {
      font-family: "Space Grotesk", "Trebuchet MS", sans-serif;
      color: var(--portal-ink);
      background: #f3f9f7;
      margin: 0;
      padding: 0;
      position: relative;
      overflow-x: hidden;
    }

    .guardian-portal h1,
    .guardian-portal h2,
    .guardian-portal h3,
    .guardian-portal .brand-title {
      font-family: "Fraunces", "Times New Roman", serif;
      letter-spacing: -0.01em;
    }

    .portal-bg {
      position: fixed;
      inset: 0;
      background:
        radial-gradient(circle at 8% 8%, rgba(15, 118, 110, 0.22), transparent 42%),
        radial-gradient(circle at 90% 8%, rgba(245, 158, 11, 0.24), transparent 46%),
        radial-gradient(circle at 20% 85%, rgba(14, 165, 233, 0.16), transparent 48%),
        linear-gradient(135deg, rgba(255, 255, 255, 0.7), rgba(231, 245, 241, 0.95));
      z-index: 0;
      pointer-events: none;
    }

    .portal-grid {
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(rgba(11, 19, 36, 0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(11, 19, 36, 0.05) 1px, transparent 1px);
      background-size: 48px 48px;
      mask-image: radial-gradient(circle at 30% 10%, rgba(0, 0, 0, 0.6), transparent 65%);
      z-index: 0;
      pointer-events: none;
    }

    .portal-frame {
      position: fixed;
      inset: 12px;
      border-radius: 28px;
      border: 1px dashed rgba(11, 19, 36, 0.08);
      box-shadow:
        0 0 0 12px rgba(255, 255, 255, 0.35),
        0 20px 50px rgba(15, 23, 42, 0.1);
      z-index: 1;
      pointer-events: none;
    }

    @media (max-width: 640px) {
      .portal-frame {
        inset: 6px;
        border-radius: 18px;
      }
    }

    .portal-shell {
      width: 100%;
      max-width: 1240px;
      padding: 0 clamp(16px, 3vw, 40px);
      margin: 0 auto;
    }

    .portal-header {
      position: sticky;
      top: 0;
      z-index: 40;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(16px);
      border-bottom: 1px solid rgba(15, 23, 42, 0.08);
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
    }

    .portal-header__inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 18px;
      padding: 12px 0;
      flex-wrap: wrap;
    }

    .portal-header__brand {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 220px;
    }

    .portal-header__logo {
      display: grid;
      place-items: center;
      width: 48px;
      height: 48px;
      border-radius: 16px;
      background: linear-gradient(135deg, #1d4ed8, #0ea5e9);
      color: #fff;
      box-shadow: 0 12px 24px rgba(30, 64, 175, 0.25);
    }

    .portal-header__logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 12px;
      background: #fff;
      padding: 4px;
    }

    .portal-header__title {
      font-size: 1.15rem;
      font-weight: 700;
      line-height: 1.1;
    }

    .portal-header__subtitle {
      font-size: 0.85rem;
      color: var(--portal-muted);
      margin-top: 2px;
    }

    .portal-header__school {
      font-size: 0.78rem;
      color: #1f2937;
      margin-top: 4px;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .portal-header__meta {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .portal-header__bell {
      position: relative;
      border-radius: 999px;
      border: 1px solid rgba(15, 23, 42, 0.12);
      background: #fff;
      width: 42px;
      height: 42px;
      display: grid;
      place-items: center;
      color: var(--portal-ink);
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .portal-header__bell:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(15, 23, 42, 0.12);
    }

    .portal-header__badge {
      position: absolute;
      top: -6px;
      right: -6px;
      background: #dc2626;
      color: #fff;
      font-size: 0.65rem;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 999px;
      box-shadow: 0 8px 14px rgba(220, 38, 38, 0.3);
    }

    .portal-header__profile {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 14px 6px 8px;
      border-radius: 999px;
      background: #f8fafc;
      border: 1px solid rgba(15, 23, 42, 0.08);
      color: var(--portal-ink);
      font-weight: 600;
    }

    .portal-header__avatar {
      display: grid;
      place-items: center;
      width: 34px;
      height: 34px;
      border-radius: 999px;
      background: rgba(30, 64, 175, 0.12);
      color: #1d4ed8;
    }

    .portal-header__logout {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      height: 40px;
      padding: 0 14px;
      border-radius: 999px;
      border: 1px solid rgba(15, 23, 42, 0.12);
      background: #fff;
      color: #0f172a;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      font-size: 12px;
      font-weight: 600;
      text-decoration: none;
      white-space: nowrap;
    }

    .portal-header__logout i {
      width: 16px;
      height: 16px;
    }

    .portal-header__logout:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(15, 23, 42, 0.12);
    }

    .guardian-portal .brand-hero__row {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .guardian-portal .app-badge {
      border-radius: 18px;
      padding: 8px;
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(15, 23, 42, 0.08);
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
    }

    .guardian-portal .brand-title {
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .portal-layout {
      position: relative;
      z-index: 1;
      display: grid;
      gap: 24px;
      padding: 28px 0 46px;
    }

    .portal-deck {
      display: grid;
      gap: 32px;
      grid-template-columns: repeat(12, minmax(0, 1fr));
      align-items: start;
    }

    .portal-card {
      grid-column: span 12;
      min-width: 0;
    }

    @media (min-width: 1100px) {
      .portal-card--wide { grid-column: span 12; }
      .portal-card--half { grid-column: span 6; }
      .portal-card--third { grid-column: span 4; }
      .portal-card--two-thirds { grid-column: span 8; }
    }

    .portal-order-1 { order: 1; }
    .portal-order-2 { order: 2; }
    .portal-order-3 { order: 3; }
    .portal-order-4 { order: 4; }
    .portal-order-5 { order: 5; }
    .portal-order-6 { order: 6; }
    .portal-order-7 { order: 7; }
    .portal-order-8 { order: 8; }
    .portal-order-9 { order: 9; }
    .portal-order-10 { order: 10; }
    .portal-order-11 { order: 11; }
    .portal-order-12 { order: 12; }
    .portal-order-13 { order: 13; }

    @media (min-width: 900px) {
      .portal-layout {
        grid-template-columns: 280px minmax(0, 1fr);
      }
    }

    .portal-side {
      position: relative;
      background: var(--portal-card);
      border: 1px solid var(--portal-border);
      box-shadow: var(--portal-shadow);
    }

    .portal-side::before {
      content: "";
      position: absolute;
      inset: 12px;
      border-radius: 22px;
      border: 1px dashed rgba(15, 23, 42, 0.08);
      pointer-events: none;
    }

    .guardian-portal .glass {
      background: var(--portal-card);
      border: 1px solid var(--portal-border);
      box-shadow: var(--portal-shadow);
      backdrop-filter: blur(12px);
    }

    .guardian-portal .bg-white\/70,
    .guardian-portal .bg-white\/80,
    .guardian-portal .bg-white\/90 {
      background: var(--portal-card);
    }

    .guardian-portal .border-gray-100 {
      border-color: var(--portal-border);
    }

    .guardian-portal .text-indigo-700,
    .guardian-portal .text-indigo-600 {
      color: var(--portal-accent);
    }

    .guardian-portal .text-indigo-500 {
      color: var(--portal-accent-strong);
    }

    .guardian-portal .bg-indigo-600 {
      background-color: var(--portal-accent);
    }

    .guardian-portal .hover\:bg-indigo-500:hover {
      background-color: var(--portal-accent-strong);
    }

    .guardian-portal .bg-indigo-50 {
      background-color: var(--portal-ice);
    }

    .guardian-portal .border-indigo-100 {
      border-color: rgba(15, 118, 110, 0.2);
    }

    .guardian-portal .hover\:border-indigo-200:hover {
      border-color: rgba(15, 118, 110, 0.35);
    }

    .guardian-portal .focus\:border-indigo-500:focus {
      border-color: var(--portal-accent);
      box-shadow: 0 0 0 2px rgba(13, 148, 136, 0.2);
    }

    .guardian-portal .focus-visible\:outline-indigo-500:focus-visible {
      outline-color: var(--portal-accent);
    }

    .guardian-portal .btn-secondary {
      background: rgba(15, 118, 110, 0.1);
      color: var(--portal-accent);
      border: 1px solid rgba(15, 118, 110, 0.2);
    }

    .guardian-portal .btn-secondary:hover {
      background: rgba(15, 118, 110, 0.2);
    }

    .guardian-portal .guardian-analytics-panel {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(240, 253, 250, 0.85));
      border: 1px solid rgba(15, 118, 110, 0.25);
      color: var(--portal-ink);
      box-shadow: 0 28px 60px rgba(15, 23, 42, 0.12);
    }

    .guardian-portal .guardian-analytics-panel::after {
      background:
        radial-gradient(circle at 20% -10%, rgba(15, 118, 110, 0.25), transparent 55%),
        radial-gradient(circle at 72% 25%, rgba(245, 158, 11, 0.2), transparent 55%);
      opacity: 0.35;
    }

    .guardian-portal .guardian-analytics-metrics {
      background: rgba(255, 255, 255, 0.92);
      border: 1px solid var(--portal-border);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.8);
    }

    .guardian-portal .guardian-analytics-metric {
      background: rgba(255, 255, 255, 0.72);
      border: 1px solid var(--portal-border);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.45);
    }

    .portal-hero {
      position: relative;
      overflow: hidden;
    }

    .portal-hero::after {
      content: "";
      position: absolute;
      inset: auto -30% -30% auto;
      width: 240px;
      height: 240px;
      background: radial-gradient(circle, rgba(249, 115, 22, 0.3), transparent 70%);
      opacity: 0.8;
      pointer-events: none;
    }

    .portal-kpi {
      border-radius: 18px;
      background: rgba(15, 118, 110, 0.12);
      color: var(--portal-accent);
      padding: 12px;
    }

    .portal-stagger > * {
      opacity: 0;
      transform: translateY(16px);
      animation: portalIn 0.75s ease forwards;
    }

    .portal-stagger > *:nth-child(1) { animation-delay: 0.05s; }
    .portal-stagger > *:nth-child(2) { animation-delay: 0.1s; }
    .portal-stagger > *:nth-child(3) { animation-delay: 0.16s; }
    .portal-stagger > *:nth-child(4) { animation-delay: 0.22s; }
    .portal-stagger > *:nth-child(5) { animation-delay: 0.28s; }
    .portal-stagger > *:nth-child(6) { animation-delay: 0.34s; }

    @keyframes portalIn {
      to { opacity: 1; transform: translateY(0); }
    }

    .portal-ui {
      background:
        radial-gradient(circle at 8% 0%, rgba(17, 126, 121, 0.12), transparent 45%),
        radial-gradient(circle at 92% 8%, rgba(196, 139, 50, 0.12), transparent 45%),
        #f6f3ee;
      color: #0f172a;
    }

    .sample-shell {
      width: 100%;
      max-width: 1260px;
      padding: 0 clamp(16px, 3vw, 40px);
      margin: 0 auto;
    }

    .sample-topbar {
      position: sticky;
      top: 0;
      z-index: 20;
      background: rgba(245, 246, 251, 0.8);
      backdrop-filter: blur(16px);
      border-bottom: 1px solid rgba(15, 23, 42, 0.06);
    }

    .sample-topbar__inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 16px 0;
    }

    .sample-icon-btn {
      border: 1px solid rgba(12, 24, 45, 0.12);
      background: rgba(255, 255, 255, 0.9);
      border-radius: 999px;
      padding: 8px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 12px 26px rgba(11, 19, 36, 0.12);
    }

    .sample-search {
      flex: 1;
      max-width: 420px;
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(255, 255, 255, 0.92);
      border: 1px solid rgba(12, 24, 45, 0.12);
      border-radius: 999px;
      padding: 10px 16px;
      box-shadow: 0 16px 32px rgba(11, 19, 36, 0.12);
    }

    .sample-search input {
      border: none;
      outline: none;
      background: transparent;
      width: 100%;
      font-size: 0.95rem;
      color: #0f172a;
    }

    .sample-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .sample-avatar {
      height: 40px;
      width: 40px;
      border-radius: 999px;
      background: #4f46e5;
      color: #fff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      letter-spacing: 0.03em;
    }

    .sample-logout {
      font-size: 0.85rem;
      font-weight: 600;
      color: #0f172a;
    }

    .sample-layout {
      padding: 28px 0 60px;
      display: flex;
      flex-direction: column;
      gap: 28px;
      position: relative;
      z-index: 2;
    }

    .sample-hero {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .sample-hero__copy h1 {
      font-size: clamp(1.8rem, 2.5vw, 2.6rem);
      font-weight: 700;
    }

    .sample-hero__label {
      text-transform: uppercase;
      letter-spacing: 0.35em;
      font-size: 0.65rem;
      color: #64748b;
    }

    .sample-hero__actions {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      align-items: center;
    }

    .sample-child-card {
      display: flex;
      align-items: center;
      gap: 12px;
      background: #fff;
      border: 1px solid rgba(15, 23, 42, 0.08);
      padding: 12px 16px;
      border-radius: 16px;
      box-shadow: 0 18px 32px rgba(15, 23, 42, 0.08);
    }

    .sample-child-icon {
      height: 44px;
      width: 44px;
      border-radius: 999px;
      background: #eef2ff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: #4f46e5;
    }

    .sample-primary-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(135deg, #0b6e6b, #149189);
      color: #fff;
      border-radius: 16px;
      padding: 12px 20px;
      font-weight: 600;
      box-shadow: 0 18px 30px rgba(12, 110, 107, 0.35);
    }

    .sample-primary-btn--full {
      width: 100%;
      justify-content: center;
    }

    .sample-secondary-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid rgba(12, 24, 45, 0.12);
      background: #fffaf2;
      color: #0f172a;
      border-radius: 12px;
      padding: 10px 14px;
      font-weight: 600;
    }

    .sample-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.96), rgba(250, 246, 238, 0.88));
      border-radius: 20px;
      border: 1px solid rgba(12, 24, 45, 0.1);
      box-shadow: 0 26px 48px rgba(11, 19, 36, 0.12);
      padding: 24px;
    }

    .sample-kpis {
      display: grid;
      gap: 18px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .sample-kpi {
      border-radius: 18px;
      padding: 20px;
      color: #fff;
      position: relative;
      overflow: hidden;
    }

    .sample-kpi--paid {
      background: linear-gradient(135deg, #0b6e6b, #2bb1a6);
    }

    .sample-kpi--balance {
      background: linear-gradient(135deg, #c48b32, #f2b45a);
    }

    .sample-kpi--lite {
      background: #fff;
      color: #0f172a;
      border: 1px solid rgba(15, 23, 42, 0.08);
      box-shadow: 0 16px 28px rgba(15, 23, 42, 0.06);
    }

    .sample-kpi__label {
      font-size: 0.85rem;
      opacity: 0.85;
    }

    .sample-kpi__value {
      font-size: 1.6rem;
      font-weight: 700;
      margin-top: 6px;
    }

    .sample-kpi__sub {
      font-size: 0.85rem;
      margin-top: 10px;
      opacity: 0.85;
    }

    .sample-section__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 18px;
    }

    .sample-section__header h2 {
      font-size: 1.3rem;
      font-weight: 700;
    }

    .sample-section__header p {
      color: #64748b;
      font-size: 0.95rem;
    }

    .sample-link {
      color: #4f46e5;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .sample-list {
      display: grid;
      gap: 12px;
    }

    .sample-list__item {
      display: grid;
      grid-template-columns: auto 1fr auto auto;
      align-items: center;
      gap: 16px;
      padding: 14px 16px;
      border-radius: 14px;
      background: #f8fafc;
      border: 1px solid rgba(15, 23, 42, 0.06);
    }

    .sample-list__icon {
      height: 44px;
      width: 44px;
      border-radius: 14px;
      background: #eef2ff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: #4f46e5;
    }

    .sample-list__title {
      font-weight: 600;
    }

    .sample-list__meta {
      color: #64748b;
      font-size: 0.9rem;
    }

    .sample-list__amount {
      font-weight: 700;
    }

    .sample-status {
      font-size: 0.75rem;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid transparent;
    }

    .sample-status--paid {
      background: #dcfce7;
      color: #15803d;
      border-color: #86efac;
    }

    .sample-status--pending {
      background: #fef3c7;
      color: #b45309;
      border-color: #fde68a;
    }

    .sample-status--overdue {
      background: #fee2e2;
      color: #b91c1c;
      border-color: #fecaca;
    }

    .sample-actions-grid {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }

    .sample-action-card {
      background: #f8fafc;
      border-radius: 16px;
      padding: 18px;
      border: 1px solid rgba(15, 23, 42, 0.06);
      display: grid;
      gap: 6px;
      text-align: center;
    }

    .sample-action-icon {
      height: 52px;
      width: 52px;
      border-radius: 16px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 6px;
      color: #fff;
    }

    .sample-action-icon--indigo { background: #0f766e; }
    .sample-action-icon--green { background: #22c55e; }
    .sample-action-icon--orange { background: #f97316; }
    .sample-action-icon--slate { background: #64748b; }

    .sample-action-title {
      font-weight: 600;
    }

    .sample-action-sub {
      color: #64748b;
      font-size: 0.9rem;
    }

    .sample-form-grid {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .sample-label {
      font-size: 0.85rem;
      color: #475569;
      margin-bottom: 6px;
      display: block;
    }

    .sample-label--row {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .sample-input {
      width: 100%;
      border: 1px solid rgba(15, 23, 42, 0.12);
      border-radius: 12px;
      padding: 10px 12px;
      background: #fff;
    }

    .sample-help {
      color: #64748b;
      font-size: 0.85rem;
      margin-top: 8px;
    }

    .sample-track {
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      color: #64748b;
      font-size: 0.85rem;
    }

    .sample-divider {
      height: 1px;
      background: rgba(15, 23, 42, 0.08);
      margin: 16px 0;
    }

    .sample-split {
      display: grid;
      gap: 18px;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }

    .sample-info-panel {
      background: #f8fafc;
      border-radius: 16px;
      padding: 18px;
      border: 1px solid rgba(15, 23, 42, 0.06);
    }

    .sample-info-title {
      font-weight: 600;
      margin-bottom: 6px;
    }

    .sample-pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }

    .sample-pill-row span {
      background: #eef2ff;
      color: #4338ca;
      font-size: 0.75rem;
      padding: 4px 8px;
      border-radius: 999px;
    }

    .sample-form-panel {
      background: #fff;
      border-radius: 16px;
      border: 1px solid rgba(15, 23, 42, 0.08);
      padding: 18px;
    }

    .sample-form-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .sample-form-meta {
      display: flex;
      align-items: center;
      gap: 10px;
      color: #94a3b8;
      font-size: 0.75rem;
    }

    .sample-form-title {
      font-weight: 600;
    }

    .sample-form-sub {
      color: #64748b;
      font-size: 0.85rem;
    }

    .sample-badge {
      background: #ecfdf3;
      color: #15803d;
      font-size: 0.75rem;
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid #86efac;
    }

    .sample-form-stack {
      display: grid;
      gap: 12px;
    }

    .sample-form-row {
      display: grid;
      gap: 12px;
      grid-template-columns: 1fr auto;
      align-items: end;
    }

    .sample-bank-grid {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    }

    .sample-bank-pill {
      display: flex;
      align-items: center;
      gap: 6px;
      background: #f8fafc;
      border: 1px solid rgba(15, 23, 42, 0.08);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 0.85rem;
    }

    .sample-grid-2 {
      display: grid;
      gap: 18px;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }

    .sample-dropzone {
      border: 1px dashed rgba(15, 23, 42, 0.2);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      background: #f8fafc;
    }

    .sample-drop-icon {
      height: 48px;
      width: 48px;
      border-radius: 14px;
      background: #eef2ff;
      color: #4f46e5;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 8px;
    }

    .sample-note-panel {
      background: #f8fafc;
      border-radius: 16px;
      padding: 18px;
      border: 1px solid rgba(15, 23, 42, 0.06);
    }

    .sample-form-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      grid-column: 1 / -1;
    }

    .sample-cal-nav {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .sample-cal-title {
      min-width: 120px;
      text-align: center;
      font-weight: 600;
      color: #475569;
    }

    .sample-chat-log {
      border: 1px solid rgba(15, 23, 42, 0.08);
      border-radius: 16px;
      padding: 12px;
      background: #f8fafc;
      min-height: 120px;
      margin-bottom: 12px;
    }

    .sample-chat-form {
      display: grid;
      gap: 10px;
      grid-template-columns: 1fr auto;
    }

    .sample-chart__msg {
      color: #94a3b8;
      font-size: 0.85rem;
      margin-top: 8px;
    }

    .sample-summary {
      color: #475569;
      font-size: 0.95rem;
    }

    .proof-grid {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }

    .proof-card {
      background: rgba(255, 255, 255, 0.92);
      border: 1px solid rgba(12, 24, 45, 0.12);
      border-radius: 18px;
      padding: 18px;
      box-shadow: 0 20px 36px rgba(11, 19, 36, 0.08);
      display: grid;
      gap: 10px;
    }

    .proof-card__top {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
    }

    .proof-card__title {
      font-weight: 700;
    }

    .proof-card__meta {
      font-size: 0.82rem;
      color: var(--portal-muted);
    }

    .proof-card__row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.9rem;
    }

    .proof-card__label {
      color: var(--portal-muted);
    }

    .proof-card__value {
      font-weight: 700;
    }

    .proof-card__note {
      font-size: 0.88rem;
      color: #475569;
      background: var(--portal-ice);
      border-radius: 12px;
      padding: 10px 12px;
    }

    .proof-card__note--alert {
      background: rgba(248, 113, 113, 0.12);
      color: #b91c1c;
    }

    .proof-card__actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .proof-empty {
      border: 1px dashed rgba(12, 24, 45, 0.18);
      border-radius: 18px;
      padding: 18px;
      text-align: center;
      background: rgba(255, 255, 255, 0.82);
    }

    .proof-empty__title {
      font-weight: 700;
      margin-bottom: 6px;
    }

    .sample-panel {
      position: absolute;
      top: calc(100% + 12px);
      right: 0;
      width: min(320px, 90vw);
      background: #fff;
      border: 1px solid rgba(15, 23, 42, 0.08);
      border-radius: 18px;
      box-shadow: 0 22px 40px rgba(15, 23, 42, 0.12);
      padding: 16px;
      z-index: 30;
    }

    .sample-panel__header {
      font-weight: 700;
      margin-bottom: 8px;
    }

    .sample-panel__list {
      display: grid;
      gap: 10px;
      font-size: 0.9rem;
    }

    .sample-panel__item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 8px 10px;
      background: #f8fafc;
      border-radius: 12px;
      border: 1px solid rgba(15, 23, 42, 0.06);
    }

    .sample-panel__meta {
      color: #64748b;
      font-size: 0.78rem;
    }

    .sample-panel__link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--portal-accent);
      font-weight: 600;
    }

    .sample-panel__actions {
      display: grid;
      gap: 8px;
      margin-top: 10px;
    }

    .sample-bell-badge {
      position: absolute;
      top: -4px;
      right: -2px;
      height: 18px;
      min-width: 18px;
      padding: 0 4px;
      border-radius: 999px;
      background: #ef4444;
      color: #fff;
      font-size: 0.7rem;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .portal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.35);
      backdrop-filter: blur(2px);
      z-index: 48;
    }

    .portal-drawer {
      position: fixed;
      top: 0;
      left: 0;
      height: 100%;
      width: min(320px, 85vw);
      background: #fff;
      border-right: 1px solid rgba(15, 23, 42, 0.1);
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.2);
      padding: 22px;
      z-index: 49;
      transform: translateX(-120%);
      transition: transform 0.25s ease;
    }

    .portal-drawer--right {
      left: auto;
      right: 0;
      border-right: none;
      border-left: 1px solid rgba(15, 23, 42, 0.1);
      transform: translateX(120%);
    }

    .portal-drawer.is-open {
      transform: translateX(0);
    }

    .portal-drawer__title {
      font-weight: 700;
      margin-bottom: 6px;
    }

    .portal-drawer__list {
      display: grid;
      gap: 12px;
      margin-top: 18px;
      font-weight: 600;
    }

    .portal-drawer__list a {
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--portal-ink);
    }

    .notify-list {
      display: grid;
      gap: 12px;
      margin-top: 16px;
    }

    .notify-item {
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(15, 23, 42, 0.08);
      background: #f8fafc;
      display: grid;
      gap: 6px;
    }

    .notify-item__title {
      font-weight: 700;
      font-size: 0.95rem;
    }

    .notify-item__meta {
      font-size: 0.78rem;
      color: #64748b;
    }

    .school-banner {
      position: relative;
      z-index: 2;
      padding: 26px 0;
      background:
        radial-gradient(circle at 12% 40%, rgba(255, 255, 255, 0.25), transparent 45%),
        radial-gradient(circle at 90% 20%, rgba(0, 0, 0, 0.08), transparent 55%),
        linear-gradient(120deg, #1f5fdd, #1aa6d1);
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      color: #e7f6ff;
    }

    .school-banner__inner {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      align-items: center;
      justify-content: space-between;
    }

    .banner-brand {
      display: flex;
      align-items: center;
      gap: 18px;
      flex-wrap: wrap;
    }

    .banner-logo {
      height: 86px;
      width: 86px;
      border-radius: 24px;
      padding: 8px;
      background: rgba(255, 255, 255, 0.18);
      border: 1px solid rgba(255, 255, 255, 0.35);
      box-shadow: 0 16px 30px rgba(5, 23, 62, 0.35);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .banner-logo img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      border-radius: 16px;
      background: #fff;
      padding: 6px;
    }

    .banner-app {
      text-transform: uppercase;
      letter-spacing: 0.3em;
      font-size: 0.7rem;
      color: rgba(231, 246, 255, 0.8);
      font-weight: 600;
    }

    .banner-school {
      font-size: clamp(1.6rem, 2.8vw, 2.4rem);
      font-weight: 800;
      color: #fff;
    }

    .banner-tagline {
      color: rgba(231, 246, 255, 0.86);
      font-size: 0.95rem;
    }

    .banner-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 8px;
    }

    .banner-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.16);
      border: 1px solid rgba(255, 255, 255, 0.25);
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #e7f6ff;
    }

    .banner-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    .banner-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.35);
      font-weight: 600;
      color: #e7f6ff;
    }

    .banner-action {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 18px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.35);
      font-weight: 700;
      color: #fff;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .banner-action--ghost {
      background: rgba(255, 255, 255, 0.12);
    }

    .analytics-grid {
      display: grid;
      gap: 18px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .analytics-list {
      display: grid;
      gap: 10px;
    }

    .analytics-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      font-size: 0.9rem;
    }

    .analytics-bar {
      height: 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.08);
      overflow: hidden;
      margin-top: 6px;
    }

    .analytics-bar span {
      display: block;
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(120deg, #0b6e6b, #2bb1a6);
    }

    .settings-group {
      border-top: 1px dashed rgba(12, 24, 45, 0.12);
      padding-top: 10px;
      margin-top: 10px;
      display: grid;
      gap: 8px;
    }

    .settings-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      background: #f8fafc;
      border-radius: 12px;
      padding: 8px 10px;
      border: 1px solid rgba(15, 23, 42, 0.06);
      font-size: 0.88rem;
    }

    .settings-toggle input {
      accent-color: var(--portal-accent-strong);
    }

    .sample-logout {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.92);
      border: 1px solid rgba(12, 24, 45, 0.12);
      font-weight: 600;
      color: var(--portal-ink);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .sample-logout:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 22px rgba(11, 19, 36, 0.12);
    }
    .portal-footer {
      margin-top: 40px;
      padding: 28px 0 32px;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.92), rgba(30, 64, 175, 0.88));
      color: #e5e7eb;
    }

    .portal-footer__inner {
      display: grid;
      gap: 18px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      align-items: start;
    }

    .portal-footer__brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .portal-footer__logo {
      width: 46px;
      height: 46px;
      border-radius: 16px;
      display: grid;
      place-items: center;
      background: rgba(255, 255, 255, 0.14);
      border: 1px solid rgba(255, 255, 255, 0.18);
      color: #fff;
    }

    .portal-footer__logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 12px;
      background: #fff;
      padding: 4px;
    }

    .portal-footer__title {
      font-size: 1rem;
      font-weight: 700;
      color: #fff;
    }

    .portal-footer__subtitle {
      font-size: 0.82rem;
      color: rgba(229, 231, 235, 0.75);
      margin-top: 2px;
    }

    .portal-footer__label {
      text-transform: uppercase;
      letter-spacing: 0.18em;
      font-size: 0.68rem;
      color: rgba(229, 231, 235, 0.7);
      margin-bottom: 8px;
      font-weight: 700;
    }

    .portal-footer__contact {
      display: grid;
      gap: 8px;
      font-size: 0.9rem;
    }

    .portal-footer__contact span {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .portal-footer__message {
      font-size: 0.95rem;
      color: #f8fafc;
      background: rgba(255, 255, 255, 0.12);
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      min-height: 56px;
      transition: opacity 0.35s ease;
    }

    .portal-footer__message.is-fading {
      opacity: 0;
    }

    .portal-footer__actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .portal-footer__action {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      border-radius: 999px;
      background: #fff;
      color: #0f172a;
      font-weight: 700;
      font-size: 0.82rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .proof-card.is-hidden {
      display: none;
    }

    .proof-grid.is-expanded .proof-card.is-hidden {
      display: grid;
    }
  </style>
</head>
<body class="guardian-portal min-h-screen portal-ui" id="top">
  <div class="portal-bg"></div>
  <div class="portal-grid"></div>
  <div class="portal-frame"></div>
  {% set pending_count = 0 %}
  {% if stk_activity %}
    {% set pending_count = (stk_activity | selectattr('status','equalto','pending') | list | length) %}
  {% endif %}
  <header class="portal-header">
    <div class="portal-shell portal-header__inner">
      <div class="portal-header__brand">
        <div class="portal-header__logo">
          {% if SCHOOL_LOGO_URL %}
            <img src="{{ url_for('static', filename=SCHOOL_LOGO_URL) }}" alt="{{ student.school_name or SCHOOL_NAME or APP_TITLE }} logo">
          {% else %}
            <i data-lucide="graduation-cap"></i>
          {% endif %}
        </div>
        <div>
          <div class="portal-header__title">{{ student.school_name or SCHOOL_NAME or BRAND_NAME or 'School' }}</div>
          <div class="portal-header__subtitle">Parent Portal</div>
          <div class="portal-header__school">{{ PORTAL_TITLE or APP_TITLE }}</div>
        </div>
      </div>
      <div class="portal-header__meta">
        <button id="notifyToggle" class="portal-header__bell" type="button" aria-label="Notifications" aria-controls="notifyDrawer" aria-expanded="false">
          <i data-lucide="bell"></i>
          {% if pending_count %}
          <span class="portal-header__badge">{{ pending_count }}</span>
          {% endif %}
        </button>
        <div class="portal-header__profile">
          <span class="portal-header__avatar"><i data-lucide="user"></i></span>
          <span>{{ guardian_name or guardian_full_name or guardian or 'Parent' }}</span>
        </div>
        <a class="portal-header__logout" href="{{ url_for('guardian.guardian_logout') }}" title="Logout">
          <i data-lucide="log-out"></i>
          <span>Logout</span>
        </a>
      </div>
    </div>
  </header>

  <div id="notifyOverlay" class="portal-overlay hidden" aria-hidden="true"></div>
  <aside id="notifyDrawer" class="portal-drawer portal-drawer--right" aria-hidden="true">
    <div class="portal-drawer__title">Notifications</div>
    <div class="portal-drawer__list">
      <div class="notify-list">
        {% if pending_count and pending_count > 0 %}
        <div class="notify-item">
          <div class="notify-item__title">Pending M-Pesa approvals</div>
          <div class="notify-item__meta">{{ pending_count }} payment(s) awaiting confirmation.</div>
        </div>
        {% endif %}
        {% if proof_statuses and proof_statuses|length > 0 %}
          {% for proof in proof_statuses[:3] %}
          <div class="notify-item">
            <div class="notify-item__title">Proof #{{ proof.id }} {{ proof.status_label }}</div>
            <div class="notify-item__meta">{{ proof.created_at or 'Recently updated' }}</div>
          </div>
          {% endfor %}
        {% endif %}
        {% if (not pending_count) and (not proof_statuses or proof_statuses|length == 0) %}
        <div class="notify-item">
          <div class="notify-item__title">All caught up</div>
          <div class="notify-item__meta">No new alerts right now.</div>
        </div>
        {% endif %}
      </div>
      <a href="#proofStatus"><i data-lucide="bell-ring"></i> View proof updates</a>
      <a href="#recent-payments"><i data-lucide="receipt"></i> Review payments</a>
    </div>
  </aside>
  
  

  

  <main class="sample-shell sample-layout">
    <section class="sample-hero">
      <div class="sample-hero__copy">
        <div class="sample-hero__label">Parent portal</div>
        <h1>Welcome back, Parent</h1>
        <p>Here is an overview of your child's school fees and recent activity.</p>
      </div>
      <div class="sample-hero__actions">
        <div class="sample-child-card">
          <div class="sample-child-icon">
            <i data-lucide="graduation-cap"></i>
          </div>
          <div>
            <div class="sample-child-name">{{ student.name }}</div>
            <div class="sample-child-meta">{{ student.class or student.class_name or 'Class' }}</div>
          </div>
        </div>
        <a href="#payForm" class="sample-primary-btn">
          <i data-lucide="credit-card"></i>
          Pay All Dues
        </a>
      </div>
    </section>

    <section class="sample-kpis">
      <div class="sample-kpi sample-kpi--paid">
        <div class="sample-kpi__label">Total Paid</div>
        <div class="sample-kpi__value">Ksh {{ '%.0f'|format(paid or 0) }}</div>
        <div class="sample-kpi__sub">This academic year</div>
      </div>
      <div class="sample-kpi sample-kpi--balance">
        <div class="sample-kpi__label">Outstanding Balance</div>
        <div class="sample-kpi__value">Ksh {{ '%.0f'|format(balance or 0) }}</div>
        <div class="sample-kpi__sub">{{ balance and 'Pending items' or 'All clear' }}</div>
      </div>
      <div class="sample-kpi sample-kpi--lite">
        <div class="sample-kpi__label">Next Payment</div>
        <div class="sample-kpi__value">Ksh {{ '%.0f'|format(balance or 0) }}</div>
        <div class="sample-kpi__sub">Due this term</div>
      </div>
      <div class="sample-kpi sample-kpi--lite">
        <div class="sample-kpi__label">Overdue Amount</div>
        <div class="sample-kpi__value">Ksh {{ balance and '%.0f'|format(balance or 0) or '0' }}</div>
        <div class="sample-kpi__sub">{{ balance and '1 overdue payment' or 'No overdue payments' }}</div>
      </div>
    </section>

    <section class="sample-section guardian-analytics-panel">
      <div class="sample-section__header">
        <div>
          <h2>Parent Analytics</h2>
          <p>Insights from your latest transactions.</p>
        </div>
        <div class="portal-kpi">
          Last payment: KES {{ '%.0f'|format(analytics.last_payment_amount or 0) }}
        </div>
      </div>
      <div class="guardian-analytics-metrics sample-grid-2">
        <div class="guardian-analytics-metric">
          <div class="sample-kpi__label">Avg monthly paid</div>
          <div class="sample-kpi__value">KES {{ '%.0f'|format(analytics.avg_monthly or 0) }}</div>
          <div class="sample-kpi__sub">{{ analytics.active_months or 0 }} active months</div>
        </div>
        <div class="guardian-analytics-metric">
          <div class="sample-kpi__label">Growth vs last month</div>
          <div class="sample-kpi__value">{{ analytics.monthly.growth if analytics and analytics.monthly else 0 }}%</div>
          <div class="sample-kpi__sub">Trend based on 12 months</div>
        </div>
        <div class="guardian-analytics-metric">
          <div class="sample-kpi__label">Last payment date</div>
          <div class="sample-kpi__value">{{ analytics.last_payment_date or 'No payments yet' }}</div>
          <div class="sample-kpi__sub">Most recent receipt</div>
        </div>
      </div>
      <div class="sample-split">
        <div class="sample-info-panel">
          <div class="sample-info-title">Top payment methods</div>
          {% set method_max = 0 %}
          {% for m in analytics.methods %}
            {% if m.total > method_max %}
              {% set method_max = m.total %}
            {% endif %}
          {% endfor %}
          <div class="analytics-list">
            {% for m in analytics.methods %}
            <div>
              <div class="analytics-row">
                <span>{{ m.method }}</span>
                <span class="font-semibold">KES {{ '%.0f'|format(m.total or 0) }}</span>
              </div>
              <div class="analytics-bar">
                <span style="width: {{ method_max and ((m.total / method_max) * 100) or 0 }}%"></span>
              </div>
            </div>
            {% else %}
            <div class="text-sm text-gray-500">No method breakdown available yet.</div>
            {% endfor %}
          </div>
        </div>
        <div class="sample-info-panel">
          <div class="sample-info-title">Payment momentum</div>
          <p class="text-sm text-gray-600">
            {% if analytics and analytics.monthly and (analytics.monthly.growth or 0) > 0 %}
              Your payments are up {{ analytics.monthly.growth }}% this month. Keep the momentum going.
            {% elif analytics and analytics.monthly and (analytics.monthly.growth or 0) < 0 %}
              Payments dipped {{ analytics.monthly.growth|abs }}% this month. Consider scheduling a top-up.
            {% else %}
              Payment activity is steady this month. Stay on track with upcoming dues.
            {% endif %}
          </p>
          <div class="sample-pill-row">
            <span>Secure receipts</span>
            <span>Auto-ledger sync</span>
            <span>Parent verified</span>
          </div>
        </div>
      </div>
    </section>

    <section class="sample-section sample-card">
      <div class="sample-section__header">
        <div>
          <h2>Recent Transactions</h2>
          <p>Your payment activity</p>
        </div>
        <a href="#recent-payments" class="sample-link">View All <i data-lucide="arrow-up-right"></i></a>
      </div>
      <div class="sample-list">
        {% for p in payments[:4] %}
        <div class="sample-list__item">
          <div class="sample-list__icon"><i data-lucide="receipt"></i></div>
          <div class="sample-list__info">
            <div class="sample-list__title">{{ p.reference or p.method or 'Payment' }}</div>
            <div class="sample-list__meta">{{ p.date }}</div>
          </div>
          <div class="sample-list__amount">Ksh {{ '%.0f'|format(p.amount or 0) }}</div>
          <div class="sample-status sample-status--paid">Paid</div>
        </div>
        {% else %}
        <div class="sample-empty">No recent transactions yet.</div>
        {% endfor %}
        <div id="listSearchEmpty" class="sample-empty hidden">No matches found.</div>
      </div>
    </section>

    <section class="sample-section sample-card">
      <div class="sample-section__header">
        <div>
          <h2>Payment History</h2>
          <p>Monthly payment overview</p>
        </div>
      </div>
      <div class="sample-chart">
        <canvas id="payChart" height="140"></canvas>
        <div id="payChartMsg" class="sample-chart__msg"></div>
      </div>
    </section>

    <section class="sample-section sample-card">
      <div class="sample-section__header">
        <div>
          <h2>Quick Actions</h2>
          <p>Common tasks at your fingertips</p>
        </div>
      </div>
      <div class="sample-actions-grid">
        <a href="#payForm" class="sample-action-card">
          <div class="sample-action-icon sample-action-icon--indigo"><i data-lucide="credit-card"></i></div>
          <div class="sample-action-title">Make Payment</div>
          <div class="sample-action-sub">Pay fees instantly</div>
        </a>
        <a href="{{ url_for('student_portal.statement_pdf', token=token) }}" class="sample-action-card">
          <div class="sample-action-icon sample-action-icon--green"><i data-lucide="file-text"></i></div>
          <div class="sample-action-title">View Statements</div>
          <div class="sample-action-sub">Download receipts</div>
        </a>
        <a href="#uploadProof" class="sample-action-card">
          <div class="sample-action-icon sample-action-icon--orange"><i data-lucide="upload"></i></div>
          <div class="sample-action-title">Upload Proof</div>
          <div class="sample-action-sub">Attach a receipt</div>
        </a>
        <a href="#msgForm" class="sample-action-card">
          <div class="sample-action-icon sample-action-icon--slate"><i data-lucide="message-square"></i></div>
          <div class="sample-action-title">Contact School</div>
          <div class="sample-action-sub">Send a message</div>
        </a>
      </div>
    </section>

    <section class="sample-section sample-card" id="payFormSection">
      <div class="sample-section__header">
        <div>
          <h2>Make a Payment</h2>
          <p>Record M-Pesa payments instantly.</p>
        </div>
      </div>
      <form id="payForm" class="sample-form-grid">
        <input type="hidden" name="token" value="{{ token }}" />
        <div>
          <label class="sample-label">Phone Number (M-Pesa)</label>
          <input name="phone" placeholder="07xx..." class="sample-input" />
        </div>
        <div>
          <label class="sample-label sample-label--row">
            <span>Amount (KES)</span>
            <button type="button" id="fillFull" class="sample-link">Use full balance</button>
          </label>
          <input name="amount" type="number" min="1" step="1" placeholder="e.g. 500" class="sample-input" />
        </div>
        <button type="submit" class="sample-primary-btn sample-primary-btn--full">
          <i data-lucide="smartphone"></i>
          Pay Now with M-Pesa
        </button>
      </form>
      <div id="payMsg" class="sample-help"></div>
      <div id="payTrackWrapper" class="hidden sample-track">
        <span id="payTrack"></span>
        <button type="button" id="payTrackCancel" class="hidden sample-link">Cancel STK push</button>
      </div>
      {% if paypal_client_id %}
      <div class="sample-divider"></div>
      <div class="sample-help">Or pay securely with PayPal</div>
      <div id="paypal-button-container"></div>
      {% endif %}
    </section>

    <section class="sample-section sample-card">
      <div class="sample-section__header">
        <div>
          <h2>Paybill Bank Payment</h2>
          <p>Pay from any Kenyan bank, then paste the M-Pesa confirmation to verify instantly.</p>
        </div>
      </div>
      <div class="sample-split">
        <div class="sample-info-panel">
          <div class="sample-info-title">School Paybill</div>
          <p class="text-sm text-gray-600">All Kenyan banks supported. Use the student details as the account number.</p>
          <div class="sample-pill-row">
            <span>Equity</span>
            <span>KCB</span>
            <span>Co-op</span>
            <span>NCBA</span>
            <span>Absa</span>
            <span>Stanbic</span>
            <span>DTB</span>
            <span>I&M</span>
            <span>Family</span>
            <span>Standard Chartered</span>
          </div>
          <div class="sample-note-panel mt-4">
            <div class="sample-note-title">Paybill details</div>
            <p><strong>Paybill:</strong> {{ SCHOOL_PAYBILL or 'Set in admin settings' }}</p>
            <p><strong>Account number:</strong> {{ student.admission_no or student.id }}</p>
            <p class="text-xs text-gray-500">Use the student admission number or student ID as the account reference.</p>
          </div>
        </div>
        <div class="sample-form-panel">
          <div class="sample-form-header">
            <div>
              <div class="sample-form-title">Send M-Pesa confirmation</div>
              <div class="sample-form-sub">Paste the full message to attach it to {{ student.name }}.</div>
            </div>
          </div>
          <form id="paybillForm" class="sample-form-stack">
            <input type="hidden" name="account_ref" value="{{ student.admission_no or student.id }}">
            <div class="sample-form-row">
              <div>
                <label class="sample-label">Amount (KES)</label>
                <input type="number" name="amount" min="1" step="1" class="sample-input" placeholder="e.g. 1500" required>
              </div>
              <div>
                <label class="sample-label">Payment date</label>
                <input type="date" name="payment_date" class="sample-input">
              </div>
            </div>
            <div>
              <label class="sample-label">Bank</label>
              <select name="bank_name" class="sample-input">
                <option value="M-Pesa">M-Pesa</option>
                <option value="Equity">Equity</option>
                <option value="KCB">KCB</option>
                <option value="Cooperative">Co-operative Bank</option>
                <option value="NCBA">NCBA</option>
                <option value="Absa">Absa</option>
                <option value="Stanbic">Stanbic</option>
                <option value="DTB">DTB</option>
                <option value="I&M">I&M</option>
                <option value="Family Bank">Family Bank</option>
                <option value="Standard Chartered">Standard Chartered</option>
              </select>
            </div>
            <div>
              <label class="sample-label">M-Pesa message</label>
              <textarea name="mpesa_text" class="sample-input" rows="4" placeholder="Paste the full confirmation SMS here." required></textarea>
            </div>
            <button type="submit" class="sample-primary-btn sample-primary-btn--full">
              <i data-lucide="send"></i>
              Send for verification
            </button>
            <div id="paybillStatus" class="sample-help"></div>
          </form>
        </div>
      </div>
    </section>

    <section id="recent-payments" class="sample-section sample-card">
      <div class="sample-section__header">
        <div>
          <h2>Recent Payments</h2>
          <p>All recorded receipts for the term.</p>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left text-gray-500">
              <th class="py-2">Date</th>
              <th class="py-2">Reference</th>
              <th class="py-2">Method</th>
              <th class="py-2">Status</th>
              <th class="py-2 text-right">Amount (KES)</th>
              <th class="py-2 text-right">Receipt</th>
            </tr>
          </thead>
          <tbody>
            {% for p in payments %}
            <tr class="border-t border-gray-100">
              <td class="py-2">{{ p.date }}</td>
              <td class="py-2">{{ p.reference or '-' }}</td>
              <td class="py-2">{{ p.method or 'M-Pesa' }}</td>
              <td class="py-2">
                <span class="sample-status sample-status--paid">Success</span>
              </td>
              <td class="py-2 text-right">{{ '%.0f'|format(p.amount or 0) }}</td>
              <td class="py-2 text-right text-indigo-700"><a href="{{ url_for('guardian.guardian_receipt', payment_id=p.id, token=token) }}" class="hover:underline">Print</a></td>
            </tr>
            {% else %}
            <tr class="border-t border-gray-100 text-gray-500 is-empty"><td colspan="6" class="py-4 text-center">No payments yet.</td></tr>
            {% endfor %}
            <tr id="tableSearchEmpty" class="border-t border-gray-100 text-gray-500 hidden"><td colspan="6" class="py-4 text-center">No matches found.</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <section class="sample-section sample-card" id="uploadProof">
      <div class="sample-section__header">
        <div>
          <h2>Upload Payment Proof</h2>
          <p>Attach a slip or paste statement text.</p>
        </div>
      </div>
      <div class="sample-grid-2">
        <div class="sample-dropzone">
          <div class="sample-drop-icon"><i data-lucide="file-plus-2"></i></div>
          <div class="sample-drop-title">Upload a receipt</div>
          <div class="sample-drop-sub">We will tag it to {{ student.name }}.</div>
          <form id="inlineProofForm" action="{{ url_for('guardian.guardian_receipt_upload', token=token) }}" method="post" enctype="multipart/form-data" class="space-y-2">
            <input type="hidden" name="description" value="Proof upload for {{ student.name }} {{ year }}/{{ term }}">
            <input type="file" name="receipt" id="inlineProofFile" accept=".png,.jpg,.jpeg,.pdf" class="hidden" />
            <button type="button" id="inlineProofBtn" class="sample-primary-btn sample-primary-btn--full">
              <i data-lucide="arrow-up-right"></i>
              Upload proof
            </button>
            <div id="inlineProofStatus" class="sample-help"></div>
          </form>
        </div>
        <div class="sample-note-panel">
          <div class="sample-note-title">Paste MPesa text</div>
          <p>Include transaction ID, amount, and timestamp to speed up matching.</p>
          <button type="button" id="pasteProofBtn" class="sample-secondary-btn">
            <i data-lucide="clipboard"></i>
            Paste MPesa text
          </button>
        </div>
      </div>
    </section>

    <section class="sample-section sample-card" id="proofStatus">
      <div class="sample-section__header">
        <div>
          <h2 id="proofStatusTitle" title="Press and hold to reveal full history">Proof Status Tracker</h2>
          <p>Status updates are emailed when proofs are accepted or rejected.</p>
        </div>
        <button id="proofRefresh" type="button" class="sample-secondary-btn">
          <i data-lucide="refresh-cw"></i>
          Refresh
        </button>
      </div>
      {% if proof_statuses and proof_statuses|length > 0 %}
      <div class="proof-grid" id="proofGrid" data-total="{{ proof_statuses|length }}">
        {% for proof in proof_statuses %}
        <div class="proof-card {% if loop.index > 5 %}is-hidden{% endif %}">
          <div class="proof-card__top">
            <div>
              <div class="proof-card__title">Proof #{{ proof.id }}</div>
              <div class="proof-card__meta">{{ proof.created_at or 'Recently uploaded' }}</div>
            </div>
            <span class="sample-status {{ proof.status_classes }}">{{ proof.status_label }}</span>
          </div>
          <div class="proof-card__row">
            <span class="proof-card__label">Amount</span>
            <span class="proof-card__value">KES {{ '%.0f'|format(proof.amount or 0) }}</span>
          </div>
          {% if proof.description %}
          <div class="proof-card__note">{{ proof.description }}</div>
          {% endif %}
          {% if proof.notes %}
          <div class="proof-card__note proof-card__note--alert">Note: {{ proof.notes }}</div>
          {% endif %}
          <div class="proof-card__actions">
            {% if proof.file_url %}
            <a class="sample-secondary-btn" href="{{ proof.file_url }}" target="_blank" rel="noopener">
              <i data-lucide="file-text"></i>
              View proof
            </a>
            {% endif %}
            <a class="sample-secondary-btn" href="#uploadProof">
              <i data-lucide="upload-cloud"></i>
              Upload new
            </a>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="proof-empty">
        <div class="proof-empty__title">No proofs uploaded yet.</div>
        <p class="text-sm text-gray-600">Upload a receipt and track its verification status here.</p>
        <a class="sample-primary-btn" href="#uploadProof">
          <i data-lucide="upload-cloud"></i>
          Upload proof
        </a>
      </div>
      {% endif %}
    </section>

    <section class="sample-section sample-card">
      <div class="sample-section__header">
        <div>
          <h2>Message the School</h2>
          <p>Send updates or questions to the accounts office.</p>
        </div>
      </div>
      <form id="msgForm" class="sample-grid-2">
        <input type="hidden" name="token" value="{{ token }}" />
        <input class="sample-input" name="name" placeholder="Your name (optional)">
        <input class="sample-input" name="email" placeholder="Your email (optional)">
        <input class="sample-input" name="phone" placeholder="Phone (optional)">
        <input class="sample-input" name="subject" placeholder="Subject (optional)">
        <select class="sample-input" name="category">
          <option>General</option>
          <option>Fees</option>
          <option>Academics</option>
          <option>Support</option>
        </select>
        <textarea class="sample-input" name="message" rows="4" placeholder="Write your message..."></textarea>
        <div class="sample-form-footer">
          <div id="msgBox" class="sample-help"></div>
          <button type="submit" class="sample-primary-btn">
            <i data-lucide="send"></i>
            Send Message
          </button>
        </div>
      </form>
    </section>

    <section class="sample-section sample-card">
      <div class="sample-grid-2">
        <div>
          <div class="sample-section__header">
            <div>
              <h2>Calendar</h2>
              <p>Upcoming school events.</p>
            </div>
            <div class="sample-cal-nav">
              <button id="calPrev" class="sample-icon-btn" type="button"><i data-lucide="chevron-left"></i></button>
              <div id="calTitle" class="sample-cal-title"></div>
              <button id="calNext" class="sample-icon-btn" type="button"><i data-lucide="chevron-right"></i></button>
            </div>
          </div>
          <div class="grid grid-cols-7 gap-2 text-xs text-gray-500 mb-2">
            <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
          </div>
          <div id="calGrid" class="grid grid-cols-7 gap-2 text-sm"></div>
          <div id="calEvents" class="mt-3 text-sm"></div>
        </div>
        <div>
          <div class="sample-section__header">
            <div>
              <h2>SmartBot</h2>
              <p>Ask anything about fees or receipts.</p>
            </div>
          </div>
          <div id="aiLog" class="sample-chat-log"></div>
          <form id="aiForm" class="sample-chat-form">
            <input type="hidden" name="token" value="{{ token }}" />
            <input id="aiQ" class="sample-input" placeholder="Ask a question...">
            <button class="sample-primary-btn" type="submit"><i data-lucide="message-square"></i> Ask</button>
          </form>
        </div>
      </div>
    </section>

    {% if stk_activity %}
    <section class="sample-section sample-card">
      <div class="sample-section__header">
        <div>
          <h2>Recent STK Activity</h2>
          <p>Refresh pending items to check the latest status.</p>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left text-gray-500">
              <th class="py-2">Updated</th>
              <th class="py-2">Phone</th>
              <th class="py-2">Amount</th>
              <th class="py-2">Status</th>
              <th class="py-2">Details</th>
              <th class="py-2 text-right">Action</th>
            </tr>
          </thead>
          <tbody>
            {% for r in stk_activity %}
            <tr class="border-t border-gray-100">
              <td class="py-2">{{ r.updated_at }}</td>
              <td class="py-2">{{ r.phone }}</td>
              <td class="py-2">KES {{ '%.0f'|format(r.amount or 0) }}</td>
              <td class="py-2">
                {% if r.status == 'pending' %}
                  <span class="sample-status sample-status--pending">Pending</span>
                {% elif r.status == 'success' %}
                  <span class="sample-status sample-status--paid">Success</span>
                {% else %}
                  <span class="sample-status sample-status--overdue">Failed</span>
                {% endif %}
              </td>
              <td class="py-2 text-gray-600">{{ r.result_desc or '-' }}</td>
              <td class="py-2 text-right">
                {% if r.status == 'pending' %}
                  <button class="refresh sample-secondary-btn" data-crid="{{ r.checkout_request_id }}">Refresh</button>
                {% elif r.status == 'success' and r.payment_id %}
                  <a class="text-indigo-700 hover:underline" href="{{ url_for('guardian.guardian_receipt', payment_id=r.payment_id, token=token) }}">Print receipt</a>
                {% else %}
                  <span class="text-xs text-gray-400">-</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
    {% endif %}

    <section class="sample-section sample-card">
      <div class="sample-section__header">
        <div>
          <h2>Smart Summary</h2>
          <p>Progress for the current term.</p>
        </div>
      </div>
      <div class="sample-summary">
        {% if percent is not none %}
        Your child has cleared <strong>{{ percent }}%</strong> of this term's fees. Outstanding balance: <strong>Ksh {{ '%.0f'|format(balance or 0) }}</strong>.
        {% else %}
        No fee summary available for the current term yet.
        {% endif %}
      </div>
    </section>

    <footer class="portal-footer">
      <div class="portal-shell portal-footer__inner">
        <div class="portal-footer__brand">
          <div class="portal-footer__logo">
            {% if SCHOOL_LOGO_URL %}
              <img src="{{ url_for('static', filename=SCHOOL_LOGO_URL) }}" alt="{{ student.school_name or SCHOOL_NAME or APP_TITLE }} logo">
            {% else %}
              <i data-lucide="school"></i>
            {% endif %}
          </div>
          <div>
            <div class="portal-footer__title">{{ student.school_name or SCHOOL_NAME or APP_TITLE }}</div>
            <div class="portal-footer__subtitle">Parent finance portal</div>
          </div>
        </div>
        <div>
          <div class="portal-footer__label">Contact</div>
          <div class="portal-footer__contact">
            <span><i data-lucide="map-pin"></i> {{ SCHOOL_ADDRESS or 'Main campus' }}</span>
            <span><i data-lucide="mail"></i> {{ SCHOOL_EMAIL or 'accounts@school.ac.ke' }}</span>
            <span><i data-lucide="phone"></i> {{ SCHOOL_PHONE or '0700 000 000' }}</span>
          </div>
        </div>
        <div>
          <div class="portal-footer__label">Encouragement</div>
          <div id="encouragementText" class="portal-footer__message">Every payment builds a stronger learning journey.</div>
        </div>
        <div class="portal-footer__actions">
          <a class="portal-footer__action" href="#payFormSection"><i data-lucide="wallet"></i> Pay now</a>
          <a class="portal-footer__action" href="#msgForm"><i data-lucide="send"></i> Message school</a>
        </div>
      </div>
    </footer>
  </main>

  <script>
    try { lucide.createIcons(); } catch(e){}

    (function(){
      const bell = document.getElementById('notifyToggle');
      const drawer = document.getElementById('notifyDrawer');
      const overlay = document.getElementById('notifyOverlay');
      if (!bell || !drawer || !overlay) return;
      const open = () => {
        overlay.classList.remove('hidden');
        drawer.classList.add('is-open');
        bell.setAttribute('aria-expanded', 'true');
        drawer.setAttribute('aria-hidden', 'false');
      };
      const close = () => {
        drawer.classList.remove('is-open');
        bell.setAttribute('aria-expanded', 'false');
        drawer.setAttribute('aria-hidden', 'true');
        setTimeout(() => overlay.classList.add('hidden'), 180);
      };
      bell.addEventListener('click', () => {
        if (drawer.classList.contains('is-open')) {
          close();
        } else {
          open();
        }
      });
      overlay.addEventListener('click', close);
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') close();
      });
    })();

    (function(){
      const toggles = Array.from(document.querySelectorAll('.settings-toggle__input'));
      if (!toggles.length) return;
      const storageKey = 'guardianSettings';
      const loadState = () => {
        try { return JSON.parse(localStorage.getItem(storageKey) || '{}'); } catch(_) { return {}; }
      };
      const saveState = (state) => {
        try { localStorage.setItem(storageKey, JSON.stringify(state)); } catch(_) {}
      };
      const state = loadState();
      toggles.forEach((input) => {
        const key = input.getAttribute('data-setting');
        if (key && state[key] !== undefined) {
          input.checked = !!state[key];
        }
        input.addEventListener('change', () => {
          if (!key) return;
          state[key] = input.checked;
          saveState(state);
        });
      });
    })();

    (function(){
      const node = document.getElementById('encouragementText');
      if (!node) return;
      const messages = [
        'Every payment keeps your child learning with confidence.',
        'Small steps today build strong academic futures.',
        'Consistent support grows curiosity, focus, and confidence.',
        'Thank you for staying ahead on fees and learning goals.',
        'Your support fuels steady growth and brighter outcomes.',
        'On-time payments keep classrooms ready and thriving.',
        'Daily encouragement helps children build resilience and joy.'
      ];
      let idx = 0;
      setInterval(() => {
        node.classList.add('is-fading');
        setTimeout(() => {
          idx = (idx + 1) % messages.length;
          node.textContent = messages[idx];
          node.classList.remove('is-fading');
        }, 350);
      }, 5000);
    })();

    (function(){
      const input = document.getElementById('transactionSearch');
      const listItems = Array.from(document.querySelectorAll('.sample-list__item'));
      const emptyList = document.querySelector('.sample-list .sample-empty');
      const listSearchEmpty = document.getElementById('listSearchEmpty');
      const tableRows = Array.from(document.querySelectorAll('#recent-payments tbody tr'))
        .filter(row => !row.classList.contains('is-empty') && row.id !== 'tableSearchEmpty');
      const tableEmpty = document.getElementById('tableSearchEmpty');
      if (!input) return;
      const normalize = (val) => (val || '').toLowerCase();
      const applyFilter = () => {
        const q = normalize(input.value);
        let listMatches = 0;
        listItems.forEach(item => {
          const hit = normalize(item.textContent).includes(q);
          item.style.display = hit ? '' : 'none';
          if (hit) listMatches += 1;
        });
        if (listSearchEmpty) {
          listSearchEmpty.classList.toggle('hidden', !(q && listMatches === 0));
        } else if (emptyList) {
          emptyList.style.display = listItems.length && !listMatches && q ? '' : 'none';
          emptyList.textContent = q ? 'No matches found.' : 'No recent transactions yet.';
        }
        let tableMatches = 0;
        tableRows.forEach(row => {
          const hit = normalize(row.textContent).includes(q);
          row.style.display = hit ? '' : 'none';
          if (hit) tableMatches += 1;
        });
        if (tableEmpty) {
          tableEmpty.classList.toggle('hidden', !(q && tableMatches === 0));
        }
      };
      input.addEventListener('input', applyFilter);
      document.getElementById('clearSearch')?.addEventListener('click', () => {
        input.value = '';
        applyFilter();
      });
    })();

    (function(){
      const refreshBtn = document.getElementById('proofRefresh');
      if (!refreshBtn) return;
      refreshBtn.addEventListener('click', () => {
        window.location.reload();
      });
    })();
    (function(){
      const topLink = document.getElementById('backToTop');
      if (!topLink) return;
      topLink.addEventListener('click', (e) => {
        e.preventDefault();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    })();
    (function(){
      const form = document.getElementById('payForm');
      const box = document.getElementById('payMsg');
      const track = document.getElementById('payTrack');
      const trackWrapper = document.getElementById('payTrackWrapper');
      const cancelBtn = document.getElementById('payTrackCancel');
      const fill = document.getElementById('fillFull');
      const amt = form ? form.querySelector('input[name="amount"]') : null;
      const cancelEndpoint = '{{ url_for('guardian.guardian_cancel_stk_push') }}';
      let trackInterval = null;
      let currentCheckoutId = null;

      const stopTracking = (message) => {
        if (trackInterval) { clearInterval(trackInterval); trackInterval = null; }
        currentCheckoutId = null;
        if (typeof message === 'string' && track) { track.textContent = message; }
        if (cancelBtn) { cancelBtn.classList.add('hidden'); }
      };

      const startTracking = (checkoutId) => {
        if (!track || !trackWrapper || !checkoutId) { return; }
        stopTracking();
        currentCheckoutId = checkoutId;
        trackWrapper.classList.remove('hidden');
        if (cancelBtn) { cancelBtn.classList.remove('hidden'); }
        track.textContent = 'Awaiting confirmation...';
        let tries = 0;
        trackInterval = setInterval(async () => {
          tries += 1;
          const u = new URL('{{ url_for('guardian.guardian_payment_status') }}', window.location.origin);
          u.searchParams.set('crid', checkoutId);
          u.searchParams.set('token', {{ token|tojson }});
          try {
            const r = await fetch(u.toString());
            const s = await r.json();
            if (s && s.status === 'success') {
              stopTracking('Payment confirmed. Reloading...');
              setTimeout(()=>window.location.reload(), 1000);
              return;
            } else if (s && s.status === 'failed') {
              stopTracking('Payment failed. ' + (s.message||'Try again.'));
              return;
            } else if (s && s.status === 'canceled') {
              stopTracking(String(s.message || 'STK push canceled. You can refresh later.'));
              return;
            }
            track.textContent = 'Awaiting confirmation...';
          } catch(e) { /* ignore */ }
          if (tries > 30) {
            stopTracking('No confirmation yet. You can refresh later.');
            return;
          }
        }, 3000);
      };

      if (cancelBtn) {
        cancelBtn.addEventListener('click', async () => {
          let message = 'Tracking canceled. You can refresh later.';
          if (currentCheckoutId) {
            try {
              const r = await fetch(cancelEndpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: {{ token|tojson }}, crid: currentCheckoutId }),
              });
              const payload = await r.json().catch(() => null);
              if (payload && payload.ok) {
                message = payload.message || 'STK push canceled. You can refresh later.';
              } else if (payload && payload.error) {
                message = payload.error;
              }
            } catch (_err) {
              // keep default message
            }
          }
          stopTracking(message);
        });
      }

      if (fill && amt) {
        fill.addEventListener('click', ()=>{ try{ const bal = Number({{ (balance or 0)|tojson }}); amt.value = String(Math.max(1, Math.ceil(bal))); }catch(_){ } });
      }
      if (!form) return;
      form.addEventListener('submit', async (e) => {
        e.preventDefault(); box.textContent = 'Sending STK push...'; box.className='text-sm text-gray-600';
        const data = Object.fromEntries(new FormData(form).entries());
        const res = await fetch('{{ url_for('guardian.guardian_make_payment') }}', {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data)
        });
        const j = await res.json().catch(()=>({ok:false,error:'Invalid response'}));
        if (j.ok) {
          box.textContent = j.message || 'Request sent. Check your phone.'; box.className='text-sm text-emerald-600';
          if (j.checkout_request_id) {
            startTracking(j.checkout_request_id);
          }
        } else {
          box.textContent = j.error || 'Payment failed.'; box.className='text-sm text-rose-600';
        }
      });
    })();

    (function(){
      const quotes = [
        "Great tuition stories are paid on time and tracked in SmartEduPay.",
        "Consistent payments today fund tomorrow's educational triumphs.",
        "Every fee cleared is a promise kept between school, parent, and child.",
        "SmartEduPay keeps you informed so you can focus on your childs classroom wins.",
        "Balance clarity builds confidencefocus on progress, not paperwork.",
        "Timely confirmations mean no more guessing whether the school got the funds.",
        "Family teamwork includes keeping ledgers, receipts, and stories in sync.",
        "Parents who know their status start the term in command.",
        "A smooth payment is a high-five to the bursar and the child alike.",
        "Seeing the ledger at a glance sparks smarter conversations with teachers."
      ];
      const quoteEl = document.getElementById("quoteText");
      const progress = document.getElementById("quoteProgress");
      if(!quoteEl || !progress) { return; }
      const duration = 7000;
      let idx = 0;
      const showQuote = () => {
        quoteEl.textContent = quotes[idx];
        progress.style.transition = "none";
        progress.style.width = "0%";
        // Force reflow before animating
        void progress.offsetWidth;
        progress.style.transition = `width ${duration}ms linear`;
        progress.style.width = "100%";
        idx = (idx + 1) % quotes.length;
      };
      showQuote();
      setInterval(showQuote, duration);
    })();

    // PayPal Buttons
    {% if paypal_client_id %}
    (function(){
      const amtInput = document.querySelector('#payForm input[name=\'amount\']');
      const tokenVal = {{ token|tojson }};
      function amountVal(){ try{ return String(Math.max(1, parseFloat(amtInput?.value||'0'))); }catch(_){ return '0'; } }
      function loadScript(url){ return new Promise((resolve,reject)=>{ const s=document.createElement('script'); s.src=url; s.onload=resolve; s.onerror=reject; document.head.appendChild(s); }); }
      const cid = {{ paypal_client_id|tojson }}; const curr = {{ paypal_currency|tojson }};
      const sdkUrl = `https://www.paypal.com/sdk/js?client-id=${encodeURIComponent(cid)}&currency=${encodeURIComponent(curr)}`;
      loadScript(sdkUrl).then(()=>{
        if (!window.paypal) return;
        paypal.Buttons({
          style: { shape:'rect', color:'gold', layout:'horizontal' },
          createOrder: async () => {
            const r = await fetch('{{ url_for('guardian.guardian_paypal_create_order') }}', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ amount: amountVal(), token: tokenVal }) });
            const j = await r.json(); if(!j.ok) throw new Error(j.error||'Create failed'); return j.id;
          },
          onApprove: async (data) => {
            const r = await fetch('{{ url_for('guardian.guardian_paypal_capture') }}', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ order_id: data.orderID, token: tokenVal }) });
            const j = await r.json(); if(j && j.ok){ window.location.reload(); } else { alert('Payment not completed: '+(j.error||'')); }
          },
          onError: (err) => { console.warn('PayPal error', err); }
        }).render('#paypal-button-container');
        }).catch(()=>{});
      })();
    {% endif %}
    // Mobile sidebar drawer
    (function(){
      const btn = document.getElementById('openMenu');
      const side = document.getElementById('side');
      const ov = document.getElementById('overlay');
      if (!btn || !side || !ov) return;
      const open = () => { side.classList.remove('hidden'); ov.classList.remove('hidden'); requestAnimationFrame(()=> side.style.transform='translateX(0)'); };
      const close = () => { side.style.transform='translateX(-120%)'; ov.classList.add('hidden'); setTimeout(()=> side.classList.add('hidden'), 250); };
      btn.addEventListener('click', open);
      ov.addEventListener('click', close);
    })();
    // Manual refresh for pending STK attempts
    (function(){
      try{
        document.querySelectorAll('button.refresh').forEach(btn => {
          btn.addEventListener('click', async () => {
            btn.disabled = true; const crid = btn.getAttribute('data-crid');
            const u = new URL('{{ url_for('guardian.guardian_payment_status') }}', window.location.origin);
            u.searchParams.set('crid', crid);
            u.searchParams.set('token', {{ token|tojson }});
            try {
              const r = await fetch(u.toString());
              const s = await r.json();
              if (s.status === 'success') { window.location.reload(); }
              else if (s.status === 'failed') { btn.textContent = 'Failed'; }
              else { btn.textContent = 'Still pending'; btn.disabled = false; }
            } catch(e) { btn.textContent = 'Error'; btn.disabled = false; }
          });
        });
      }catch(_){ }
    })();
    // Sibling links: generate secure token on the server via redirect endpoint
    (function(){
      try{
        document.querySelectorAll('.sib-link').forEach(a => {
          a.addEventListener('click', (e) => {
            e.preventDefault();
            const sid = a.getAttribute('data-id');
            if (!sid) return;
            const u = new URL('{{ url_for('guardian.guardian_switch') }}', window.location.origin);
            u.searchParams.set('sid', sid);
            window.location.assign(u.toString());
          });
        });
      }catch(_){ }
    })();

    // Inline proof upload (stay on dashboard)
    (function(){
      const form = document.getElementById('inlineProofForm');
      const fileInput = document.getElementById('inlineProofFile');
      const btn = document.getElementById('inlineProofBtn');
      const status = document.getElementById('inlineProofStatus');
      if (!form || !fileInput || !btn) return;
      const setStatus = (text, tone) => {
        if (!status) return;
        status.className = `text-[11px] ${tone || 'text-gray-500'}`;
        status.textContent = text || '';
      };
      btn.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', () => {
        if (!fileInput.files.length) { setStatus(''); return; }
        const name = fileInput.files[0]?.name || 'file';
        setStatus(`Uploading ${name}...`, 'text-indigo-600');
        const data = new FormData(form);
        fetch(form.action, { method: 'POST', body: data })
          .then((r) => {
            if (r.ok) {
              setStatus('Uploaded for review. Reloading...', 'text-emerald-700');
              setTimeout(() => window.location.reload(), 900);
            } else {
              setStatus('Upload failed. Try again.', 'text-rose-600');
            }
          })
          .catch(() => setStatus('Network error. Try again.', 'text-rose-600'));
      });
    })();

    // Hidden reveal for proof history (press + hold or double-click title)
    (function(){
      const grid = document.getElementById('proofGrid');
      const title = document.getElementById('proofStatusTitle');
      if (!grid || !title) return;
      const hiddenCards = grid.querySelectorAll('.proof-card.is-hidden');
      if (!hiddenCards.length) return;
      const toggle = () => {
        grid.classList.toggle('is-expanded');
      };
      let timer = null;
      title.addEventListener('dblclick', (e) => {
        e.preventDefault();
        toggle();
      });
      title.addEventListener('pointerdown', () => {
        timer = setTimeout(toggle, 650);
      });
      const clearTimer = () => {
        if (timer) {
          clearTimeout(timer);
          timer = null;
        }
      };
      title.addEventListener('pointerup', clearTimer);
      title.addEventListener('pointerleave', clearTimer);
    })();

    // Paybill message submission (records a verification request)
    (function(){
      const form = document.getElementById('paybillForm');
      const status = document.getElementById('paybillStatus');
      if (!form || !status) return;
      const setStatus = (msg, tone) => {
        status.textContent = msg || '';
        status.className = `text-[12px] ${tone || 'text-gray-500'}`;
      };
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        setStatus('Sending to school for verification...', 'text-indigo-600');
        const data = new FormData(form);
        const payload = {};
        data.forEach((value, key) => { payload[key] = value; });
        try {
          const r = await fetch('{{ url_for('guardian.guardian_payment_mpesa_text') }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          const j = await r.json();
          if (j && j.ok) {
            setStatus(j.message || 'Submitted for verification.', 'text-emerald-700');
            form.reset();
            setTimeout(() => window.location.reload(), 900);
          } else {
            setStatus(j?.error || 'Could not submit message. Try again.', 'text-rose-600');
          }
        } catch (e) {
          setStatus('Network error. Try again.', 'text-rose-600');
        }
      });
    })();

    // Message the school
    (function(){
      const f = document.getElementById('msgForm'); if (!f) return;
      const pasteBtn = document.getElementById('pasteProofBtn');
      const msgArea = f.querySelector('textarea[name="message"]');
      f.addEventListener('submit', async (e) => {
        e.preventDefault();
        const box = document.getElementById('msgBox');
        if (box) { box.textContent = 'Sending...'; box.classList.remove('text-rose-600','text-emerald-600'); box.classList.add('text-gray-400'); }
        const data = new FormData(f);
        try{
          const r = await fetch('{{ url_for('student_portal.contact_school') }}', { method: 'POST', body: data });
          const j = await r.json();
          if (j && j.ok) {
            if (box) { box.textContent = j.message || 'Sent.'; box.classList.remove('text-gray-400'); box.classList.add('text-emerald-600'); }
            f.reset();
          } else {
            if (box) { box.textContent = j?.error || 'Failed to send message.'; box.classList.remove('text-gray-400'); box.classList.add('text-rose-600'); }
          }
        }catch(err){
          if (box) { box.textContent = 'Network error.'; box.classList.remove('text-gray-400'); box.classList.add('text-rose-600'); }
        }
      });
      pasteBtn?.addEventListener('click', () => {
        f.scrollIntoView({ behavior: 'smooth', block: 'center' });
        msgArea?.focus();
        if (msgArea && !msgArea.value.trim()) {
          msgArea.value = 'MPesa payment statement:\n- Transaction ID:\n- Amount:\n- Date:\n- Notes:';
        }
      });
    })();

    // Simple AI assistant
    (function(){
      const f = document.getElementById('aiForm'); const log = document.getElementById('aiLog'); const q = document.getElementById('aiQ');
      if (!f || !q || !log) return;
      const append = (text, who, tone='text-gray-600') => {
        const p = document.createElement('p');
        p.className = `mb-2 text-sm ${tone}`;
        p.innerHTML = `<span class="font-semibold">${who}:</span> ${text}`;
        log.appendChild(p);
        log.scrollTop = log.scrollHeight;
      };
      append('Hi, I am SmartEduPay SmartBot. Ask me about fees or exams.','Bot','text-gray-400');
      f.addEventListener('submit', async (e) => {
        e.preventDefault();
        const val = (q.value||'').trim();
        if (!val) return;
        append(val,'You','text-indigo-700');
        q.value='';
        try{
          const r = await fetch('{{ url_for('guardian.guardian_ai_assistant') }}', {
            method: 'POST',
            headers: { 'Content-Type':'application/json' },
            body: JSON.stringify({ token: {{ token|tojson }}, question: val }),
          });
          const j = await r.json();
          append(j.answer || j.text || j.response || j.error || 'Sorry, I could not help right now.','Bot','text-gray-400');
        }catch(err){
          append('Network error.','Bot','text-rose-500');
        }
      });
    })();

    // Calendar UI
    (function(){
      const title = document.getElementById('calTitle'); const grid = document.getElementById('calGrid'); const list = document.getElementById('calEvents');
      if (!title || !grid || !list) return;
      let d = new Date();
      const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      async function load(){
        const y = d.getFullYear(); const m = d.getMonth()+1;
        title.textContent = `${monthNames[m-1]} ${y}`;
        let items = [];
        try{
          const u = new URL('{{ url_for('guardian.guardian_events') }}', window.location.origin);
          u.searchParams.set('token', {{ token|tojson }}); u.searchParams.set('y', y); u.searchParams.set('m', m);
          const r = await fetch(u.toString());
          const j = await r.json();
          if (j && j.ok) items = j.items || [];
        }catch(_){ items = []; }
        grid.innerHTML = ''; list.innerHTML = '';
        const first = new Date(y, m-1, 1); const startDay = first.getDay(); const last = new Date(y, m, 0).getDate();
        for (let i=0;i<startDay;i++){
          const ph = document.createElement('div');
          ph.className='p-3 rounded-xl border border-dashed border-gray-100 text-gray-300';
          grid.appendChild(ph);
        }
        const byDay = {};
        items.forEach(ev => {
          try{
            const sd = new Date(ev.start_date);
            const key = sd.getDate();
            (byDay[key] ||= []).push(ev);
          }catch(_){}
        });
        for (let day=1; day<=last; day++){
          const cell = document.createElement('div');
          cell.className='p-3 rounded-xl border border-gray-100 bg-white/70';
          const h = document.createElement('div');
          h.className='text-xs text-gray-500';
          h.textContent = day;
          cell.appendChild(h);
          const listEl = document.createElement('div');
          listEl.className='mt-2 space-y-1';
          const evs = byDay[day] || [];
          evs.slice(0,2).forEach(e => {
            const b = document.createElement('div');
            b.className='px-2 py-1 rounded bg-indigo-50 text-indigo-700 text-xs';
            b.textContent = e.title;
            listEl.appendChild(b);
          });
          if (evs.length > 2){
            const more = document.createElement('div');
            more.className='text-[10px] text-gray-400';
            more.textContent = `+${evs.length-2} more`;
            listEl.appendChild(more);
          }
          cell.appendChild(listEl);
          grid.appendChild(cell);
        }
        if (items.length){
          const ul = document.createElement('ul');
          ul.className='space-y-2';
          items.slice(0,4).forEach(e => {
            const li = document.createElement('li');
            li.innerHTML = `<strong>${e.title}</strong> <span class="text-xs text-gray-500">(${e.start_date}${e.end_date?(' - '+e.end_date):''})</span>`;
            ul.appendChild(li);
          });
          list.appendChild(ul);
        } else {
          list.textContent = 'No events this month.';
        }
      }
      document.getElementById('calPrev')?.addEventListener('click', ()=>{ d.setMonth(d.getMonth()-1); load(); });
      document.getElementById('calNext')?.addEventListener('click', ()=>{ d.setMonth(d.getMonth()+1); load(); });
      load();
    })();

    // Chart rendering for spending analytics
    (function(){
      const chartEl = document.getElementById('payChart');
      const msg = document.getElementById('payChartMsg');
      const raw = {{ payments|tojson }};
      if (!chartEl) return;
      const parsed = (raw || [])
        .map(p => ({ date: p.date ? new Date(p.date) : null, amount: Number(p.amount || 0) }))
        .filter(p => p.date instanceof Date && !Number.isNaN(p.amount))
        .sort((a,b) => a.date - b.date)
        .slice(-6);
      if (!parsed.length){
        if (msg) msg.textContent = 'No payment history to chart yet.';
        return;
      }
      const formatter = new Intl.DateTimeFormat('en-US', { month: 'short', day: 'numeric' });
      const labels = parsed.map(p => formatter.format(p.date));
      const amounts = parsed.map(p => p.amount);
      const total = amounts.reduce((sum, value) => sum + value, 0);
      new Chart(chartEl, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'KES Paid',
            data: amounts,
            borderColor: '#0f766e',
            backgroundColor: 'rgba(15,118,110,0.25)',
            borderWidth: 3,
            pointRadius: 4,
            pointBackgroundColor: '#fff',
            pointBorderWidth: 2,
            tension: 0.35,
            fill: true,
          }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { grid: { display: false }, ticks: { color: '#0f172a' } },
            y: { grid: { color: 'rgba(15,23,42,0.12)' }, ticks: { color: '#334155', callback: val => Number(val).toLocaleString() }, beginAtZero: true },
          },
        },
      });
      if (msg) msg.textContent = `Last ${amounts.length} payments total KES ${total.toLocaleString()}.`;
    })();
  </script>
</body>
</html>








