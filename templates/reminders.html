{% extends "base.html" %}
{% block title %}Fee Reminders - {{ APP_TITLE }}{% endblock %}
{% block page_title %}Send Fee Reminders{% endblock %}
{% block content %}

<div class="rounded-2xl shadow-sm border border-gray-100 overflow-hidden bg-white">
  <!-- Premium Header -->
  <div class="bg-gradient-to-r from-indigo-600 via-indigo-500 to-cyan-500 text-white px-6 py-6">
    <div class="flex items-start justify-between">
      <div>
        <div class="flex items-center gap-3">
          <span class="inline-flex p-2.5 rounded-xl bg-white/20 ring-1 ring-white/30 shadow">
            <i data-lucide="message-circle" class="w-5 h-5 text-white"></i>
          </span>
          <h3 class="text-xl font-semibold tracking-tight">Fee Reminder Center</h3>
        </div>
        <p class="mt-2 text-white/90 text-sm">Reach out to guardians and students with a polished email. Use dynamic placeholders to personalize at scale.</p>
      </div>
      <div class="hidden sm:flex items-center gap-4">
        <div class="text-right">
          <div class="text-xs text-white/80">Recipients</div>
          <div class="text-lg font-bold">{{ students|length }}</div>
        </div>
        <div class="h-8 w-px bg-white/30"></div>
        <div class="text-right">
          <div class="text-xs text-white/80">Total Outstanding</div>
          <div class="text-lg font-bold">KES {{ "{:,.2f}".format((students|sum(attribute='balance')) or 0) }}</div>
        </div>
        <div class="h-8 w-px bg-white/30"></div>
        <div class="text-right">
          <div class="text-xs text-white/80">Email</div>
          <div class="text-lg font-bold">
            {% set with_email = students|selectattr('email')|list %}
            {{ with_email|length }} ready
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Content -->
  <div class="p-6 space-y-6">
      <div class="flex items-center justify-end gap-2">
        {% if gmail_connected %}
          <span class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border border-green-200 bg-green-50 text-sm text-green-700">
            <i data-lucide="check-circle"></i>
            Gmail Connected
          </span>
          <a href="/gmail/disconnect" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border border-gray-200 bg-white hover:bg-gray-50 text-sm text-gray-700">
            <i data-lucide="refresh-cw"></i>
            Disconnect
          </a>
        {% else %}
          <a href="/gmail/authorize" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border border-indigo-200 bg-white hover:bg-indigo-50 text-sm text-indigo-700">
            <i data-lucide="key"></i>
            Authorize Gmail
          </a>
        {% endif %}
        <button id="testEmailBtn" type="button" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border border-gray-200 bg-white hover:bg-gray-50 text-sm">
          <i data-lucide="mail"></i>
          Send Test Email
        </button>
      </div>
    <!-- Filters: Class and Minimum Balance -->
    <form method="get" class="flex flex-col lg:flex-row gap-3 items-start lg:items-end">
      <div>
        <label class="block text-xs text-gray-600 mb-1">Class</label>
        <select name="class" class="rounded-lg border-gray-300 text-sm min-w-[200px]">
          <option value="">All classes</option>
          {% for c in classes or [] %}
            <option value="{{ c }}" {% if selected_class==c %}selected{% endif %}>{{ c }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="block text-xs text-gray-600 mb-1">Minimum Balance (KES)</label>
        <input type="number" name="min_balance" step="0.01" min="0" value="{{ min_balance or 0 }}" class="rounded-lg border-gray-300 text-sm w-40">
      </div>
      <div class="flex-1 min-w-[240px]">
        <label class="block text-xs text-gray-600 mb-1">Search</label>
        <div class="relative">
          <i data-lucide="search" class="w-4 h-4 absolute left-3 top-2.5 text-gray-400"></i>
          <input type="text" name="q" value="{{ q or '' }}" placeholder="Search name, ID, admission no, email" class="w-full pl-9 rounded-lg border-gray-300 text-sm" />
          {% if q %}
          <a href="{{ url_for('reminders.reminders_home') }}?class={{ selected_class or '' }}&min_balance={{ min_balance or 0 }}" class="absolute right-3 top-2.5 text-xs text-gray-500 hover:text-gray-700">Clear</a>
          {% endif %}
        </div>
      </div>
      <div>
        <button class="btn-primary inline-flex items-center gap-2 px-4 py-2 rounded-lg">
          <i data-lucide="filter"></i>
          <span>Apply Filters</span>
        </button>
      </div>
    </form>
    

    <!-- Message Designer -->
    <div class="rounded-xl border border-gray-200 bg-gray-50 p-4">
      <div class="flex items-center justify-between mb-3">
        <label for="messageTemplate" class="text-sm font-medium text-gray-800">Message Template</label>
        <div class="flex items-center gap-2 text-xs">
          <span class="px-2 py-1 rounded-full bg-white border border-gray-200 text-gray-700">{name}</span>
          <span class="px-2 py-1 rounded-full bg-white border border-gray-200 text-gray-700">{balance}</span>
          <span class="px-2 py-1 rounded-full bg-white border border-gray-200 text-gray-700">{class_name}</span>
          <span class="px-2 py-1 rounded-full bg-white border border-gray-200 text-gray-700">{school_name}</span>
        </div>
      </div>
      <textarea id="messageTemplate" rows="4"
                class="w-full mt-1 rounded-lg border border-gray-300 bg-white p-3 text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none"
                placeholder="Type the message template here...">{{ default_message_template or 'Hello {name}, this is a fee reminder from {school_name}. Your outstanding balance is KES {balance}. Kindly clear at your earliest convenience.' }}</textarea>
      <div class="mt-2 flex items-center justify-between text-xs text-gray-500">
        <div>Use placeholders above to personalize messages.</div>
        <div id="charCount">0 characters</div>
      </div>
    </div>

    <!-- Bulk Action -->
    <form id="sendAllForm" action="{{ url_for('reminders.send_all_reminders') }}" method="post" class="flex items-center justify-between bg-white border border-gray-200 rounded-xl p-3">
      <div class="text-sm text-gray-600">Send to all contacts with an email using the message above.</div>
      <div class="flex items-center gap-2">
        <input type="hidden" name="message" id="sendAllMessage" />
        <button type="submit" class="btn-primary inline-flex items-center gap-2 px-4 py-2 rounded-lg">
          <i data-lucide="mail" class="w-4 h-4"></i>
          <span>Send All Via Email</span>
        </button>
      </div>
    </form>

    <!-- Recipients Table -->
    <div class="overflow-hidden rounded-xl border border-gray-200 bg-white">
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-50 text-gray-600">
          <tr>
            <th class="px-4 py-3 text-left">#</th>
            <th class="px-4 py-3 text-left">Student</th>
            <th class="px-4 py-3 text-left">Class</th>
            <th class="px-4 py-3 text-left">Balance</th>
            <th class="px-4 py-3 text-left">Email</th>
            <th class="px-4 py-3 text-center">Action</th>
          </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
          {% for s in students %}
            <tr class="hover:bg-gray-50/60">
              <td class="px-4 py-3 text-gray-500">{{ loop.index }}</td>
              <td class="px-4 py-3">
                <div class="flex items-center gap-3">
                  <span class="inline-flex h-8 w-8 items-center justify-center rounded-full bg-indigo-100 text-indigo-700 font-medium">
                    {{ (s.name[:1] if s.name else '?') | upper }}
                  </span>
                  <div>
                    <div class="font-medium text-gray-900">{{ s.name }}</div>
                    <div class="text-xs text-gray-500">ID: {{ s.id }}</div>
                  </div>
                </div>
              </td>
              <td class="px-4 py-3">
                {% if s.class_name %}
                  <span class="inline-flex px-2 py-1 rounded-md text-xs bg-indigo-50 text-indigo-700 border border-indigo-100">{{ s.class_name }}</span>
                {% else %}
                  <span class="text-gray-400 text-xs">-</span>
                {% endif %}
              </td>
            {% set bal = (s.balance or 0) %}
            <td class="px-4 py-3">
              <span class="balance-value {{ balance_class(bal) }}">KES {{ "{:,.2f}".format(bal) }}</span>
            </td>
              <td class="px-4 py-3">
                {% if s.email %}
                  <span class="inline-flex items-center gap-1 text-gray-700"><i data-lucide="mail" class="w-4 h-4"></i>{{ s.email }}</span>
                {% else %}
                  <span class="text-gray-400">N/A</span>
                {% endif %}
              </td>
              <td class="px-4 py-3 text-center">
                {% if s.balance > 0 and s.email %}
                  <a href="{{ url_for('reminders.send_email_reminder', student_id=s.id) }}"
                     class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-green-600 hover:bg-green-700 text-white shadow-sm"
                     onclick="return openSendModal({{ s.id }}, '{{ s.name|replace("'","\\'") }}', '{{ s.class_name|default('')|replace("'","\\'") }}', {{ (s.balance or 0)|float }}, '{{ s.email|default('')|replace("'","\\'") }}')">
                    <i data-lucide="send" class="w-4 h-4"></i>
                    <span>Send</span>
                  </a>
                {% else %}
                  <span class="text-gray-400 text-xs">No action</span>
                {% endif %}
              </td>
            </tr>
          {% else %}
            <tr>
              <td colspan="6" class="text-center text-gray-500 py-6">No students found.</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Premium Modal -->
<div id="sendModal" class="fixed inset-0 hidden items-center justify-center p-4">
  <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeSendModal()"></div>
  <div class="relative bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6 border border-gray-100">
    <div class="flex items-center justify-between mb-4">
      <h4 class="text-base font-semibold">Send Email Reminder</h4>
      <button class="text-gray-400 hover:text-gray-600" type="button" onclick="closeSendModal()"><i data-lucide="x"></i></button>
    </div>
    <div>
      <label class="text-xs text-gray-500">Preview</label>
      <div id="preview" class="mt-1 text-sm border border-gray-200 rounded-lg p-3 bg-gray-50"></div>
    </div>
    <form id="sendForm" method="post" class="mt-4">
      <input type="hidden" name="message" id="sendMessage" />
      <div class="flex justify-end gap-2">
        <button type="button" class="px-3 py-2 text-sm rounded-lg border border-gray-300 hover:bg-gray-50" onclick="closeSendModal()">Cancel</button>
        <button type="submit" class="btn-primary inline-flex items-center gap-2 px-4 py-2 rounded-lg">
          <i data-lucide="send"></i>
          <span>Send Email</span>
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  function fmt(num) { try { return Number(num).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}); } catch { return num; } }
  function openSendModal(id, name, className, balance, email) {
    const tpl = document.getElementById('messageTemplate').value || '';
    const msg = tpl
      .replaceAll('{name}', name)
      .replaceAll('{balance}', fmt(balance))
      .replaceAll('{class_name}', className || '');
    document.getElementById('preview').textContent = msg;
    document.getElementById('sendMessage').value = msg;
    const form = document.getElementById('sendForm');
    form.action = `{{ url_for('reminders.send_email_reminder', student_id=0) }}`.replace('/0', `/${id}`);
    const modal = document.getElementById('sendModal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    // Prevent default navigation when used on an <a> fallback
    return false;
  }
  function closeSendModal() {
    const modal = document.getElementById('sendModal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  }
  // Live character count
  (function(){
    const ta = document.getElementById('messageTemplate');
    const cc = document.getElementById('charCount');
    const update = ()=>{ if(ta&&cc){ cc.textContent = (ta.value||'').length + ' characters'; } };
    if (ta) { ta.addEventListener('input', update); update(); }
  })();
  // Attach message to bulk form on submit
  document.getElementById('sendAllForm')?.addEventListener('submit', () => {
    document.getElementById('sendAllMessage').value = document.getElementById('messageTemplate').value;
  });
  // Icons
  if (typeof lucide !== 'undefined' && lucide.createIcons) lucide.createIcons();
    // Test email helper
  document.getElementById('testEmailBtn')?.addEventListener('click', async () => {
    const to = prompt('Send test email to: (leave blank to use SCHOOL_EMAIL/MAIL_SENDER)') || undefined;
    try {
      const r = await fetch('/reminders/test_email', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({to})});
      const j = await r.json();
      if (j.ok) alert('Test email sent via: ' + j.via);
      else alert('Test failed: ' + (j.error || 'Unknown error'));
    } catch (e) { alert('Test failed.'); }
  });
  
</script>
{% endblock %}




