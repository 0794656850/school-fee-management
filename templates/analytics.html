{% extends "base.html" %}
{% block title %}SmartEduPay Analytics · {{ APP_TITLE }}{% endblock %}
{% block page_title %}SmartEduPay Insights{% endblock %}

{% block content %}
{% set mom_pct = analytics_payload.mom.percent_change if analytics_payload.mom else 0 %}
{% set mom_positive = mom_pct >= 0 %}
<div class="space-y-8">
  <section class="analytics-hero relative overflow-hidden rounded-3xl p-8 text-white shadow-[0_35px_60px_rgba(15,23,42,0.6)]">
    <div class="flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between">
      <div class="max-w-2xl space-y-4">
        <p class="text-xs uppercase tracking-[0.4em] text-slate-300">Fee Pulse · Live</p>
        <h1 class="text-3xl md:text-4xl font-semibold">Premium analytics for SmartEduPay</h1>
        <p class="text-sm text-slate-200">Your collections, class health, and alerts refreshed as each payment closes the books.</p>
        <div class="flex flex-wrap gap-3">
          <span class="rounded-full border border-white/30 px-4 py-1 text-[0.6rem] uppercase tracking-[0.4em] text-white/70">Scoped to current term</span>
          <span class="rounded-full border border-white/30 px-4 py-1 text-[0.6rem] uppercase tracking-[0.4em] text-white/70">Auto-refresh enabled</span>
        </div>
      </div>
      <div class="grid gap-4 sm:grid-cols-2">
        <div class="stat-card bg-white/10 text-slate-50">
          <p class="text-[0.7rem] uppercase tracking-[0.4em] text-slate-200">Monthly revenue</p>
          <p class="text-3xl font-semibold sat-gradient">KES {{ '{:,.0f}'.format(total_collected or 0) }}</p>
          <p class="text-xs {{ 'text-emerald-300' if mom_positive else 'text-rose-300' }}">
            {% set mom_sign = '+' if mom_pct >= 0 else '' %}
            {{ mom_sign }}{{ '{:,.1f}'.format(mom_pct) if mom_pct is not none else '0.0' }}% vs last month
          </p>
        </div>
        <div class="stat-card bg-white/10 text-slate-50">
          <p class="text-[0.7rem] uppercase tracking-[0.4em] text-slate-200">Avg. payment</p>
          <p class="text-3xl font-semibold sat-gradient">KES {{ '{:,.0f}'.format(avg_collection_per_student or 0) }}</p>
          <p class="text-xs text-slate-200">Across {{ total_students or 0 }} students</p>
        </div>
      </div>
    </div>
    <div class="mt-8 grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
      <article class="stat-pill stat-pill--pending">
        <p class="text-[0.65rem] uppercase tracking-[0.5em]">Pending balance</p>
        <p class="text-xl font-semibold balance-value balance-negative">KES {{ '{:,.0f}'.format(total_balance or 0) }}</p>
        <p class="text-[0.65rem] text-slate-300">Across {{ analytics_payload.meta.active_classes or 0 }} classes</p>
      </article>
      <article class="stat-pill stat-pill--rate">
        <p class="text-[0.65rem] uppercase tracking-[0.5em]">Collection rate</p>
        <p class="text-xl font-semibold text-white">{{ '{:,.0f}'.format(collection_rate_pct or 0) }}%</p>
        <p class="text-[0.65rem] text-slate-300">Percent of dues cleared</p>
      </article>
      <article class="stat-pill stat-pill--alert">
        <p class="text-[0.65rem] uppercase tracking-[0.5em]">Students in arrears</p>
        <p class="text-xl font-semibold">{{ analytics_payload.reminders.count or 0 }}</p>
        <p class="text-[0.65rem] text-slate-300">Triggered reminders</p>
      </article>
      <article class="stat-pill stat-pill--classes">
        <p class="text-[0.65rem] uppercase tracking-[0.5em]">Active classes</p>
        <p class="text-xl font-semibold">{{ analytics_payload.meta.active_classes or 0 }}</p>
        <p class="text-[0.65rem] text-slate-300">With enrolled students</p>
      </article>
    </div>
  </section>

  <section class="grid gap-4 lg:grid-cols-2">
    <article class="chart-card">
      <div>
        <p class="text-xs uppercase tracking-[0.3em] text-gray-500">Trend</p>
        <h3 class="text-xl font-semibold text-gray-900">Weekly Revenue Trend</h3>
        <p class="text-sm text-gray-500">Daily collections throughout the current week.</p>
      </div>
      <div class="chart-wrapper">
        <canvas id="weeklyRevenueChart"></canvas>
      </div>
    </article>
    <article class="chart-card">
      <div>
        <p class="text-xs uppercase tracking-[0.3em] text-gray-500">Grade view</p>
        <h3 class="text-xl font-semibold text-gray-900">Collection by Class</h3>
        <p class="text-sm text-gray-500">Top performing classes over the selected window.</p>
      </div>
      <div class="chart-wrapper">
        <canvas id="classCollectionChart"></canvas>
      </div>
    </article>
  </section>

  <section class="grid gap-4 md:grid-cols-2">
    <article class="chart-card">
      <div>
        <p class="text-xs uppercase tracking-[0.3em] text-gray-500">Method mix</p>
        <h3 class="text-xl font-semibold text-gray-900">Payment Method Distribution</h3>
        <p class="text-sm text-gray-500">Breakdown by cash, transfers, and wallets.</p>
      </div>
      <div class="chart-wrapper">
        <canvas id="paymentMethodChart"></canvas>
      </div>
    </article>
    <article class="chart-card">
      <div>
        <p class="text-xs uppercase tracking-[0.3em] text-gray-500">Clearance</p>
        <h3 class="text-xl font-semibold text-gray-900">Fee Clearance Status</h3>
        <p class="text-sm text-gray-500">Cleared vs pending amounts.</p>
      </div>
      <div class="chart-wrapper">
        <canvas id="feeClearanceChart"></canvas>
      </div>
    </article>
  </section>

  <section class="grid gap-4 lg:grid-cols-2">
    <article class="rounded-3xl border border-gray-100 bg-white p-6 shadow-xl space-y-4">
      <div>
        <p class="text-xs uppercase tracking-[0.3em] text-gray-400">Latest activity</p>
        <h3 class="text-xl font-semibold text-gray-900">Recent Payments</h3>
        <p class="text-sm text-gray-500">Transactions recorded in the last 10 entries.</p>
      </div>
      <div class="overflow-hidden rounded-2xl border border-gray-100">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50 text-gray-600 uppercase text-[0.65rem] tracking-[0.4em]">
            <tr>
              <th class="px-4 py-3 text-left">Student</th>
              <th class="px-4 py-3 text-left">Class</th>
              <th class="px-4 py-3 text-left">Amount</th>
              <th class="px-4 py-3 text-left">Method</th>
              <th class="px-4 py-3 text-left">Date</th>
            </tr>
          </thead>
          <tbody id="recentPaymentsBody" class="text-gray-700"></tbody>
        </table>
      </div>
    </article>
    <article class="rounded-3xl border border-gray-100 bg-white p-6 shadow-xl space-y-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs uppercase tracking-[0.3em] text-gray-400">Collections to chase</p>
            <h3 class="text-xl font-semibold text-gray-900">Top Debtors</h3>
          </div>
          <a class="text-xs font-semibold text-sky-500 hover:text-sky-600 transition" href="{{ url_for('reminders.reminders_home') }}">Review & remind</a>
        </div>
      <div class="space-y-3">
        {% for debtor in analytics_payload.top_debtors %}
          <article class="flex items-start justify-between rounded-2xl border border-gray-100 p-4 shadow-sm">
            <div>
              <p class="font-semibold text-gray-900">{{ debtor.name or 'Student' }}</p>
              <p class="text-xs text-gray-500">{{ debtor.class_name or 'Class unknown' }}</p>
            </div>
            <div class="text-sm font-semibold text-rose-600">KES {{ '{:,.0f}'.format(debtor.balance or 0) }}</div>
          </article>
        {% else %}
          <p class="text-sm text-gray-500">No outstanding debtors yet.</p>
        {% endfor %}
      </div>
    </article>
  </section>

  <section class="grid gap-4 lg:grid-cols-3">
    <article class="insight-card">
      <p class="text-xs uppercase tracking-[0.3em] text-gray-400">Payment alerts</p>
      <p class="text-2xl font-semibold text-gray-900">{{ analytics_payload.reminders.count or 0 }} students</p>
      <p class="text-sm text-gray-500">Have outstanding balances above {{ '{:,.0f}'.format(analytics_payload.reminders.threshold or 0) }} KES.</p>
      <a class="text-sm font-semibold text-amber-600" href="{{ url_for('reminders.reminders_home') }}">View list</a>
    </article>
    <article class="insight-card">
      <p class="text-xs uppercase tracking-[0.3em] text-gray-400">Fee deadline</p>
      <p class="text-2xl font-semibold text-gray-900">{{ '{:,.0f}'.format(analytics_payload.reminders.threshold or 0) }} KES</p>
      <p class="text-sm text-gray-500">Threshold for sending reminders this week.</p>
      <a class="text-sm font-semibold text-sky-600" href="{{ url_for('reminders.reminders_home') }}">Send reminder</a>
    </article>
    <article class="insight-card">
      <p class="text-xs uppercase tracking-[0.3em] text-gray-400">Trend</p>
      <p class="text-2xl font-semibold {{ 'text-emerald-600' if mom_positive else 'text-rose-500' }}">
        {% if mom_pct >= 0 %}+{% endif %}{{ '{:,.1f}'.format(mom_pct if mom_pct is not none else 0) }}
        %
      </p>
      <p class="text-sm text-gray-500">Collections vs last month</p>
      <a class="text-sm font-semibold text-emerald-600" href="{{ url_for('analytics_dashboard') }}">View details</a>
    </article>
  </section>

  <section class="grid gap-4 lg:grid-cols-2">
    <article class="chart-card">
      <div>
        <p class="text-xs uppercase tracking-[0.3em] text-gray-500">Revenue streak</p>
        <h3 class="text-xl font-semibold text-gray-900">Monthly Revenue Trend</h3>
        <p class="text-sm text-gray-500">Revenue and payment count over time.</p>
      </div>
      <div class="chart-wrapper">
        <canvas id="monthlyTrendChart"></canvas>
      </div>
    </article>
    <article class="chart-card">
      <div>
        <p class="text-xs uppercase tracking-[0.3em] text-gray-500">Grade impact</p>
        <h3 class="text-xl font-semibold text-gray-900">Payments Per Class</h3>
        <p class="text-sm text-gray-500">Total collections by grade level.</p>
      </div>
      <div class="chart-wrapper">
        <canvas id="paymentsPerClassChart"></canvas>
      </div>
    </article>
  </section>
</div>

<script>
  const analyticsPayload = {{ analytics_payload | tojson }};
  const topClasses = {{ top_classes | tojson }};
  const totals = analyticsPayload.totals || { collected: 0, pending: 0 };

  const weeklyTrend = (analyticsPayload.daily_trend || []).slice().sort((a, b) => new Date(a.day) - new Date(b.day)).slice(-7);
  const monthlyTrend = (analyticsPayload.monthly_data || [])
    .filter(row => row && row.month)
    .slice()
    .sort((a, b) => new Date(`${a.month}-01`) - new Date(`${b.month}-01`));
  const classSummary = topClasses || [];
  const methodBreakdown = analyticsPayload.method_breakdown || [];
  const recentPayments = (analyticsPayload.recent_payments || []).slice(0, 6);

  const palette = ['#2563eb', '#10b981', '#f97316', '#a855f7', '#3b82f6'];
  const dateFormatter = new Intl.DateTimeFormat('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

  function safeNumber(value) {
    return Number.isFinite(value) ? value : Number(value) || 0;
  }

  function buildLineChart(canvasId, labels, data, label, color) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;
    new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label,
          data,
          borderColor: color,
          backgroundColor: `${color}33`,
          pointBorderColor: color,
          pointBackgroundColor: '#fff',
          pointBorderWidth: 2,
          pointRadius: 4,
          fill: true,
          tension: 0.4,
        }],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: { legend: { display: false } },
        scales: {
          x: { grid: { display: false }, ticks: { color: '#6b7280' } },
          y: { grid: { color: '#e5e7eb' }, beginAtZero: true, ticks: { color: '#6b7280' } },
        },
      },
    });
  }

  function buildBarChart(canvasId, labels, data) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Collected',
          data,
          backgroundColor: '#2563eb',
          borderRadius: 8,
          maxBarThickness: 30,
        }],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { grid: { display: false }, ticks: { color: '#6b7280' } },
          y: { grid: { color: '#e5e7eb' }, beginAtZero: true, ticks: { color: '#6b7280' } },
        },
      },
    });
  }

  function buildPieChart(canvasId, labels, data, colors) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;
    new Chart(ctx, {
      type: 'pie',
      data: { labels, datasets: [{ data, backgroundColor: colors }] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom' } },
      },
    });
  }

  function buildDoughnutChart(canvasId, cleared, pending) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Cleared', 'Pending'],
        datasets: [{ data: [cleared, pending], backgroundColor: ['#22c55e', '#f97316'] }],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '60%',
        plugins: { legend: { position: 'bottom' } },
      },
    });
  }

  function populateRecentPayments() {
    const body = document.getElementById('recentPaymentsBody');
    if (!body) return;
    if (!recentPayments.length) {
      body.innerHTML = '<tr><td colspan="5" class="px-4 py-3 text-center text-sm text-gray-400">No payments yet.</td></tr>';
      return;
    }
    body.innerHTML = recentPayments.map(payment => {
      const dateValue = new Date(payment.date);
      const readableDate = Number.isNaN(dateValue)
        ? payment.date
        : dateFormatter.format(dateValue);
      return `
        <tr class="border-b border-gray-100">
          <td class="px-4 py-3 font-medium text-gray-900">${payment.student}</td>
          <td class="px-4 py-3 text-gray-700">${payment.class_name}</td>
          <td class="px-4 py-3 text-gray-700">KES ${safeNumber(payment.amount).toLocaleString()}</td>
          <td class="px-4 py-3 text-gray-600">${payment.method}</td>
          <td class="px-4 py-3 text-gray-500">${readableDate}</td>
        </tr>
      `;
    }).join('');
  }

  document.addEventListener('DOMContentLoaded', () => {
    const weeklyLabels = weeklyTrend.map(row => dateFormatter.format(new Date(row.day)));
    const weeklyTotals = weeklyTrend.map(row => safeNumber(row.total));
    buildLineChart('weeklyRevenueChart', weeklyLabels, weeklyTotals, 'Daily collections', '#2563eb');

    const classLabels = classSummary.map(row => row.class_name || 'Class');
    const classTotals = classSummary.map(row => safeNumber(row.total_paid));
    buildBarChart('classCollectionChart', classLabels, classTotals);

    const methodLabels = methodBreakdown.map(row => row.method || 'Method');
    const methodTotals = methodBreakdown.map(row => safeNumber(row.total));
    buildPieChart('paymentMethodChart', methodLabels, methodTotals, palette);

    buildDoughnutChart('feeClearanceChart', safeNumber(totals.collected), safeNumber(totals.pending));

    const monthlyLabels = monthlyTrend.map(row => row.month ? row.month.replace('-', ' ') : '');
    const monthlyTotals = monthlyTrend.map(row => safeNumber(row.total));
    buildLineChart('monthlyTrendChart', monthlyLabels, monthlyTotals, 'Revenue trend', '#10b981');

    const paymentsClassLabels = classSummary.map(row => row.class_name || 'Class');
    const paymentsClassTotals = classSummary.map(row => safeNumber(row.total_paid));
    buildBarChart('paymentsPerClassChart', paymentsClassLabels, paymentsClassTotals);

    populateRecentPayments();
  });
</script>

{% endblock %}
