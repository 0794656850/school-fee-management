{% extends "base.html" %}
{% block title %}Analytics Overview{% endblock %}
{% block page_title %}Analytics Overview{% endblock %}
{% block content %}

<!-- ===== Summary Cards ===== -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">

  <!-- Total Students -->
  <div class="rounded-2xl bg-gradient-to-br from-sky-500 via-sky-600 to-blue-700 text-white p-6 shadow-md hover:shadow-lg transition transform hover:-translate-y-1">
    <h3 class="text-sm uppercase tracking-wide opacity-80 mb-1">Total Students</h3>
    <p id="total_students" class="text-3xl font-bold tracking-tight">{{ total_students }}</p>
    <div class="mt-2 h-1.5 w-20 bg-white/40 rounded-full"></div>
  </div>

  <!-- Total Fees Collected -->
  <div class="rounded-2xl bg-gradient-to-br from-emerald-500 via-green-600 to-teal-700 text-white p-6 shadow-md hover:shadow-lg transition transform hover:-translate-y-1">
    <h3 class="text-sm uppercase tracking-wide opacity-80 mb-1">Total Fees Collected</h3>
    <p id="total_collected" class="text-3xl font-bold tracking-tight">KES {{ "{:,.2f}".format(total_collected or 0) }}</p>
    <div class="mt-2 h-1.5 w-20 bg-white/40 rounded-full"></div>
  </div>

  <!-- Pending Balance -->
  <div class="rounded-2xl bg-gradient-to-br from-rose-500 via-red-600 to-pink-700 text-white p-6 shadow-md hover:shadow-lg transition transform hover:-translate-y-1">
    <h3 class="text-sm uppercase tracking-wide opacity-80 mb-1">Pending Balance</h3>
    <p id="total_balance" class="text-3xl font-bold tracking-tight">KES {{ "{:,.2f}".format(total_balance or 0) }}</p>
    <div class="mt-2 h-1.5 w-20 bg-white/40 rounded-full"></div>
  </div>

</div>

<!-- ===== Monthly Chart ===== -->
<div class="bg-white rounded-2xl p-8 shadow-sm border border-gray-100 mb-10 transition hover:shadow-md">
  <h3 class="text-lg font-semibold mb-4 text-gray-800 flex items-center gap-2">
    <i data-lucide="bar-chart-2" class="text-sky-600"></i> Monthly Fee Collections
  </h3>
  <canvas id="monthlyChart" height="100"></canvas>
</div>

<!-- ===== Class Summary ===== -->
<div class="bg-white rounded-2xl p-8 shadow-sm border border-gray-100 hover:shadow-md transition">
  <h3 class="text-lg font-semibold mb-4 text-gray-800 flex items-center gap-2">
    <i data-lucide="layers" class="text-emerald-600"></i> Class Fee Summary
  </h3>

  <table class="w-full text-sm text-left border-collapse">
    <thead class="border-b bg-gray-50 font-semibold text-gray-600 uppercase text-xs tracking-wide">
      <tr>
        <th class="py-2 px-3">Class</th>
        <th class="py-2 px-3 text-center">Students</th>
        <th class="py-2 px-3 text-right">Paid (KES)</th>
        <th class="py-2 px-3 text-right">Pending (KES)</th>
        <th class="py-2 px-3 text-center">% Paid</th>
      </tr>
    </thead>
    <tbody id="class_summary">
      <tr><td colspan="5" class="text-center text-gray-400 py-3">Loading...</td></tr>
    </tbody>
  </table>
</div>

<!-- ===== Scripts ===== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let chart;

// --- Render Monthly Chart ---
function renderChart(data) {
  const ctx = document.getElementById('monthlyChart').getContext('2d');
  const labels = data.map(m => m.month);
  const totals = data.map(m => m.total);

  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'KES Collected',
        data: totals,
        borderRadius: 6,
        backgroundColor: 'rgba(56, 189, 248, 0.8)', // Sky blue accent
        hoverBackgroundColor: 'rgba(56, 189, 248, 1)',
      }]
    },
    options: {
      responsive: true,
      scales: {
        x: { ticks: { color: '#475569' }, grid: { color: '#f1f5f9' } },
        y: { 
          beginAtZero: true, 
          ticks: { color: '#475569', callback: v => 'KES ' + v.toLocaleString() },
          grid: { color: '#f1f5f9' } 
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(15, 23, 42, 0.85)',
          titleColor: '#fff',
          bodyColor: '#e2e8f0',
          borderColor: '#334155',
          borderWidth: 1
        }
      }
    }
  });
}

// --- Update Analytics (Real-Time) ---
function updateAnalytics() {
  fetch('/api/analytics_data')
    .then(res => res.json())
    .then(data => {
      // Update totals
      fetch('/api/dashboard_data')
        .then(r => r.json())
        .then(summary => {
          document.getElementById('total_students').innerText = summary.total_students;
          document.getElementById('total_collected').innerText = `KES ${summary.total_collected.toLocaleString()}`;
          document.getElementById('total_balance').innerText = `KES ${summary.total_balance.toLocaleString()}`;
        });

      // Chart
      renderChart(data.monthly_data);

      // Class Summary
      const tbody = document.getElementById('class_summary');
      tbody.innerHTML = '';
      data.class_summary.forEach(c => {
        const paid = Number(c.total_paid || 0);
        const pending = Number(c.total_pending || 0);
        const percent = c.percent_paid || 0;

        let barColor;
        if (percent >= 80) barColor = 'bg-emerald-500';
        else if (percent >= 50) barColor = 'bg-amber-400';
        else barColor = 'bg-rose-500';

        tbody.innerHTML += `
          <tr class="border-b last:border-0 hover:bg-gray-50 transition">
            <td class="py-2 px-3 font-medium text-gray-800">${c.class_name}</td>
            <td class="py-2 px-3 text-center text-gray-700">${c.total_students}</td>
            <td class="py-2 px-3 text-right text-emerald-600 font-semibold">KES ${paid.toLocaleString()}</td>
            <td class="py-2 px-3 text-right text-rose-600 font-semibold">KES ${pending.toLocaleString()}</td>
            <td class="py-2 px-3 text-center">
              <div class="w-full bg-slate-200 rounded-full h-2.5 overflow-hidden mb-1">
                <div class="${barColor} h-2.5 rounded-full transition-all" style="inline-size:${percent}%"></div>
              </div>
              <span class="text-xs text-slate-600 font-medium">${percent}%</span>
            </td>
          </tr>`;
      });
    })
    .catch(err => console.error('Error fetching analytics data:', err));
}

// Auto-refresh every 20s
setInterval(updateAnalytics, 10000);
document.addEventListener('DOMContentLoaded', updateAnalytics);
</script>

{% endblock %}
