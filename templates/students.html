{% extends "base.html" %}
{% block title %}Students - CS Fee Management{% endblock %}
{% block page_title %}All Students{% endblock %}
{% block content %}

<div class="bg-white/90 backdrop-blur-md border border-gray-100 rounded-2xl shadow-sm p-8">

  <!-- Header -->
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-6">
    <h3 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
      <i data-lucide="users" class="text-blue-600"></i> Student Management
    </h3>

    <div class="flex flex-col sm:flex-row gap-3 items-center w-full md:w-auto">

      <!-- Search -->
      <div class="relative flex items-center w-full sm:w-auto">
        <i data-lucide="search" class="absolute left-3 text-gray-400 w-4 h-4"></i>
        <input id="searchInput" 
               type="text" 
               placeholder="Search by name or admission no..." 
               class="border border-gray-200 rounded-lg pl-9 pr-3 py-2 text-sm w-full sm:w-64 focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
      </div>

      <!-- Class Filter -->
      <select id="classFilter" 
              class="border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none bg-white transition">
        <option value="">All Classes</option>
        {% for s in students|map(attribute='class_name')|unique %}
          <option value="{{ s }}">{{ s }}</option>
        {% endfor %}
      </select>

      <!-- Add Student Button -->
      <a href="{{ url_for('add_student') }}" 
         class="inline-flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-700 hover:to-blue-600 text-white text-sm font-medium rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition">
        <i data-lucide="plus-circle" class="w-4 h-4"></i> Add Student
      </a>
    </div>
  </div>

  <!-- Table -->
  <div class="overflow-x-auto rounded-xl border border-gray-100">
    <table class="min-w-full text-sm">
      <thead class="bg-gray-50/70 text-gray-600 font-medium uppercase tracking-wide text-xs">
        <tr>
          <th class="px-5 py-3 text-left border-b">#</th>
          <th class="px-5 py-3 text-left border-b">Name</th>
          <th class="px-5 py-3 text-left border-b">Admission No</th>
          <th class="px-5 py-3 text-left border-b">Class</th>
          <th class="px-5 py-3 text-left border-b">Balance (KES)</th>
          <th class="px-5 py-3 text-center border-b">Actions</th>
        </tr>
      </thead>
      <tbody id="studentRows" class="divide-y divide-gray-100">
        {% for s in students %}
        <tr class="hover:bg-blue-50/40 transition">
          <td class="px-5 py-3 text-gray-600">{{ loop.index }}</td>
          <td class="px-5 py-3 font-medium text-gray-800">{{ s.name }}</td>
          <td class="px-5 py-3 text-gray-500">{{ s.admission_no or '-' }}</td>
          <td class="px-5 py-3 text-gray-700">{{ s.class_name }}</td>
          <td class="px-5 py-3 text-right font-semibold {% if s.balance <= 0 %}text-green-600{% else %}text-blue-600{% endif %}">
            {{ '{:,.2f}'.format(s.balance or 0) }}
          </td>
          <td class="px-5 py-3 text-center flex justify-center gap-3">
            <a href="{{ url_for('student_detail', student_id=s.id) }}" 
               class="text-blue-600 hover:text-blue-800 font-medium flex items-center gap-1 transition">
              <i data-lucide="eye" class="w-4 h-4"></i> View
            </a>
            <form action="{{ url_for('delete_student', student_id=s.id) }}" method="POST" class="inline">
              <button type="submit" 
                      onclick="return confirm('Are you sure you want to delete this student?')" 
                      class="text-red-600 hover:text-red-800 font-medium flex items-center gap-1 transition">
                <i data-lucide="trash-2" class="w-4 h-4"></i> Delete
              </button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="6" class="text-center text-gray-500 py-6">No students found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- JavaScript -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  lucide.createIcons();

  const searchInput = document.getElementById("searchInput");
  const classFilter = document.getElementById("classFilter");
  const studentRows = document.getElementById("studentRows");

  function fetchStudents() {
    const query = searchInput.value.trim();
    const selectedClass = classFilter.value.trim();

    fetch(`/search_student?query=${encodeURIComponent(query)}`)
      .then(res => res.json())
      .then(data => {
        let filtered = data;
        if (selectedClass) {
          filtered = filtered.filter(s => s.class_name === selectedClass);
        }

        studentRows.innerHTML = filtered.length
          ? filtered.map((s, i) => `
              <tr class="hover:bg-blue-50/40 transition">
                <td class="px-5 py-3 text-gray-600">${i + 1}</td>
                <td class="px-5 py-3 font-medium text-gray-800">${s.name}</td>
                <td class="px-5 py-3 text-gray-500">${s.admission_no || '-'}</td>
                <td class="px-5 py-3 text-gray-700">${s.class_name}</td>
                <td class="px-5 py-3 text-right font-semibold ${parseFloat(s.balance) <= 0 ? 'text-green-600' : 'text-blue-600'}">
                  ${parseFloat(s.balance || 0).toFixed(2)}
                </td>
                <td class="px-5 py-3 text-center flex justify-center gap-3">
                  <a href="/student/${s.id}" class="text-blue-600 hover:text-blue-800 font-medium flex items-center gap-1 transition">
                    <i data-lucide='eye' class="w-4 h-4"></i> View
                  </a>
                </td>
              </tr>
            `).join('')
          : `<tr><td colspan="6" class="text-center text-gray-500 py-6">No students found.</td></tr>`;

        lucide.createIcons();
      });
  }

  searchInput.addEventListener("input", fetchStudents);
  classFilter.addEventListener("change", fetchStudents);
});
</script>

{% endblock %}
