{% extends "base.html" %}
{% block title %}Admin Dashboard{% endblock %}
{% block page_title %}Admin Control Center{% endblock %}
{% block content %}

<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
  <div class="bg-gradient-to-br from-blue-600 to-indigo-600 text-white rounded-2xl p-5 shadow">
    <div class="text-sm opacity-90">Students</div>
    <div class="text-3xl font-bold">{{ total_students }}</div>
    <div class="text-xs opacity-80 mt-1">as of {{ now.strftime('%b %d, %Y') }}</div>
  </div>

  <div class="mt-4 rounded-2xl border border-dashed border-gray-200 bg-gradient-to-br from-white via-slate-50 to-slate-100 p-5 shadow-sm">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-xs uppercase tracking-[0.4em] text-gray-400">Portal settings</p>
        <p class="text-lg font-semibold text-gray-900">Fine-tune your admin view</p>
      </div>
      <i data-lucide="sliders" class="text-indigo-600"></i>
    </div>
    <p class="mt-2 text-xs text-gray-600 max-w-sm">These toggles keep the control center tidy on this device, while the full settings page remains your source of truth.</p>
    <div class="mt-4 grid grid-cols-2 gap-3">
      <button
        type="button"
        data-setting="adminCompactStats"
        class="rounded-2xl border border-gray-200 bg-white/80 px-3 py-2 text-left text-sm text-gray-700 transition focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-500"
        aria-pressed="false"
      >
        <div class="font-semibold">Compact stats</div>
        <div class="text-xs text-gray-500" data-setting-status="adminCompactStats">Off</div>
      </button>
      <button
        type="button"
        data-setting="adminHighlightLinks"
        class="rounded-2xl border border-gray-200 bg-white/80 px-3 py-2 text-left text-sm text-gray-700 transition focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-500"
        aria-pressed="false"
      >
        <div class="font-semibold">Focus highlights</div>
        <div class="text-xs text-gray-500" data-setting-status="adminHighlightLinks">Off</div>
      </button>
    </div>
    <div class="mt-3 flex flex-wrap gap-2">
      <a href="{{ url_for('admin.access_settings') }}" class="inline-flex items-center gap-1 text-xs uppercase tracking-[0.3em] text-indigo-700">
        Open full settings
        <i data-lucide="arrow-right"></i>
      </a>
    </div>
  </div>
  <div class="bg-gradient-to-br from-emerald-600 to-teal-600 text-white rounded-2xl p-5 shadow">
    <div class="text-sm opacity-90">Total Collected</div>
    <div class="text-3xl font-bold">KES {{ "{:,.2f}".format(total_collected) }}</div>
    <div class="text-xs opacity-80 mt-1">lifetime</div>
  </div>
  <div class="bg-gradient-to-br from-rose-600 to-orange-600 text-white rounded-2xl p-5 shadow">
    <div class="text-sm opacity-90">Outstanding Balance</div>
    <div class="text-3xl font-bold">KES {{ "{:,.2f}".format(total_balance) }}</div>
    <div class="text-xs opacity-80 mt-1">current</div>
  </div>
  </div>

{% if terms is defined %}
<div class="mt-8 grid grid-cols-1">
  <div class="bg-white border border-gray-100 rounded-2xl p-6 shadow-sm">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-semibold flex items-center gap-2"><i data-lucide="calendar"></i> Academic Terms</h3>
      {% if current_year and current_term %}
      <span class="text-xs px-2 py-1 rounded bg-indigo-50 text-indigo-700 border border-indigo-200">Current: {{ current_year }} - Term {{ current_term }}</span>
      {% endif %}
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm border rounded-xl overflow-hidden">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-3 py-2 text-left border-b">Year</th>
            <th class="px-3 py-2 text-left border-b">Term</th>
            <th class="px-3 py-2 text-left border-b">Label</th>
            <th class="px-3 py-2 text-left border-b">Start</th>
            <th class="px-3 py-2 text-left border-b">End</th>
            <th class="px-3 py-2 text-left border-b">Current</th>
          </tr>
        </thead>
        <tbody>
          {% for r in terms %}
          <tr class="hover:bg-gray-50">
            <td class="px-3 py-2 border-b">{{ r.year }}</td>
            <td class="px-3 py-2 border-b">{{ r.term }}</td>
            <td class="px-3 py-2 border-b">{{ r.label or '-' }}</td>
            <td class="px-3 py-2 border-b">{{ r.start_date or '-' }}</td>
            <td class="px-3 py-2 border-b">{{ r.end_date or '-' }}</td>
            <td class="px-3 py-2 border-b">{% if r.is_current %}<span class="text-emerald-700 text-xs px-2 py-0.5 rounded bg-emerald-50 border border-emerald-200">Current</span>{% endif %}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
  <div class="mt-3"><a href="{{ url_for('terms.term_summary') }}" class="inline-flex items-center gap-2 bg-gray-100 text-gray-700 hover:bg-gray-200 rounded-lg text-sm px-3 py-1.5"><i data-lucide="book-open"></i> Term Summary</a></div>
      <div class="mt-3">
        <a href="{{ url_for('terms.manage_term_fees') }}" class="inline-flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm px-3 py-1.5">
          <i data-lucide="settings"></i> Manage Term Fees
        </a>
      </div>
    </div>
    <form action="{{ url_for('terms.set_current') }}" method="post" class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-3">
      <input type="number" name="year" min="2000" max="2100" placeholder="Year" value="{{ CURRENT_YEAR or '' }}" class="border border-gray-200 rounded-lg p-2 text-sm" required>
      <select name="term" class="border border-gray-200 rounded-lg p-2 text-sm" required>
        <option value="">Select term</option>
        <option value="1" {% if (CURRENT_TERM or 0) == 1 %}selected{% endif %}>Term 1</option>
        <option value="2" {% if (CURRENT_TERM or 0) == 2 %}selected{% endif %}>Term 2</option>
        <option value="3" {% if (CURRENT_TERM or 0) == 3 %}selected{% endif %}>Term 3</option>
      </select>
      <button class="bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm px-3">Set Current</button>
    </form>

    <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
      <form action="{{ url_for('terms.open_term_route') }}" method="post" class="flex items-center gap-2">
        <input type="hidden" name="year" value="{{ CURRENT_YEAR or '' }}">
        <input type="hidden" name="term" value="{{ CURRENT_TERM or '' }}">
        <button class="bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-sm px-3 py-1">Open Current Term</button>
      </form>
      <form action="{{ url_for('terms.close_term_route') }}" method="post" class="flex items-center gap-2 justify-end">
        <input type="hidden" name="year" value="{{ CURRENT_YEAR or '' }}">
        <input type="hidden" name="term" value="{{ CURRENT_TERM or '' }}">
        <button class="bg-rose-600 hover:bg-rose-700 text-white rounded-lg text-sm px-3 py-1">Close Current Term</button>
      </form>
    </div>

    <form action="{{ url_for('terms.start_new_year') }}" method="post" class="mt-3">
      <div class="flex items-center justify-between bg-amber-50 border border-amber-200 rounded-lg p-3">
        <div>
          <div class="text-sm font-medium text-amber-800">Start New Academic Year</div>
          <div class="text-xs text-amber-700">Seeds next year's terms and creates enrollments for all continuing students (balances carried forward).</div>
        </div>
        <button class="bg-amber-600 hover:bg-amber-700 text-white rounded-lg text-sm px-3 py-1">Prepare Next Year</button>
      </div>
    </form>
  </div>
  <script>lucide.createIcons();</script>
  </div>
{% endif %}

{# Billing & Upgrade section removed #}

{# Removed M-Pesa (Daraja) setup card per request #}

<div class="mt-6">
  <a href="{{ url_for('admin.school_profile') }}" class="inline-flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm px-3 py-1.5">
    <i data-lucide="building-2"></i>
    <span>School Profile</span>
  </a>
  <a href="{{ url_for('admin.manage_users') }}" class="inline-flex items-center gap-2 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-lg text-sm px-3 py-1.5 ml-2">
    <i data-lucide="users"></i>
    <span>Users & Roles</span>
  </a>
  <a href="{{ url_for('admin.admin_backups') }}" class="inline-flex items-center gap-2 bg-amber-100 hover:bg-amber-200 text-amber-800 rounded-lg text-sm px-3 py-1.5 ml-2">
    <i data-lucide="shield"></i>
    <span>Backups & Restore</span>
  </a>
  {# System Health removed #}
  {# Schools management disabled: link removed intentionally #}
</div>
{% endblock %}



