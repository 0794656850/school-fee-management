{% extends "base.html" %}
{% block title %}Access & Security - {{ APP_TITLE }}{% endblock %}
{% block page_title %}Access & Security{% endblock %}
{% block content %}

<div class="grid md:grid-cols-2 gap-6">
  <!-- Access Settings -->
  <div class="bg-white border border-gray-100 rounded-2xl p-6 shadow-sm">
    <div class="flex items-center justify-between mb-2">
      <h3 class="text-base font-semibold">Access Settings</h3>
      <span class="text-[10px] px-2 py-0.5 rounded-full bg-indigo-50 text-indigo-700 border border-indigo-100">Portal</span>
    </div>
    <p class="text-sm text-gray-600 mb-4">Set the username and password used for normal portal login (non-admin).</p>

    <form method="post" class="space-y-4">
      <input type="hidden" name="form" value="access" />
      <div>
        <label class="block text-sm font-medium text-gray-700">Username</label>
        <input type="text" name="APP_LOGIN_USERNAME" value="{{ values.APP_LOGIN_USERNAME or '' }}"
               class="mt-1 w-full border border-gray-200 rounded-lg p-2.5 text-sm" placeholder="e.g. bursar" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Password</label>
        <input type="password" name="APP_LOGIN_PASSWORD" value=""
               class="mt-1 w-full border border-gray-200 rounded-lg p-2.5 text-sm" placeholder="Leave blank to keep current">
        <p class="text-xs text-gray-500 mt-1">Stored securely (hashed). Leave blank to keep current.</p>
      </div>
      <button class="bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg px-4 py-2">Save Access</button>
    </form>
  </div>

  <!-- Admin Security -->
  <div class="bg-white border border-gray-100 rounded-2xl p-6 shadow-sm">
    <div class="flex items-center justify-between mb-2">
      <h3 class="text-base font-semibold">Admin Security</h3>
      <span class="text-[10px] px-2 py-0.5 rounded-full bg-rose-50 text-rose-700 border border-rose-100">Secure</span>
    </div>
    <p class="text-sm text-gray-600 mb-4">Change the global admin password.</p>

    <form method="post" class="space-y-3">
      <input type="hidden" name="form" value="admin_pwd" />
      <div>
        <label class="block text-sm font-medium text-gray-700">Current Password</label>
        <input required type="password" name="current_password" class="mt-1 w-full border border-gray-200 rounded-lg p-2.5 text-sm" placeholder="Enter current admin password" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">New Password</label>
        <input required type="password" name="new_password" class="mt-1 w-full border border-gray-200 rounded-lg p-2.5 text-sm" placeholder="At least 6 characters" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Confirm New Password</label>
        <input required type="password" name="confirm_password" class="mt-1 w-full border border-gray-200 rounded-lg p-2.5 text-sm" placeholder="Re-enter new password" />
      </div>
      <button class="bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg px-4 py-2">Update Password</button>
    </form>
  </div>

  
  <!-- Email (Gmail API) -->
  <div class="bg-white border border-gray-100 rounded-2xl p-6 shadow-sm">
    <div class="flex items-center justify-between mb-2">
      <h3 class="text-base font-semibold">Email (Gmail API)</h3>
      <span class="text-[10px] px-2 py-0.5 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100">Default</span>
    </div>
    <p class="text-sm text-gray-600 mb-4">Reminders and payment receipts are sent via email by default using the Gmail API. Place your OAuth client JSON at <code>credentials.json</code>. The token is saved to <code>token.json</code> after authorization.</p>
    <div class="flex items-center gap-2">
      <button id="adminTestEmailBtn" type="button" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border border-gray-200 bg-white hover:bg-gray-50 text-sm">
        <i data-lucide="mail"></i>
        Send Test Email
      </button>
      <a href="{{ url_for('reminders.reminders_home') }}" class="px-3 py-1.5 rounded-lg border border-gray-300 hover:bg-gray-50 inline-flex items-center gap-2 text-sm"><i data-lucide="send"></i><span>Open Reminder Center</span></a>
    </div>
  </div>

  <!-- Reminder Settings (Pro) -->
  <div class="bg-white border border-gray-100 rounded-2xl p-6 shadow-sm">
    <div class="flex items-center justify-between mb-2">
      <h3 class="text-base font-semibold">Reminder Settings</h3>
      <span class="text-[10px] px-2 py-0.5 rounded-full bg-indigo-50 text-indigo-700 border border-indigo-100">Premium</span>
    </div>
    <p class="text-sm text-gray-600 mb-4">Choose which email column to use when sending reminders and set a default message template. Placeholders: {name}, {balance}, {class_name}, {school_name}.</p>

    <form method="post" class="space-y-3">
      <input type="hidden" name="form" value="reminders" />
      <div>
        <label class="block text-sm font-medium text-gray-700">Student Email Column</label>
        <input type="text" name="REMINDER_EMAIL_COLUMN" value="{{ values.REMINDER_EMAIL_COLUMN or 'email' }}" class="mt-1 w-full border border-gray-200 rounded-lg p-2.5 text-sm" placeholder="e.g. email or parent_email">
        <p class="text-xs text-gray-500 mt-1">This must match a column in the students table.</p>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Default Message</label>
        <textarea name="REMINDER_DEFAULT_MESSAGE" rows="3" class="mt-1 w-full border border-gray-200 rounded-lg p-2.5 text-sm" placeholder="Message template">{{ values.REMINDER_DEFAULT_MESSAGE }}</textarea>
      </div>
      <div class="flex items-center gap-2">
        <button class="bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg px-4 py-2">Save Reminders</button>
        <a href="{{ url_for('reminders.reminders_home') }}" class="px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-50 inline-flex items-center gap-2"><i data-lucide="send"></i><span>Open Reminder Center</span></a>
      </div>
    </form>
  </div>

  <!-- AI Assistant Settings (Vertex AI) -->
  <div class="bg-white border border-gray-100 rounded-2xl p-6 shadow-sm">
    <div class="flex items-center justify-between mb-2">
      <h3 class="text-base font-semibold">AI Assistant</h3>
      <span class="text-[10px] px-2 py-0.5 rounded-full bg-gray-50 text-gray-700 border border-gray-200">Optional</span>
    </div>
    <p class="text-sm text-gray-600 mb-4">Configure Vertex AI (Gemini) to enable intelligent answers in the in-app assistant.</p>

    <form method="post" class="space-y-3">
      <input type="hidden" name="form" value="ai" />
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm font-medium text-gray-700">GCP Project ID</label>
          <input type="text" name="VERTEX_PROJECT_ID" value="{{ values.VERTEX_PROJECT_ID or '' }}" class="mt-1 w-full border border-gray-200 rounded-lg p-2.5 text-sm" placeholder="my-gcp-project" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Region</label>
          <input type="text" name="VERTEX_LOCATION" value="{{ values.VERTEX_LOCATION or 'us-central1' }}" class="mt-1 w-full border border-gray-200 rounded-lg p-2.5 text-sm" placeholder="us-central1" />
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm font-medium text-gray-700">Service Account JSON (path)</label>
          <input type="text" name="GOOGLE_APPLICATION_CREDENTIALS" value="{{ values.GOOGLE_APPLICATION_CREDENTIALS or '' }}" class="mt-1 w-full border border-gray-200 rounded-lg p-2.5 text-sm" placeholder="C:\\path\\to\\sa.json (optional if using ADC)" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Gemini Model</label>
          <input type="text" name="VERTEX_GEMINI_MODEL" value="{{ values.VERTEX_GEMINI_MODEL or 'gemini-1.5-flash' }}" class="mt-1 w-full border border-gray-200 rounded-lg p-2.5 text-sm" placeholder="gemini-1.5-flash" />
        </div>
      </div>
      <p class="text-xs text-gray-500">Settings are stored in the app DB; environment variables still work and take precedence.</p>
      <button class="bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg px-4 py-2">Save Vertex Settings</button>
    </form>
  </div>
</div>

<script>
  // Icons
  if (typeof lucide !== 'undefined' && lucide.createIcons) lucide.createIcons();
  // Admin: test email using reminders endpoint
  document.getElementById('adminTestEmailBtn')?.addEventListener('click', async () => {
    const to = prompt('Send test email to: (leave blank to use SCHOOL_EMAIL/MAIL_SENDER)') || undefined;
    try {
      const r = await fetch('/reminders/test_email', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({to})});
      const j = await r.json();
      if (j.ok) alert('Test email sent via: ' + j.via);
      else alert('Test failed: ' + (j.error || 'Unknown error'));
    } catch (e) { alert('Test failed.'); }
  });
</script>
{% endblock %}
