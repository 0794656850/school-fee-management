{% extends "base.html" %}
{% block title %}Add Payment - {{ APP_TITLE }}{% endblock %}
{% block page_title %}Add Payment{% endblock %}
{% block content %}

<div class="max-w-2xl mx-auto bg-white/90 backdrop-blur-md border border-gray-100 rounded-2xl shadow-sm hover:shadow-lg transition p-8">

  <h3 class="text-xl font-semibold text-gray-800 mb-6 flex items-center gap-2">
    <i data-lucide="credit-card" class="text-blue-600"></i> Record New Payment
  </h3>

  <form method="POST" action="{{ url_for('add_payment') }}" class="space-y-6">

    <!-- Student Search -->
    <div>
      <label for="student_search" class="block text-sm font-medium text-gray-700 mb-1">Select Student</label>
      <div class="relative">
        <input type="text" id="student_search" placeholder="Search by name or admission number..."
               class="w-full border border-gray-200 rounded-lg px-3 py-2.5 pl-10 text-sm shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
        <i data-lucide="search" class="absolute left-3 top-2.5 text-gray-400 w-4 h-4"></i>
      </div>
      <input type="hidden" name="student_id" id="student_id">

      <!-- Search Results Dropdown -->
      <div id="search_results" class="hidden absolute w-full mt-1 bg-white/95 backdrop-blur-md border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto z-20 text-sm"></div>
    </div>

    <!-- Amount -->
    <div>
      <label for="amount" class="block text-sm font-medium text-gray-700 mb-1">Amount (KES)</label>
      <input type="number" step="0.01" name="amount" id="amount" required
             class="w-full border border-gray-200 rounded-lg shadow-sm px-3 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
    </div>

    <!-- Method -->
    <div>
      <label for="method" class="block text-sm font-medium text-gray-700 mb-1">Payment Method</label>
      <select name="method" id="method" required
              class="w-full border border-gray-200 rounded-lg shadow-sm px-3 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
        <option value="">-- Select Method --</option>
        <option value="Cash">Cash</option>
        <option value="M-Pesa">M-Pesa</option>
        <option value="Bank">Bank</option>
      </select>
    </div>

    <!-- Reference -->
    <div>
      <label for="reference" class="block text-sm font-medium text-gray-700 mb-1">Reference</label>
      <input type="text" name="reference" id="reference" placeholder="Receipt / M-Pesa code / Bank ref"
             class="w-full border border-gray-200 rounded-lg shadow-sm px-3 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
    </div>

    <!-- Payment Date -->
    <div>
      <label for="payment_date" class="block text-sm font-medium text-gray-700 mb-1">Payment Date</label>
      <input type="date" name="payment_date" id="payment_date"
             class="w-full border border-gray-200 rounded-lg shadow-sm px-3 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
    </div>

    <!-- Action Buttons -->
    <div class="flex justify-end gap-4 pt-2">
      <a href="{{ url_for('dashboard') }}" 
         class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm font-medium rounded-lg transition flex items-center gap-2">
        <i data-lucide="x-circle" class="w-4 h-4"></i> Cancel
      </a>
      <button type="submit" 
              class="px-5 py-2.5 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-700 hover:to-blue-600 text-white text-sm font-medium rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition flex items-center gap-2">
        <i data-lucide="save"></i> Save Payment
      </button>
    </div>
  </form>
</div>

<!-- JavaScript -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  lucide.createIcons();

  const searchInput = document.getElementById("student_search");
  const searchResults = document.getElementById("search_results");
  const studentIdInput = document.getElementById("student_id");

  let searchTimeout = null;

  searchInput.addEventListener("input", () => {
    clearTimeout(searchTimeout);
    const query = searchInput.value.trim();
    if (!query) {
      searchResults.classList.add("hidden");
      return;
    }

    searchTimeout = setTimeout(() => {
      fetch(`/search_student?query=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
          if (data.length === 0) {
            searchResults.innerHTML = "<p class='p-3 text-gray-500'>No students found.</p>";
          } else {
            searchResults.innerHTML = data.map(s => `
              <div class="p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 transition"
                   data-id="${s.id}" data-name="${s.name}">
                <div class="flex justify-between items-center">
                  <p class="font-medium text-gray-800">${s.name}</p>
                  <span class="text-xs px-2 py-0.5 rounded-full ${parseFloat(s.balance) > 0 ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}">
                    Bal: KES ${parseFloat(s.balance).toFixed(2)}
                  </span>
                </div>
                <p class="text-gray-500 text-xs">Adm: ${s.admission_no} â€¢ ${s.class_name}</p>
              </div>
            `).join("");
          }
          searchResults.classList.remove("hidden");
        });
    }, 300);
  });

  searchResults.addEventListener("click", (e) => {
    const item = e.target.closest("[data-id]");
    if (item) {
      searchInput.value = item.dataset.name;
      studentIdInput.value = item.dataset.id;
      searchResults.classList.add("hidden");
    }
  });

  document.addEventListener("click", (e) => {
    if (!searchResults.contains(e.target) && e.target !== searchInput) {
      searchResults.classList.add("hidden");
    }
  });
});
</script>

{% endblock %}
